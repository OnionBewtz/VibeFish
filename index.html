<!DOCTYPE html>
<html>
<head>
<title>Vibes Quest</title>
<link rel="icon" type="image/x-icon" href="ico2.png">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js" integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <script src="https://beta.iframe.chat/scripts/main.min.js"></script>
    <style>
    @font-face {
    font-family: "Aclonica";
    src: url('https://vibequest.neocities.org/Aclonica.ttf');
}

html, body {
    height: fit-content;
    width: 100%;
    margin: 0;
    padding: 0;
    cursor: url('pointer.gif'), auto !important;
}

button, a, input[type="range"], #lock-overlay1, #lock-overlay2, #lock-overlay3, #lock-overlay4, #lock-overlay5, #lock-overlay-chat, #backpack-overlay, #minimanual-overlay, #lock-overlay-river, #lock-overlay-field, #lock-overlay-rockyfield, #lock-overlay-shop {
    cursor: url('hover.gif'), pointer !important;
}

input[type="range"]::-webkit-slider-thumb,
input[type="range"]::-moz-range-thumb,
input[type="range"]::-ms-thumb {
    cursor: url('hover.gif'), pointer !important;
}

.game-container {
    display: grid;
    grid-template-columns: 256px 256px 536px;
    grid-template-rows: 256px 536px 256px;
    gap: 20px;
    padding: 20px;
    height: calc(100% - 40px);
    box-sizing: border-box;
    max-width: 1088px;
    margin: 0 auto;
}

.inventory-module {
    grid-column: 1 / 2;
    grid-row: 1 / 2;
}

.chat-container {
    grid-column: 1 / 2;
    grid-row: 2 / 3;
    width: 256px;
    height: 527px;
    position: relative;
    background-color: white;
}

#chat-panel {
    width: 256px;
    height: 527px;
    position: relative;
    z-index: 2;
    background-color: white;
    box-sizing: border-box;
}

.chat-title-bar {
    width: 100%;
    height: 25px;
    background-color: #239ee0;
    border-bottom: 1px solid #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 5px;
    box-sizing: border-box;
    font-family: Aclonica;
    font-size: 12px;
    color: #fff;
    cursor: url('hover.gif'), pointer !important;
}

.chat-buttons {
    display: flex;
    gap: 5px;
}

#toggle-chat-btn,
#reset-chat-btn {
    width: 17px;
    height: 17px;
    background-color: yellow;
    border: 1px solid #555;
    border-radius: 3px;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: url('hover.gif'), pointer !important;
    transition: background-color 0.2s;
}

#toggle-chat-btn img,
#reset-chat-btn img {
    width: 17px;
    height: 17px;
    display: block;
}

#toggle-chat-btn:hover,
#reset-chat-btn:hover {
    background-color: #d3d3d3;
}

.ui-resizable-handle {
    cursor: url('hover.gif'), pointer !important;
}

#chat-panel iframe {
    width: 100%;
    height: calc(100% - 25px);
    margin: 0;
    padding: 0;
    border: none;
    display: block;
}

.main-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    grid-column: 2 / 3;
    grid-row: 1 / 3;
    width: 256px;
}

#game-display, .stats-controls {
    margin-top:2px;
    width: 256px;
    height: 252px;
    position: relative;
    border: 0px solid black;
}

.side-container {
    display: grid;
    grid-template-columns: 256px 256px;
    grid-template-rows: repeat(3, 256px);
    gap: 20px;
    width: 536px;
    grid-column: 3 / 4;
    grid-row: 1 / 3;
}

#bonus-display1, #bonus-display2, #bonus-display3, #bonus-display4, #bonus-display5, #bonus-display6 {
    width: 256px;
    height: 256px;
    position: relative;
    border: 0px solid black;
}

#bonus-display3 { grid-column: 1 / 2; grid-row: 1 / 2; }
#bonus-display5 { grid-column: 2 / 3; grid-row: 1 / 2; }
#bonus-display1 { grid-column: 1 / 2; grid-row: 2 / 3; }
#bonus-display4 { grid-column: 2 / 3; grid-row: 2 / 3; }
#bonus-display2 { grid-column: 1 / 2; grid-row: 3 / 4; }
#bonus-display6 { grid-column: 2 / 3; grid-row: 3 / 4; }

.new-modules-container {
    display: grid;
    grid-template-columns: repeat(4, 256px);
    grid-template-rows: 256px;
    gap: 20px;
    width: 1088px;
    grid-column: 1 / 4;
    grid-row: 3 / 4;
}

#shop-module, #rockyfield-module, #river-module, #field-module {
    width: 256px;
    height: 256px;
    position: relative;
    border: 0px solid black;
}

#background, #background2, #background3, #background4, #background5, #background6, #background7, #background-river, #background-field, #background-rockyfield, #inventory-background {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
}

#foreground, #foreground2, #foreground4 {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 2;
}

#minimanual-overlay {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 130px;
    left: 60px;
    z-index: 3;
}

#lock-overlay6, #lock-overlay1, #lock-overlay2, #lock-overlay3, 
#lock-overlay4, #lock-overlay5, #lock-overlay-field, 
#lock-overlay-rockyfield, #lock-overlay-shop {
    position: absolute;
    top: 0;
    left: 0;
    width: 256px;
    height: 256px;
    background-color: #fff;
    z-index: 3;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #999;
    font-family: Aclonica;
    font-size: 10px;
    text-align: center;
    transition: opacity 1s, font-size 0.3s ease, color 0.3s ease;
}

#lock-overlay-river {
    position: absolute;
    top: 0;
    left: 0;
    width: 256px;
    height: 256px;
    background-color: #fff;
    z-index: 11;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #999;
    font-family: Aclonica;
    font-size: 10px;
    text-align: center;
    transition: opacity 1s, font-size 0.3s ease, color 0.3s ease;
}
#lock-overlay-chat {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #fff;
    z-index: 10;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #999;
    font-family: Aclonica;
    font-size: 10px;
    text-align: center;
    transition: opacity 1s, font-size 0.3s ease, color 0.3s ease;
    opacity: 1;
    pointer-events: auto;
}

#lock-overlay1:hover, #lock-overlay2:hover, #lock-overlay3:hover, #lock-overlay4:hover, #lock-overlay5:hover, #lock-overlay-chat:hover, #lock-overlay-river:hover, #lock-overlay-field:hover, #lock-overlay-rockyfield:hover {
    color: #444;
    font-size: 12px;
}

#white-overlay6, #white-overlay1, #white-overlay2, #white-overlay3, 
#white-overlay4, #white-overlay5, #white-overlay-field, 
#white-overlay-rockyfield, #white-overlay-shop {
    position: absolute;
    top: 0;
    left: 0;
    width: 256px;
    height: 256px;
    background-color: white;
    z-index: 4;
    transition: opacity 1s;
}

#white-overlay-river {
    position: absolute;
    top: 0;
    left: 0;
    width: 256px;
    height: 256px;
    background-color: white;
    z-index: 12;
    transition: opacity 1s;
}

#white-overlay-chat {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 11;
    transition: opacity 1s;
    opacity: 1;
    pointer-events: auto;
}

#volume-control6, #volume-control-bg, #volume-control1, 
#volume-control2, #volume-control3, #volume-control4, #volume-control5, 
#volume-control-river, #volume-control-field, #volume-control-rockyfield {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    z-index: 2;
    opacity: 0;
    transition: opacity 1s;
}

#game-display:hover #volume-control-bg,
#bonus-display1:hover #volume-control1,
#bonus-display2:hover #volume-control2,
#bonus-display3:hover #volume-control3,
#bonus-display4:hover #volume-control4,
#bonus-display5:hover #volume-control5,
#bonus-display6:hover #volume-control6,
#river-module:hover #volume-control-river,
#field-module:hover #volume-control-field,
#rockyfield-module:hover #volume-control-rockyfield {
    opacity: 1;
}

.stats {
    height: 160px;
    padding: 10px;
    text-align: left;
    font-size: 12px;
    position: relative;
}

.controls {
    width: 100%;
    height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position:ociates relative;
}

button {
    padding: 10px 20px;
    font-size: 18px;
    color: #555;
    transition: background-color 0.2s;
    width: 256px;
    height: 52%;
    margin: 0;
}

.active { background-color: #90EE90; }
.disabled { opacity: 0.5; cursor: not-allowed; }

#skill-slider-container {
    width: 254px;
    height: 10px;
    position: absolute;
	left: 0px;
    top: -16px;
    display: none;
    z-index: 3;
}

#skill-slider {
    width: 100%;
    height: 100%;
    background: linear-gradient(to right,
        red 0%, orange 20%, yellow 35%, green 50%,
        yellow 65%, orange 80%, red 100%);
    border: 1px solid black;
    position: relative;
}

#pointer {
    width: 5px;
    height: 120%;
    background: white;
    position: absolute;
    top: -2px;
    left: 0;
    transition: left 0.016s linear;
}

#welcome-overlay {
    position: absolute;
    top: -15px;
    left: -20px;
    width: 254px;
    height: 254px;
    font-size: 12px;
    background-color: white;
    z-index: 5;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    text-align: center;
    transition: opacity 0.5s ease;
}

#welcome-overlay button {
    font-size: 12px;
    height: 40px;
    width: 120px;
}

.chat-container iframe {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}

#status {
    text-align: center;
    margin: 0;
    position: absolute;
    bottom: 120px;
    left: 150px;
    right: 0;
}

#wipe-progress {
    display: block;
    text-align: center;
    font-size: 10px;
    color: #555;
    text-decoration: underline;
}

#wipe-progress:hover { color: #000; }

#chat-splash-overlay {
    position: absolute;
    top: 25px;
    left: 0;
    width: 100%;
    height: calc(100% - 25px);
    background-color: rgba(255, 255, 255, 1);
    z-index: 3;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
    padding: 10px;
    text-align: center;
    font-size: 12px;
    transition: opacity 0.5s ease;
    opacity: 0;
}

#chat-splash-overlay > div {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

#chat-splash-overlay h2 {
    margin: 10px 0;
    font-size: 14px;
    font-family: Aclonica;
    color: #999;
}

#chat-splash-overlay ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
    text-align: left;
    width: 100%;
    max-width: 200px;
}

#chat-splash-overlay button {
    padding: 5px 10px;
    font-size: 12px;
    width: 80px;
    height: 30px;
    background-color: #fff;
    border: none;
    transition: background-color 0.2s;
}

#chat-splash-overlay button:hover {
    background-color: #999;
    color: white;
}

#backpack-overlay {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 100px;
    left: 80px;
    z-index: 2;
}

#backpack-icon {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#egg-overlay {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 104px;
    left: 115px;
    z-index: 2;
    cursor: url('hover.gif'), pointer !important;
}

#egg-icon {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#crate-overlay {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 104px;
    left: 115px;
    z-index: 2;
    cursor: url('hover.gif'), pointer !important;
}

#crate-icon {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#inventory-module {
    width: 256px;
    height: 256px;
    position: relative;
    border: 0px;
}

#inventory-background {
    width: 100%;
    height: 100%;
}

#inventory-grid {
    position: absolute;
    top: 53%;
    left: 51%;
    transform: translate(-50%, -50%);
    display: grid;
    grid-template-columns: repeat(3, 48px);
    grid-template-rows: repeat(3, 48px);
    gap: 5px;
    z-index: 2;
}

.inventory-slot {
    width: 48px;
    height: 48px;
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid #555;
    border-radius: 5px;
    position: relative;
}

.inventory-item {
    width: 48px;
    height: 48px;
    position: absolute;
    cursor: url('hover.gif'), pointer !important;
    z-index: 3;
}

#inventory-closed {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 3;
    transition: opacity 0.5s ease;
    opacity: 1;
    pointer-events: auto;
}

#inventory-module:hover #inventory-closed {
    opacity: 0;
    pointer-events: none;
}

#close-backpack-btn {
    position: absolute;
    top: 0%;
    left: 4%;
    transform: translateX(-50%);
    width: 16px;
    height: 16px;
    background-color: yellow;
    border: 1px solid #555;
    border-radius: 3px;
    text-align: center;
    line-height: 14px;
    font-size: 12px;
    color: #555;
    cursor: url('hover.gif'), pointer !important;
    z-index: 3;
    transition: background-color 0.2s, color 0.2s;
    display: none;
}

#inventory-module:hover #close-backpack-btn {
    display: block;
}

#active-item-module {
    width: 256px;
    height: 252px;
    position: relative;
    overflow: hidden;
}

#active-item-content {
    width: 100%;
    height: 100%;
    position: relative;
}

#manual-graphic {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    display: none;
}

#manual-textbox {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 160px;
    height: 140px;
    background-color: rgba(255, 255, 255, 0);
    padding: 5px;
    font-size: 11px;
    font-family: Helvetica;
    color: #845128;
    overflow-y: auto;
    z-index: 2;
    display: none;
    scrollbar-width: thin;
    scrollbar-color: #845128 #fbe7cc;
}

#manual-textbox::-webkit-scrollbar {
    width: 4px;
}

#manual-textbox::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#manual-textbox::-webkit-scrollbar-thumb {
    background: #5C4033;
    border-radius: 4px;
}

#manual-textbox::-webkit-scrollbar-thumb:hover {
    background: #4A3327;
}

#close-active-item-btn {
    position: absolute;
    top: 0%;
    left: 4%;
    transform: translateX(-50%);
    width: 16px;
    height: 16px;
    background-color: yellow;
    border: 1px solid #555;
    border-radius: 3px;
    text-align: center;
    line-height: 14px;
    font-size: 12px;
    color: #555;
    cursor: url('hover.gif'), pointer !important;
    z-index: 10;
    transition: background-color 0.2s, color 0.2s;
    display: none;
}

#close-active-item-btn:hover {
    background-color: #d3d3d3;
    color: #333;
}

.tooltip {
    position: absolute;
    background-color: black;
    color: white;
    font-family: Helvetica, sans-serif;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
}

.tooltip.visible {
    opacity: 1;
}

#background-shop {
    position: absolute;
    top: 0;
    left: 0;
    width: 256px;
    height: 256px;
    z-index: 1;
    display: none;
}

#volume-control-shop {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 200px;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s;
    display: none;
}

#shop-module:hover #volume-control-shop {
    opacity: 1;
}

.inventory-item {
    width: 48px;
    height: 48px;
    position: absolute;
    cursor: url('hover.gif'), pointer !important;
    z-index: 3;
}

.stack-count {
    position: absolute !important;
    bottom: 2px !important;
    right: 2px !important;
    width: 14px !important;
    height: 14px !important;
    background-color: yellow !important;
    color: #555 !important;
    font-family: Helvetica, sans-serif !important;
    font-size: 10px !important;
    text-align: center !important;
    line-height: 14px !important;
    border: 1px solid #555 !important;
    border-radius: 3px !important;
    z-index: 4 !important;
    display: none;
}

#river-module .tooltip {
    position: absolute;
    background-color: black;
    color: white;
    font-family: Helvetica, sans-serif;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 10;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    top: 68px;
    left: 50%;
    transform: translateX(-50%);
}

#fish-trap-label {
    position: absolute;
    background: rgba(255,255,255,0.7);
    color: black;
    font-family: Helvetica, sans-serif;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    z-index: 10;
    top: 150px;
    left: 53%;
    transform: translateX(-50%);
    pointer-events: none;
    text-align: center;
}

#fish-trap-progress {
    width: 40px;
    height: 4px;
    background: #4CAF50;
    margin-top: 4px;
    border-radius: 2px;
    overflow: hidden;
    position: relative;
}

#fish-trap-progress-bar {
    height: 100%;
    background: #ccc;
    width: 0%;
    position: absolute;
    right: 0;
    transition: width 0.3s ease;
}

#fish-trap-overlay {
    cursor: url('hover.gif'), pointer !important;
}

#background-shop {
    cursor: url('hover.gif'), pointer !important;
}

#luckycoin-graphic {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
    display: none;
}

#lucky-coin-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    cursor: url('hover.gif'), auto !important;
    z-index: 3;
}

.sparkle {
    position: absolute;
    width: 15px;
    height: 15px;
    background: radial-gradient(circle, rgba(255, 215, 0, 0.8), rgba(255, 215, 0, 0));
    border-radius: 50%;
    pointer-events: none;
    z-index: 10;
    animation: fadeOut 0.5s ease forwards;
}

@keyframes fadeOut {
    0% { opacity: 1; }
    100% { opacity: 0; }
}

#manual-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.manual-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.manual-graphic {
    width: 100%;
    height: 100%;
    z-index: 1;
}

.manual-textbox {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 160px;
    height: 140px;
    background-color: rgba(255, 255, 255, 0);
    padding: 10px; /* Increased from 5px for better spacing */
    font-size: 11px;
    font-family: Helvetica;
    color: #845128;
    overflow-y: auto;
    z-index: 2;
    scrollbar-width: thin;
    scrollbar-color: #845128 #fbe7cc;
}

.manual-nav-btn {
    cursor: url('hover.gif'), pointer !important;
}

.manual-nav-btn:hover {
    background-color: #d3d3d3 !important;
    color: #333 !important;
}

.module-title {
    position: absolute;
    top: 5px;
    right: 5px;
    color: white;
    font-family: Helvetica;
    font-size: 12px;
    font-weight: bold;
    z-index: 2;
    opacity: 0;
    transition: opacity 1s ease;
    pointer-events: none;
}

@keyframes floatUp {
    0% {
        transform: translateY(0);
        opacity: 1;
    }
    100% {
        transform: translateY(-50px);
        opacity: 0;
    }
}

#bonus-display1:hover .module-title,
#bonus-display2:hover .module-title,
#bonus-display3:hover .module-title,
#bonus-display4:hover .module-title,
#bonus-display5:hover .module-title,
#bonus-display6:hover .module-title,
#river-module:hover .module-title,
#field-module:hover .module-title,
#rockyfield-module:hover .module-title,
#shop-module:hover .module-title {
    opacity: 1;
}

#bonus-display1:has(#lock-overlay1:not([style*="display: none"])) .module-title,
#bonus-display2:has(#lock-overlay2:not([style*="display: none"])) .module-title,
#bonus-display3:has(#lock-overlay3:not([style*="display: none"])) .module-title,
#bonus-display4:has(#lock-overlay4:not([style*="display: none"])) .module-title,
#bonus-display5:has(#lock-overlay5:not([style*="display: none"])) .module-title,
#bonus-display6:has(#lock-overlay6:not([style*="display: none"])) .module-title,
#river-module:has(#lock-overlay-river:not([style*="display: none"])) .module-title,
#field-module:has(#lock-overlay-field:not([style*="display: none"])) .module-title,
#rockyfield-module:has(#lock-overlay-rockyfield:not([style*="display: none"])) .module-title,
#shop-module:has(#lock-overlay-shop:not([style*="display: none"])) .module-title {
    opacity: 0 !important;
}

#compendium-overlay {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 139px;
    left: 204px;
    z-index: 2;
    cursor: url('hover.gif'), pointer !important;
}

#compendium-icon {
    position: absolute;
    width: 40px;
    height: 40px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

#fishcompendium-overlay {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    z-index: 1;
    display: none;
}

#compendium-content {
    position: absolute;
    top: 100;
    left: 0;
    width: 256px;
    height: 252px;
    z-index: 3;
    display: none;
}

.fish-entry {
    position: absolute;
    top: 0;
    left: 0;
    width: 256px;
    height: 252px;
    display: none;
}

.fish-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    z-index: 1;
}

.fish-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    z-index: 2;
    display: none;
}

.fish-title {
    position: absolute;
    top: 10px;
    left: 10px;
    font-family: Helvetica;
    font-size: 12px;
    color: white;
    text-shadow: 1px 1px 2px black;
    z-index: 3;
}

#compendium-list {
    top: 50px;
    scrollbar-width: thin;
    scrollbar-color: #845128 #fbe7cc;
}

#compendium-list::-webkit-scrollbar {
    width: 4px;
}

#compendium-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#compendium-list::-webkit-scrollbar-thumb {
    background: #5C4033;
    border-radius: 4px;
}

#compendium-list::-webkit-scrollbar-thumb:hover {
    background: #4A3327;
}

.compendium-category {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    position: relative;
}

.compendium-btn {
    width: 140px;
    height: 30px;
    font-size: 12px;
    color: #555;
    background-color: #fff;
    border: 1px solid #555;
    border-radius: 3px;
    text-align: left;
    padding-left: 5px;
    cursor: url('hover.gif'), pointer !important;
    transition: background-color 0.2s;
}

.compendium-btn:hover {
    background-color: #d3d3d3;
}

.lock-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-family: 'Aclonica', sans-serif;
    font-size: 10px;
    text-align: center;
    line-height: 20px;
    pointer-events: auto;
    transition: background 0.3s ease;
}

.lock-overlay.enough-fish {
    background: rgba(0, 128, 0, 0.7);
}

.lock-overlay:hover {
    cursor: url('hover.gif'), auto;
}

.lock-overlay-button {
    width: 162px;
    height: 35px;
    left: 2px;
    top: -3px;
}

input[type="checkbox"] {
    margin-right: 4px;
    width: 16px;
    height: 16px;
}

#active-item-module.active #close-active-item-btn {
    display: block;
}

#fishcompendium-overlay {
    display: none;
}

#fish-detail-overlay {
    z-index: 5;
}

#fish-detail-unlocked-overlay {
    z-index: 6;
}

#fish-detail-title,
#exit-fish-detail-btn,
#next-fish-detail-btn {
    z-index: 8 !important;
}

#online-users-overlay {
    position: absolute;
    top: 25px;
    left: 0;
    width: 100%;
    height: calc(100% - 25px);
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 10;
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    box-sizing: border-box;
    font-family: Aclonica, sans-serif;
    color: #555;
}

#online-users-overlay h2 {
    font-size: 14px;
    margin: 10px 0;
    color: #999;
}

#online-users-list {
    list-style: none;
    padding: 0;
    margin: 10px 0;
    width: 100%;
    max-width: 200px;
    max-height: 70%;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #845128 #fbe7cc;
}

#online-users-list::-webkit-scrollbar {
    width: 4px;
}

#online-users-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#online-users-list::-webkit-scrollbar-thumb {
    background: #5C4033;
    border-radius: 4px;
}

#online-users-list li {
    font-size: 12px;
    padding: 5px;
    border-bottom: 1px solid #ddd;
}

#exit-online-users-btn {
    padding: 5px 10px;
    font-size: 12px;
    width: 80px;
    height: 30px;
    background-color: #fff;
    border: 1px solid #555;
    border-radius: 3px;
    color: #555;
    cursor: url('hover.gif'), pointer !important;
    transition: background-color 0.2s;
}

#exit-online-users-btn:hover {
    background-color: #d3d3d3;
    color: #333;
}

/* Dark Mode Styles */
body.dark-mode {
    background-color: #021d2b !important;

  background-repeat: repeat;
}


/* White Overlays */
body.dark-mode #white-overlay1,
body.dark-mode #white-overlay2,
body.dark-mode #white-overlay3,
body.dark-mode #white-overlay4,
body.dark-mode #white-overlay5,
body.dark-mode #white-overlay6,
body.dark-mode #white-overlay-chat,
body.dark-mode #white-overlay-river,
body.dark-mode #white-overlay-field,
body.dark-mode #white-overlay-rockyfield,
body.dark-mode #white-overlay-shop,
body.dark-mode #white-overlay-inventory {
    background-color: #021d2b !important;
    opacity: 1 !important;
}

/* Lock Overlays */
body.dark-mode #lock-overlay1,
body.dark-mode #lock-overlay2,
body.dark-mode #lock-overlay3,
body.dark-mode #lock-overlay4,
body.dark-mode #lock-overlay5,
body.dark-mode #lock-overlay6,
body.dark-mode #lock-overlay-chat,
body.dark-mode #lock-overlay-river,
body.dark-mode #lock-overlay-field,
body.dark-mode #lock-overlay-rockyfield,
body.dark-mode #lock-overlay-shop {
    background-color: #021d2b !important;
    color: #fff !important;
    opacity: 1 !important;
}

body.dark-mode #lock-overlay1:hover,
body.dark-mode #lock-overlay2:hover,
body.dark-mode #lock-overlay3:hover,
body.dark-mode #lock-overlay4:hover,
body.dark-mode #lock-overlay5:hover,
body.dark-mode #lock-overlay6:hover,
body.dark-mode #lock-overlay-chat:hover,
body.dark-mode #lock-overlay-river:hover,
body.dark-mode #lock-overlay-field:hover,
body.dark-mode #lock-overlay-rockyfield:hover,
body.dark-mode #lock-overlay-shop:hover {
    color: #ccc !important;
    font-size: 12px;
}

/* Stats and Controls Module */
body.dark-mode .stats-controls {
    color: #fff !important;
}

body.dark-mode .stats {
    color: #fff !important;
}



body.dark-mode .stats p,
body.dark-mode .stats span,
body.dark-mode .stats b,
body.dark-mode .stats i {
    color: #fff !important;
}

body.dark-mode .controls button {
    background-color: rgba(0,0,0,0.75) !important;
    color: #fff !important;
    border: 1px solid #555 !important;
}

body.dark-mode .controls button:hover {
    background-color: rgba(0,0,0,0.3) !important;
}

body.dark-mode .controls button.active {
    background-color: #90EE90 !important;
    color: #000 !important;
}

body.dark-mode .controls button.disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}

/* Ensure chat panel and other white backgrounds remain white unless specified */
body.dark-mode .chat-container,
body.dark-mode #chat-panel,
body.dark-mode #welcome-overlay,
body.dark-mode #manual-textbox,
body.dark-mode #online-users-overlay {
    background-color: #03273a !important;
    color: #555 !important;
}

body.dark-mode .compendium-btn {
    background-color: #888;
    color: #000;
    }

body.dark-mode #chat-splash-overlay {
    color: #fff;
}
/* Adjust tooltip for visibility */
body.dark-mode .tooltip {
    background-color: #333 !important;
    color: #fff !important;
}

/* Dark Mode Toggle Button */
#dark-mode-toggle {
    width: 60px;
    height: 20px;
    font-size: 12px;
    color: #555;
    background-color: yellow;
    border: 1px solid #555;
    border-radius: 3px;
    text-align: center;
    line-height: 12px;
    padding: 0;
    margin: 0 auto;
    display: block;
    cursor: url('hover.gif'), pointer !important;
    transition: background-color 0.2s, color 0.2s;
}

#dark-mode-toggle:hover {
    background-color: #d3d3d3;
    color: #333;
}

body.dark-mode #dark-mode-toggle {
    background-color: #333 !important;
    color: #fff !important;
}

body.dark-mode #dark-mode-toggle:hover {
    background-color: #555 !important;
    color: #ccc !important;
}

.focus-toggle-container {
    position: absolute;
    top: 140px;
    right: 90px;
    z-index: 5;
    display: flex;
    align-items: center;
    font-family: Helvetica;
    font-size: 12px;
    color: #000;
}

.focus-label {
    margin-left: 8px;
    cursor: url('hover.gif'), pointer !important;
}

.switch-label {
    position: relative;
    display: inline-block;
    width: 32px;
    height: 16px;
    cursor: url('hover.gif'), pointer !important;
}

.switch-label input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    border-radius: 16px;
    transition: background-color 0.3s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 12px;
    width: 12px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.3s;
}

.switch-label input:checked + .slider {
    background-color: #2196F3; /* Blue when on */
}

.switch-label input:checked + .slider:before {
    transform: translateX(16px); /* Slide right when checked */
}

body.dark-mode .focus-toggle-container {
    color: #fff !important;
}

body.dark-mode .focus-label {
    color: #fff !important;
}

body.dark-mode .slider {
    background-color: #666 !important;
}

body.dark-mode .switch-label input:checked + .slider {
    background-color: #4CAF50 !important; /* Green when on in dark mode */
}

#magazine-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: none;
}

.magazine-page {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.magazine-page img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
    </style>
</head>

<body>
    <div class="game-container">
        <!-- Inventory Module -->
        <div class="inventory-module" id="inventory-module">
            <img id="inventory-background" src="bp-open.gif" alt="Inventory Background">
            <div id="inventory-grid">
                <div class="inventory-slot" data-row="0" data-col="0">
                    <img id="manual-item" class="inventory-item" src="manual.png" alt="Manual" draggable="true">
                </div>
                <div class="inventory-slot" data-row="0" data-col="1"></div>
                <div class="inventory-slot" data-row="0" data-col="2"></div>
                <div class="inventory-slot" data-row="1" data-col="0"></div>
                <div class="inventory-slot" data-row="1" data-col="1"></div>
                <div class="inventory-slot" data-row="1" data-col="2"></div>
                <div class="inventory-slot" data-row="2" data-col="0"></div>
                <div class="inventory-slot" data-row="2" data-col="1"></div>
                <div class="inventory-slot" data-row="2" data-col="2"></div>
            </div>
            <img id="inventory-closed" src="bp-closed.gif" alt="Inventory Closed">
            <div id="close-backpack-btn"></div>
            <div id="white-overlay-inventory"></div>
        </div>
                <!-- Chat Module -->
<div class="chat-container">

        <div class="chat-module" id="chat-module">
            <div id="chat-panel">
                <div class="chat-title-bar">
                    <span>Fishchat</span>
                    <div class="chat-buttons">
                        <button id="toggle-chat-btn" title="Sail Chat Around">
                            <img src="https://vibequest.neocities.org/sail.gif" alt="Toggle Move/Resize" width="16" height="16" id="toggle-img">
                        </button>
                        <button id="reset-chat-btn" title="Anchor Chat Down">
                            <img src="https://vibequest.neocities.org/anchor-active.gif" alt="Reset Position/Size" width="16" height="16" id="reset-img">
                        </button>
                    </div>
                </div>
                <iframe src="https://beta.iframe.chat/embed/alternate?chat=37515919" id="chattable" frameborder="none"></iframe>
                <div id="chat-splash-overlay">
                    <div>
                        <br><br><br>
                        <h2 style="font-family: Aclonica; font-size: 14px; color: #999; margin-bottom:-10px;">Chatroom Module</h2>
                        <center>
                            <p><b>I agree to:</b></p>
                            <ul>
                                <li>&nbsp;&nbsp;&rarr; Be respectful.</li>
                                <li>&nbsp;&nbsp;&rarr; Not spam or flood the chat.</li>
                                <li>&nbsp;&nbsp;&rarr; Refrain from NSFW content.</li>
                            </ul>
                            <p><center><button id="join-chat-btn">I agree!</button></center></p>
                        </center>
                    </div>
                </div>
                <div id="online-users-overlay" style="display: none;">
                    <h2>Online Users</h2>
                    <ul id="online-users-list"></ul>
                    <button id="exit-online-users-btn">Close</button>
                </div>
                <div id="lock-overlay-chat"><b>Unlock the Chat<br>Cost: 2 fish</b></div>
                <div id="white-overlay-chat"></div>
            </div>
        </div>
</div>
        <!-- Main Game Container -->
        <div class="main-container">
            <div id="active-item-module">
                <div id="active-item-content">
                
                    <div id="manual-container" style="display: none;">
                        <div id="manual-page-1" class="manual-page">
                            <img src="manual.gif" alt="Manual Page 1" class="manual-graphic">
                            <div class="manual-textbox">...</div>
                        </div>
                        <div id="manual-page-2" class="manual-page" style="display: none;">
                            <img src="manual2.gif" alt="Manual Page 2" class="manual-graphic">
                            <div class="manual-textbox">Content for page 2 goes here...</div>
                        </div>
                        <div id="manual-page-3" class="manual-page" style="display: none;">
                            <img src="manual3.gif" alt="Manual Page 3" class="manual-graphic">
                            <div class="manual-textbox">Content for page 3 goes here...</div>
                        </div>
                        <button id="prev-page-btn" style="display: none;"><</button>
                        <button id="next-page-btn" style="display: none;">></button>
                    </div>
                    <div id="fishcompendium-overlay" style="display: none;">
                        <img id="compendium-bg" src="compendiumbg.gif" alt="Fish Compendium Background" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;">
                        <div id="compendium-list" style="position: absolute; top: 60px; left: 40px; width: 165px; height: 130px; overflow-y: auto; z-index: 2;">
                            <div class="compendium-category">
                                <input type="checkbox" id="lake-fish-1" name="fish-category">
                                <button class="compendium-btn">Lake Fish</button>
                                <div id="lock-overlay-lake1" class="lock-overlay">Unlock for 200 Fish</div>
                            </div>
                            <div class="compendium-category">
                                <input type="checkbox" id="river-fish-1" name="fish-category">
                                <button class="compendium-btn">Coming.. someday?</button>
                                <div class="lock-overlay lock-overlay-button" data-target="river-fish-1">
                                    <span>Locked</span>
                                </div>
                            </div>
                            <div class="compendium-category">
                                <input type="checkbox" id="sea-fish-1" name="fish-category">
                                <button class="compendium-btn">? ? ?</button>
                                <div class="lock-overlay lock-overlay-button" data-target="sea-fish-1">
                                    <span>Locked</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="fish-detail-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3;">
                        <img id="fish-detail-background" src="/fish/bg1.gif" alt="Fish Background" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 1;">
                        <div id="fish-detail-title" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: white; z-index: 2;"></div>
                        <div id="channel-catfish-extra-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/fish/bg1unlocked.gif'); background-size: cover; z-index: 4;"></div>
                        <div id="bluegill-extra-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/fish/bg2unlocked.gif'); background-size: cover; z-index: 4;"></div>
                        <div id="bass-extra-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/fish/bg3unlocked.gif'); background-size: cover; z-index: 4;"></div>
                        <div id="black-crappie-extra-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/fish/bg4unlocked.gif'); background-size: cover; z-index: 4;"></div>
                        <div id="perch-extra-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/fish/bg5unlocked.gif'); background-size: cover; z-index: 4;"></div>
                        <div id="trout-extra-overlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('/fish/bg6unlocked.gif'); background-size: cover; z-index: 4;"></div>
                        <button id="next-fish-btn" style="position: absolute; bottom: 10px; right: 10px; z-index: 5;">Next</button>
                    </div>
                    <img id="luckycoin-graphic" src="luckycoin.gif" alt="Lucky Coin Graphic">
                    <div id="close-active-item-btn">x</div>
                </div>
            </div>
            <div id="game-display">
                <img id="background" src="background.gif" alt="Background">
                <img id="foreground" src="idlenotfishing2.gif" alt="Foreground">
                <input type="range" id="volume-control-bg" min="0" max="1" step="0.01" value="1">
            </div>
            <div class="stats-controls">
                <div class="stats">
                    <p id="status"></p>
                    <p><b>Fish Balance:</b> <b><span id="fishCount">0</span></b></p>
                    <p>Total Caught: <span id="totalCaught">0</span><br></p>
                    <hr>
                    <p><center>Current Streak: <b><span id="streak">0</span></b>&nbsp;/&nbsp; Best Streak: <span id="bestStreak">0</span></center></p>
                    <p><center>Last Catch: <i><span id="timer">keep m 0 s</span></i></center></p>
                </div>
                <div class="focus-toggle-container">
                  <span class="focus-label">Focus:</span>&nbsp;
                 <label class="switch-label" for="focus-toggle">
                <input type="checkbox" id="focus-toggle">
                <span class="slider"></span>
               </label>          
              </div>
                <div class="controls">
                    <button id="castBtn">Cast</button>
                    <button id="reelBtn" style="display: none;">Reel In</button>
                    <button id="takeFishBtn" style="display: none;">Take Fish</button>
                    <div id="skill-slider-container">
                        <div id="skill-slider">
                            <div id="pointer"></div>
                        </div>
                        <input type="range" min="0" max="100" value="50" id="skillRange" style="display: none;">
                    </div>
                </div>
                <div id="welcome-overlay">
					<div id="welcome-text">
						<!-- Dynamic text will be injected here by JavaScript -->
					</div>
					<button id="startBtn">Let's Go</button>
				</div>
            </div>
        </div>

        <!-- Side Modules -->
        <div class="side-container">
            <div id="bonus-display3">
                <img id="background4" src="background4.gif" alt="Bonus Background 3">
                <div id="lock-overlay3"><b>Unlock Cost: 2 fish</b></div>
                <div id="white-overlay3"></div>
                <div class="module-title">Sunshine Windchimes</div>
                <input type="range" id="volume-control3" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="bonus-display5">
                <img id="background6" src="eagle.gif" alt="Bonus Background 5">
                <div id="egg-overlay">
                    <img id="egg-icon" src="egg.gif" alt="Egg" width="40px" height="40px">
                </div>
                <div id="lock-overlay5"><b>Unlock Cost: 3 fish</b></div>
                <div id="white-overlay5"></div>
                <div class="module-title">Treetop Chirping</div>
                <input type="range" id="volume-control5" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="bonus-display1">
                <img id="background2" src="background2.gif" alt="Bonus Background 1">
                <div id="backpack-overlay">
                    <img id="backpack-icon" src="bpmini.gif" alt="Backpack" width="40px" height="40px">
                </div>
                <div id="minimanual-overlay">
                    <img id="minimanual-icon" src="minimanual.gif" alt="Mini Manual" width="40" height="40">
                </div>
                <div id="lock-overlay1"><b>Unlock Cost: 2 fish</b></div>
                <div id="white-overlay1"></div>
                <div class="module-title">Cozy Campfire</div>
                <input type="range" id="volume-control1" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="bonus-display4">
                <img id="background5" src="woods1.gif" alt="Bonus Background 4">
                <img id="foreground4" src="butterfly.gif" alt="Foreground 4" width="256" height="256">
                <div id="compendium-overlay">
                    <img id="compendium-icon" src="compmini.gif" alt="Fish Compendium" width="40" height="40">
                </div>
                <div id="lock-overlay4"><b>Unlock Cost: 3 fish</b></div>
                <div id="white-overlay4"></div>
                <div class="module-title">Woodland Crickets</div>
                <input type="range" id="volume-control4" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="bonus-display2">
                <img id="background3" src="background3.gif" alt="Bonus Background 2">
                <img id="foreground2" src="idleswim.gif" alt="Foreground 2" style="display: none;">
                <div id="lock-overlay2"><b>Unlock Cost: 3 fish</b></div>
                <div id="white-overlay2"></div>
                <div class="module-title">Subsurface Bubbles</div>
                <input type="range" id="volume-control2" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="bonus-display6">
                <img id="background7" src="beach.gif" alt="Beach Background">
                <div id="crate-overlay">
                    <img id="crate-icon" src="crate.gif" alt="Crate" width="40px" height="40px">
                </div>
                <div id="lock-overlay6"><b>Unlock Cost: 4 fish</b></div>
                <div id="white-overlay6"></div>
                <div class="module-title">Calming Waves</div>
                <input type="range" id="volume-control6" min="0" max="1" step="0.01" value="1">
            </div>
        </div>

        <!-- New Modules -->
        <div class="new-modules-container">
            <div id="shop-module">
                <img id="background-shop" src="shop2.gif" alt="Shop Background" style="display: none;">
                <div id="lock-overlay-shop"><b>Unlock Cost: 5 fish</b></div>
                <div id="white-overlay-shop"></div>
                <div class="module-title">Market Ambience (Double-Click)</div>
                <input type="range" id="volume-control-shop" min="0" max="1" step="0.01" value="1" style="display: none;">
            </div>
            <div id="rockyfield-module">
                <img id="background-rockyfield" src="rockyfield2.gif" alt="Rocky Field Background">
                <div id="lock-overlay-rockyfield"><b>Unlock Cost: 6 fish</b></div>
                <div id="white-overlay-rockyfield"></div>
                <div class="module-title">Rocky Field Crows</div>
                <input type="range" id="volume-control-rockyfield" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="river-module">
                <img id="background-river" src="river.gif" alt="River Background">
                <div id="lock-overlay-river"><b>Unlock Cost: 4 fish</b></div>
                <div id="white-overlay-river"></div>
                <div class="module-title">River Current</div>
                <input type="range" id="volume-control-river" min="0" max="1" step="0.01" value="1">
            </div>
            <div id="field-module">
                <img id="background-field" src="field.gif" alt="Field Background">
                <div id="lock-overlay-field"><b>Unlock Cost: 4 fish</b></div>
                <div id="white-overlay-field"></div>
                <div class="module-title">Summer Cicadas</div>
                <input type="range" id="volume-control-field" min="0" max="1" step="0.01" value="1">
            </div>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="backgroundMusic" src="background.mp3" loop></audio>
    <audio id="alertSound" src="alert.mp3" loop></audio>
    <audio id="castSound" src="cast.mp3"></audio>
    <audio id="reelSound" src="reel-in.mp3"></audio>
    <audio id="plusOneSound" src="plusone.mp3"></audio>
    <audio id="fireSound" src="fire.mp3" loop></audio>
    <audio id="level1Sound" src="level1.mp3"></audio>
    <audio id="underwaterSound" src="underwater.mp3" loop></audio>
    <audio id="level2Sound" src="level2.mp3"></audio>
    <audio id="windSound" src="wind.mp3" loop></audio>
    <audio id="level3Sound" src="level3.mp3"></audio>
    <audio id="cricketSound" src="cricket.mp3" loop></audio>
    <audio id="level5Sound" src="level5.mp3"></audio>
    <audio id="welcomeSound" src="welcome.mp3"></audio>
    <audio id="eagleSound" src="eagle.mp3" loop></audio>
    <audio id="beachSound" src="beach.mp3" loop></audio>
    <audio id="collectedSound" src="collected.mp3"></audio>
    <audio id="level4Sound" src="level4.mp3"></audio>
    <audio id="pageTurnSound" src="pageturn.mp3"></audio>
    <audio id="rockyfieldSound" src="rockyfield.mp3" loop></audio>
    <audio id="riverSound" src="river.mp3" loop></audio>
    <audio id="fieldSound" src="field.mp3" loop></audio>
    <audio id="shopSound" src="shopping.mp3" loop></audio>
    <audio id="chainSnapSound" src="chainsnap.mp3"></audio>
    <audio id="chainsSound" src="chains.mp3"></audio>
    <audio id="saleSound" src="sale.mp3"></audio>
    <audio id="coinSound" src="coin.mp3"></audio>
    <audio id="shopEntrySound" src="storeentry.mp3"></audio>
    <audio id="mysterySound" src="mystery.mp3"></audio>
    <audio id="eagle2Sound" src="eagle2.mp3"></audio>
</body>

<script>


// DOM Elements
const castBtn = document.getElementById('castBtn');
const reelBtn = document.getElementById('reelBtn');
const takeFishBtn = document.getElementById('takeFishBtn');
const foreground = document.getElementById('foreground');
const foreground2 = document.getElementById('foreground2');
const foreground4 = document.getElementById('foreground4');
const fishCountDisplay = document.getElementById('fishCount');
const totalCaughtDisplay = document.getElementById('totalCaught');
const streakDisplay = document.getElementById('streak');
const bestStreakDisplay = document.getElementById('bestStreak');
const timerDisplay = document.getElementById('timer');
const statusDisplay = document.getElementById('status');
const lockOverlay1 = document.getElementById('lock-overlay1');
const lockOverlay2 = document.getElementById('lock-overlay2');
const lockOverlay3 = document.getElementById('lock-overlay3');
const lockOverlay4 = document.getElementById('lock-overlay4');
const lockOverlay5 = document.getElementById('lock-overlay5');
const lockOverlay6 = document.getElementById('lock-overlay6');
const lockOverlayChat = document.getElementById('lock-overlay-chat');
const lockOverlayRiver = document.getElementById('lock-overlay-river');
const lockOverlayField = document.getElementById('lock-overlay-field');
const lockOverlayRockyfield = document.getElementById('lock-overlay-rockyfield');
const lockOverlayShop = document.getElementById('lock-overlay-shop');
const whiteOverlay1 = document.getElementById('white-overlay1');
const whiteOverlay2 = document.getElementById('white-overlay2');
const whiteOverlay3 = document.getElementById('white-overlay3');
const whiteOverlay4 = document.getElementById('white-overlay4');
const whiteOverlay5 = document.getElementById('white-overlay5');
const whiteOverlay6 = document.getElementById('white-overlay6');
const whiteOverlayChat = document.getElementById('white-overlay-chat');
const whiteOverlayRiver = document.getElementById('white-overlay-river');
const whiteOverlayField = document.getElementById('white-overlay-field');
const whiteOverlayRockyfield = document.getElementById('white-overlay-rockyfield');
const whiteOverlayShop = document.getElementById('white-overlay-shop');
const whiteOverlayInventory = document.getElementById('white-overlay-inventory');
const volumeControlBg = document.getElementById('volume-control-bg');
const volumeControl1 = document.getElementById('volume-control1');
const volumeControl2 = document.getElementById('volume-control2');
const volumeControl3 = document.getElementById('volume-control3');
const volumeControl4 = document.getElementById('volume-control4');
const volumeControl5 = document.getElementById('volume-control5');
const volumeControl6 = document.getElementById('volume-control6');
const volumeControlRiver = document.getElementById('volume-control-river');
const volumeControlField = document.getElementById('volume-control-field');
const volumeControlRockyfield = document.getElementById('volume-control-rockyfield');
const volumeControlShop = document.getElementById('volume-control-shop');
const skillSliderContainer = document.getElementById('skill-slider-container');
const pointer = document.getElementById('pointer');
const welcomeOverlay = document.getElementById('welcome-overlay');
const startBtn = document.getElementById('startBtn');
const chatSplashOverlay = document.getElementById('chat-splash-overlay');
const joinChatBtn = document.getElementById('join-chat-btn');
const backpackOverlay = document.getElementById('backpack-overlay');
const backpackIcon = document.getElementById('backpack-icon');
const eggOverlay = document.getElementById('egg-overlay');
const eggIcon = document.getElementById('egg-icon');
const crateOverlay = document.getElementById('crate-overlay');
const crateIcon = document.getElementById('crate-icon');
const minimanualOverlay = document.getElementById('minimanual-overlay');
const inventoryModule = document.getElementById('inventory-module');
const inventoryGrid = document.getElementById('inventory-grid');
const manualItem = document.getElementById('manual-item');
const closeBackpackBtn = document.getElementById('close-backpack-btn');
const activeItemModule = document.getElementById('active-item-module');
const activeItemContent = document.getElementById('active-item-content');
const backgroundShop = document.getElementById('background-shop');
const shopModule = document.getElementById('shop-module');
const riverModule = document.getElementById('river-module');
const luckycoinGraphic = document.getElementById('luckycoin-graphic');
const compendiumOverlay = document.getElementById('compendium-overlay');
const compendiumIcon = document.getElementById('compendium-icon');
const fishcompendiumOverlay = document.getElementById('fishcompendium-overlay');
const lockOverlayLake1 = document.getElementById('lock-overlay-lake1');
const lakeFish1Checkbox = document.getElementById('lake-fish-1');
const compendiumBtn = document.querySelector('#compendium-list .compendium-btn');
const channelCatfishOverlay = document.getElementById('channel-catfish-extra-overlay');
const darkModeToggle = document.getElementById('dark-mode-toggle');

const backgroundMusic = document.getElementById('backgroundMusic');
const alertSound = document.getElementById('alertSound');
const castSound = document.getElementById('castSound');
const reelSound = document.getElementById('reelSound');
const plusOneSound = document.getElementById('plusOneSound');
const fireSound = document.getElementById('fireSound');
const level1Sound = document.getElementById('level1Sound');
const underwaterSound = document.getElementById('underwaterSound');
const level2Sound = document.getElementById('level2Sound');
const windSound = document.getElementById('windSound');
const level3Sound = document.getElementById('level3Sound');
const cricketSound = document.getElementById('cricketSound');
const woods1Sound = document.getElementById('woods1Sound');
const level5Sound = document.getElementById('level5Sound');
const welcomeSound = document.getElementById('welcomeSound');
const eagleSound = document.getElementById('eagleSound');
const beachSound = document.getElementById('beachSound');
const collectedSound = document.getElementById('collectedSound');
const level4Sound = document.getElementById('level4Sound');
const pageTurnSound = document.getElementById('pageTurnSound');
const rockyfieldSound = document.getElementById('rockyfieldSound');
const riverSound = document.getElementById('riverSound');
const fieldSound = document.getElementById('fieldSound');
const shopSound = document.getElementById('shopSound');
const chainSnapSound = document.getElementById('chainSnapSound');
const chainsSound = document.getElementById('chainsSound');
const saleSound = document.getElementById('saleSound');
const coinSound = document.getElementById('coinSound');
const shopEntrySound = document.getElementById('shopEntrySound');
const mysterySound = document.getElementById('mysterySound');
const eagle2Sound = document.getElementById('eagle2Sound');
const compendiumSound = document.getElementById('compendiumSound');

closeBackpackBtn.textContent = 'x';

// Preload Sounds
function preloadSounds() {
    const soundFiles = [
        'background.mp3', 'alert.mp3', 'cast.mp3', 'reel-in.mp3', 'plusone.mp3',
        'fire.mp3', 'level1.mp3', 'underwater.mp3', 'level2.mp3', 'wind.mp3',
        'level3.mp3', 'cricket.mp3', 'level5.mp3', 'welcome.mp3',
        'eagle.mp3', 'beach.mp3', 'collected.mp3', 'level4.mp3', 'pageturn.mp3',
        'rockyfield.mp3', 'river.mp3', 'field.mp3', 'shopping.mp3', 'chainsnap.mp3',
        'chains.mp3', 'sale.mp3', 'coin.mp3', 'storeentry.mp3', 'mystery.mp3', 'eagle2.mp3', 'compendium.mp3', 'press.mp3', 'petstart.mp3'
    ];
    soundFiles.forEach(file => {
        const audio = new Audio();
        audio.src = file;
        audio.preload = 'auto';
        audio.load();
        console.log(`Preloading sound: ${file}`);
    });
}
preloadSounds();


// Preload Images
function preloadImages() {
    const imageFiles = [
        'minimanual.gif',
        'bp-closed.gif',
        'bpmini.gif',
        'bptrap.gif',
        'cast2.gif',
        'bobbing2.gif',
        'fishbiting2.gif',
        'reel-in-fish2.gif',
        'reel-in-nothing2.gif',
        'mbait.gif',
        'manual.gif',
        'fishhave2.gif',
        'idleswim.gif',
        'fishswim.gif',
        'caught2.gif',
        'manual.png',
        'fishtrap.png',
        'luckycoin.png',
        'mysterybait.png',
        'coinshop.gif',
        'MysteryShop.gif',
        'trap_shop.gif',
        'shop-welcome.gif',
        'egg.gif',
        'babyblob.gif',
        'babyblobhappy.gif',
        'babyblobexcited.gif',
        'babyblobsleeping.gif',
        'babyblobtired.gif',
        'babyblobdying.gif',
        'babyblobdigging.gif',
        'babyblobfetch.gif',
        'fullheart.gif',
        'halfheart.gif',
        'heartempty.gif',
        'happyfull.gif',
        'happyhalf.gif',
        'happyempty.gif',
        'feedmeal.gif',
        'playfetch.gif',
        'minipet.gif',
        'petshop.gif'
    ];
    imageFiles.forEach(file => {
        const img = new Image();
        img.src = file;
        console.log(`Preloading image: ${file}`);
    });
}


preloadImages();


// Game State
let fishCount = 0;
let totalCaught = 0;
let isFishing = false;
let biteTimer = null;
let isFishBiting = false;
let streak = 0;
let bestStreak = 0;
let lastCatchTime = Date.now();
let timerInterval = null;
let canCast = true;
let pendingFish = 0;
let isBonus1Unlocked = localStorage.getItem('isBonus1Unlocked') === 'true' || false;
let isBonus2Unlocked = localStorage.getItem('isBonus2Unlocked') === 'true' || false;
let isBonus3Unlocked = localStorage.getItem('isBonus3Unlocked') === 'true' || false;
let isBonus4Unlocked = localStorage.getItem('isBonus4Unlocked') === 'true' || false;
let isBonus5Unlocked = localStorage.getItem('isBonus5Unlocked') === 'true' || false;
let isBonus6Unlocked = localStorage.getItem('isBonus6Unlocked') === 'true' || false;
let isChatUnlocked = localStorage.getItem('isChatUnlocked') === 'true' || false;
let isRiverUnlocked = localStorage.getItem('isRiverUnlocked') === 'true' || false;
let isFieldUnlocked = localStorage.getItem('isFieldUnlocked') === 'true' || false;
let isRockyfieldUnlocked = localStorage.getItem('isRockyfieldUnlocked') === 'true' || false;
let isShopUnlocked = localStorage.getItem('isShopUnlocked') === 'true' || false;
let pointerPosition = 0;
let pointerVelocity = 0;
let pointerInterval = null;
let isBonus1Visible = false;
let isBackpackCollected = localStorage.getItem('isBackpackCollected') === 'true' || false;
let isManualCollected = localStorage.getItem('isManualCollected') === 'true' || false;
let isCompendiumCollected = localStorage.getItem('isCompendiumCollected') === 'true' || false;
let compendiumSlot = JSON.parse(localStorage.getItem('compendiumSlot')) || null;
let fishTrapCountInInventory = parseInt(localStorage.getItem('fishTrapCountInInventory')) || 0;
let fishTrapSlot = JSON.parse(localStorage.getItem('fishTrapSlot')) || null;
let manualSlot = JSON.parse(localStorage.getItem('manualSlot')) || {row: 0, col: 0};
let isFishTrapDeployed = localStorage.getItem('isFishTrapDeployed') === 'true' || false;
let fishTrapUncollectedFish = parseInt(localStorage.getItem('fishTrapUncollectedFish')) || 0;
let fishTrapTotalCaught = parseInt(localStorage.getItem('fishTrapTotalCaught')) || 0;
let fishTrapBreakPoint = parseInt(localStorage.getItem('fishTrapBreakPoint')) || Math.floor(Math.random() * (800 - 400 + 1)) + 400;
let fishTrapOverlay = null;
let fishTrapInterval = null;
let isCoinShopPurchased = localStorage.getItem('isCoinShopPurchased') === 'true' || false;
let coinSlot = JSON.parse(localStorage.getItem('coinSlot')) || null;
let isLuckyCoinActive = false;
let luckyCoinOverlay = null;
let isDraggingLuckyCoin = false;
let sparkleSound = new Audio('sparkle.mp3');
let mysteryBaitCountInInventory = parseInt(localStorage.getItem('mysteryBaitCountInInventory')) || 0;
let mysteryBaitSlot = JSON.parse(localStorage.getItem('mysteryBaitSlot')) || null;
let mysteryBaitCooldownEnd = parseInt(localStorage.getItem('mysteryBaitCooldownEnd')) || 0;
let isMysteryBaitActive = false;
let fish = parseInt(localStorage.getItem('fishCount')) || 0;
let isLakeFish1Unlocked = localStorage.getItem('isLakeFish1Unlocked') === 'true' || false;
let isMagazinePurchased = localStorage.getItem('isMagazinePurchased') === 'true' || false;
let magazineSlot = JSON.parse(localStorage.getItem('magazineSlot')) || null;
let currentMagazinePage = parseInt(localStorage.getItem('currentMagazinePage')) || 1;
let isMagazineDivsInitialized = false;

function initializeVolumes() {
    try {
        ['bgVolume', 'fireVolume', 'underwaterVolume', 'windVolume', 'cricketVolume', 'eagleVolume', 'beachVolume', 'riverVolume', 'fieldVolume', 'rockyfieldVolume', 'shopVolume'].forEach((key, i) => {
            const volume = localStorage.getItem(key);
            const audio = [backgroundMusic, fireSound, underwaterSound, windSound, cricketSound, eagleSound, beachSound, riverSound, fieldSound, rockyfieldSound, shopSound][i];
            const control = [volumeControlBg, volumeControl1, volumeControl2, volumeControl3, volumeControl4, volumeControl5, volumeControl6, volumeControlRiver, volumeControlField, volumeControlRockyfield, volumeControlShop][i];
            if (volume !== null) {
                audio.volume = parseFloat(volume);
                control.value = volume;
            } else {
                audio.volume = 1;
                control.value = 1;
            }
        });
    } catch (e) {
        console.error('Error initializing volumes:', e);
    }
}

function setWelcomeText() {
    const welcomeTextDiv = document.getElementById('welcome-text');
    const hasVisited = localStorage.getItem('hasVisited') === 'true';
    
    console.log('setWelcomeText: hasVisited =', hasVisited); // Debug log
    
    if (hasVisited) {
        welcomeTextDiv.innerHTML = `
            <p><i><b>Welcome back!</b></i></p>
            <h2 style="font-family:Aclonica;">Vibes Quest</h2>
            <p>Update 4/19/2025:</p>
            <p>The skill slider has been repositioned into the fishing display module!</p>
        `;
    } else {
        welcomeTextDiv.innerHTML = `
            <p>Welcome to</p>
            <h2 style="font-family:Aclonica;">Vibes Quest</h2>
            <p>Catch fish, unlock ambient modules,<br> & chat with friends.</p>
            <p>Each ambient module has it own volume<br>control for customizing

 your perfect vibe.</p>
        `;
    }
}

function loadGameData() {
    try {
        const savedFishCount = localStorage.getItem('fishCount');
        if (savedFishCount !== null) {
            fishCount = parseInt(savedFishCount);
            fishCountDisplay.textContent = fishCount;
        }
        const savedTotalCaught = localStorage.getItem('totalCaught');
        if (savedTotalCaught !== null) {
            totalCaught = parseInt(savedTotalCaught);
            totalCaughtDisplay.textContent = totalCaught;
        }
        const savedBestStreak = localStorage.getItem('bestStreak');
        if (savedBestStreak !== null) {
            bestStreak = parseInt(savedBestStreak);
            bestStreakDisplay.textContent = bestStreak;
        }
        const savedStreak = localStorage.getItem('streak');
        if (savedStreak !== null) {
            streak = parseInt(savedStreak);
            streakDisplay.textContent = streak;
        }
        isCoinShopPurchased = localStorage.getItem('isCoinShopPurchased') === 'true' || false;
        coinSlot = JSON.parse(localStorage.getItem('coinSlot')) || null;

        // Load checkbox state unconditionally
        const lakeFish1Checked = localStorage.getItem('lakeFish1Checked') === 'true';
        if (lakeFish1Checkbox) {
            lakeFish1Checkbox.checked = lakeFish1Checked;
            console.log('Loaded lakeFish1Checked:', lakeFish1Checked); // Debug log, optional
        }
	    
		const savedLakeFishFlair = localStorage.getItem('lakeFishFlair') || 'none';
			if (savedLakeFishFlair !== 'none' && typeof chattable !== 'undefined' && chattable.setFlair) {
				chattable.setFlair(savedLakeFishFlair);
			}
        if (isCoinShopPurchased && coinSlot) {
            const slot = inventoryGrid.querySelector(`.inventory-slot[data-row="${coinSlot.row}"][data-col="${coinSlot.col}"]`);
            if (slot && !slot.querySelector('.inventory-item')) {
                addCoinToSlot(slot);
            }
        }
        if (isBackpackCollected) {
            backpackOverlay.style.display = 'none';
            whiteOverlayInventory.style.opacity = '0';
            setTimeout(() => whiteOverlayInventory.style.display = 'none', 1000);
            inventoryGrid.style.display = 'grid';
            document.getElementById('inventory-closed').style.display = 'block';
            document.getElementById('inventory-background').style.display = 'block';
            closeBackpackBtn.style.display = 'block';
        } else {
            whiteOverlayInventory.style.opacity = '1';
            inventoryGrid.style.display = 'none';
            document.getElementById('inventory-closed').style.display = 'none';
            document.getElementById('inventory-background').style.display = 'none';
            closeBackpackBtn.style.display = 'none';
        }
        if (isManualCollected) {
            minimanualOverlay.style.display = 'none';
            const manualSlotElement = inventoryGrid.querySelector(`.inventory-slot[data-row="${manualSlot.row}"][data-col="${manualSlot.col}"]`);
            if (manualSlotElement) snapToSlot(manualItem, manualSlotElement);
        } else {
            minimanualOverlay.style.display = 'block';
            manualItem.style.display = 'none';
        }
        if (fishTrapCountInInventory > 0) {
            const slot = inventoryGrid.querySelector(`.inventory-slot[data-row="${fishTrapSlot.row}"][data-col="${fishTrapSlot.col}"]`);
            if (slot) {
                addFishTrapToSlot(slot, fishTrapCountInInventory);
            } else {
                const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot')).find(slot => !slot.querySelector('.inventory-item'));
                if (emptySlot) {
                    addFishTrapToSlot(emptySlot, fishTrapCountInInventory);
                    fishTrapSlot = {row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col)};
                    saveUnlockedStates();
                }
            }
        }
        if (isFishTrapDeployed) {
            deployFishTrapToRiver();
            startFishTrapCollection();
        }
         if (mysteryBaitCountInInventory > 0) {
            const slot = inventoryGrid.querySelector(`.inventory-slot[data-row="${mysteryBaitSlot.row}"][data-col="${mysteryBaitSlot.col}"]`);
            if (slot && !slot.querySelector('.inventory-item')) {
                addMysteryBaitToSlot(slot, mysteryBaitCountInInventory);
                const now = Date.now();
                if (mysteryBaitCooldownEnd > now) {
                    const mysteryBaitContainer = slot.querySelector('.inventory-item[src="mbait.gif"]').parentElement;
                    startCooldownTimer(mysteryBaitContainer, Math.ceil((mysteryBaitCooldownEnd - now) / 1000));
                }
            } else {
                const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot')).find(slot => !slot.querySelector('.inventory-item'));
                if (emptySlot) {
                    addMysteryBaitToSlot(emptySlot, mysteryBaitCountInInventory);
                    mysteryBaitSlot = { row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col) };
                    saveUnlockedStates();
                    const now = Date.now();
                    if (mysteryBaitCooldownEnd > now) {
                        const mysteryBaitContainer = emptySlot.querySelector('.inventory-item[src="mbait.gif"]').parentElement;
                        startCooldownTimer(mysteryBaitContainer, Math.ceil((mysteryBaitCooldownEnd - now) / 1000));
                    }
                } else {
                    console.error("No empty slots available to place Mystery Bait on load!");
                }
            }
        }

        initializeVolumes();
        initializeEgg();
        initializeCrate();


        if (isBonus1Unlocked) {
            lockOverlay1.style.display = 'none';
            volumeControl1.style.display = 'block';
            whiteOverlay2.style.opacity = '0';
            whiteOverlay3.style.opacity = '0';
            whiteOverlay4.style.opacity = '0';
            whiteOverlayChat.style.opacity = '0';
            whiteOverlay5.style.opacity = isBonus4Unlocked ? '0' : '1';
            whiteOverlay6.style.opacity = isBonus4Unlocked ? '0' : '1';
            setTimeout(() => {
                whiteOverlay2.style.display = 'none';
                whiteOverlay3.style.display = 'none';
                whiteOverlay4.style.display = 'none';
                whiteOverlayChat.style.display = 'none';
                whiteOverlay5.style.display = isBonus4Unlocked ? 'none' : 'block';
                whiteOverlay6.style.display = isBonus4Unlocked ? 'none' : 'block';
            }, 1000);
            fireSound.play().catch(e => console.error('Fire sound failed:', e));
            if (!isChatUnlocked) {
                lockOverlayChat.style.opacity = '1';
                chatSplashOverlay.style.display = 'none';
            }
            
            if (!isManualCollected) {
                minimanualOverlay.style.display = 'block';
            } else {
                minimanualOverlay.style.display = 'none';
            }
        } else {
            lockOverlayChat.style.opacity = '0';
            whiteOverlayChat.style.opacity = '1';
            chatSplashOverlay.style.display = 'none';
            minimanualOverlay.style.display = 'none'; 
        }
        
        if (isChatUnlocked) {
            lockOverlayChat.style.display = 'none';
            whiteOverlayChat.style.opacity = '0';
            setTimeout(() => whiteOverlayChat.style.display = 'none', 1000);
            chatSplashOverlay.style.display = 'flex';
            chatSplashOverlay.style.opacity = '1';
        } else if (isBonus1Unlocked) {
            lockOverlayChat.style.opacity = '1';
            whiteOverlayChat.style.opacity = '0';
            setTimeout(() => whiteOverlayChat.style.display = 'none', 1000);
            chatSplashOverlay.style.display = 'none';
        }
        
        if (isBonus2Unlocked) {
            lockOverlay2.style.display = 'none';
            foreground2.style.display = 'block';
            volumeControl2.style.display = 'block';
            setTimeout(randomFishSwim, randomTime(2, 10));
        }
        if (isBonus3Unlocked) {
            lockOverlay3.style.display = 'none';
            volumeControl3.style.display = 'block';
        }
        if (isBonus4Unlocked) {
            lockOverlay4.style.display = 'none';
            volumeControl4.style.display = 'block';
            whiteOverlay5.style.opacity = '0';
            whiteOverlay6.style.opacity = '0';
            setTimeout(() => {
                whiteOverlay5.style.display = 'none';
                whiteOverlay6.style.display = 'none';
            }, 1000);
        }
        if (isBonus5Unlocked) {
            lockOverlay5.style.display = 'none';
            volumeControl5.style.display = 'block';
        }
        if (isBonus6Unlocked) {
            lockOverlay6.style.display = 'none';
            volumeControl6.style.display = 'block';
            whiteOverlay6.style.opacity = '0';
            setTimeout(() => whiteOverlay6.style.display = 'none', 1000);
            lockOverlayField.style.opacity = '1';
            whiteOverlayField.style.opacity = '0';
            setTimeout(() => whiteOverlayField.style.display = 'none', 1000);
        } else {
            lockOverlayField.style.opacity = '0';
            whiteOverlayField.style.opacity = '1';
        }
        if (isFieldUnlocked) {
            lockOverlayField.style.display = 'none';
            volumeControlField.style.display = 'block';
            whiteOverlayField.style.opacity = '0';
            setTimeout(() => whiteOverlayField.style.display = 'none', 1000);
            lockOverlayRiver.style.opacity = '1';
            whiteOverlayRiver.style.opacity = '0';
            setTimeout(() => whiteOverlayRiver.style.display = 'none', 1000);
        } else {
            lockOverlayRiver.style.opacity = '0';
            whiteOverlayRiver.style.opacity = '1';
        }
        if (isRiverUnlocked) {
            lockOverlayRiver.style.display = 'none';
            volumeControlRiver.style.display = 'block';
            whiteOverlayRiver.style.opacity = '0';
            setTimeout(() => whiteOverlayRiver.style.display = 'none', 1000);
            lockOverlayRockyfield.style.opacity = '1';
            whiteOverlayRockyfield.style.opacity = '0';
            setTimeout(() => whiteOverlayRockyfield.style.display = 'none', 1000);
        } else {
            lockOverlayRockyfield.style.opacity = '0';
            whiteOverlayRockyfield.style.opacity = '1';
        }
        if (isRockyfieldUnlocked) {
            lockOverlayRockyfield.style.display = 'none';
            volumeControlRockyfield.style.display = 'block';
            whiteOverlayRockyfield.style.opacity = '0';
            setTimeout(() => whiteOverlayRockyfield.style.display = 'none', 1000);
            lockOverlayShop.style.opacity = '1';
            whiteOverlayShop.style.opacity = '0';
            setTimeout(() => whiteOverlayShop.style.display = 'none', 1000);
        } else {
            lockOverlayShop.style.opacity = '0';
            whiteOverlayShop.style.opacity = '1';
        }
        if (isShopUnlocked) {
            lockOverlayShop.style.display = 'none';
            volumeControlShop.style.display = 'block';
            backgroundShop.style.display = 'block';
            whiteOverlayShop.style.opacity = '0';
            setTimeout(() => whiteOverlayShop.style.display = 'none', 1000);
        }
                
		welcomeOverlay.style.display = 'flex';
        welcomeOverlay.style.opacity = '1';
        setWelcomeText(); // Corrected function name
        whiteOverlay1.style.opacity = '0';
        setTimeout(() => {
            whiteOverlay1.style.display = 'none';
            isBonus1Visible = true;
        }, 1000);

        lockOverlayField.style.opacity = '0';
        lockOverlayRiver.style.opacity = '0';
        lockOverlayRockyfield.style.opacity = '0';
        if (isBonus6Unlocked) {
            lockOverlayField.style.opacity = '1';
        }
        if (isFieldUnlocked) {
            lockOverlayRiver.style.opacity = '1';
        }
        if (isRiverUnlocked) {
            lockOverlayRockyfield.style.opacity = '1';
        }
        if (isCoinShopPurchased && coinSlot) {
            const slot = inventoryGrid.querySelector(`.inventory-slot[data-row="${coinSlot.row}"][data-col="${coinSlot.col}"]`);
            if (slot && !slot.querySelector('.inventory-item')) {
                addCoinToSlot(slot);
            }
        }
        fishTrapUncollectedFish = parseInt(localStorage.getItem('fishTrapUncollectedFish')) || 0;
        fishTrapTotalCaught = parseInt(localStorage.getItem('fishTrapTotalCaught')) || 0;
        fishTrapBreakPoint = parseInt(localStorage.getItem('fishTrapBreakPoint')) || Math.floor(Math.random() * (800 - 400 + 1)) + 400;
        isFishTrapDeployed = localStorage.getItem('isFishTrapDeployed') === 'true' || false;
        console.log('Loaded fishTrapUncollectedFish:', fishTrapUncollectedFish);

        if (isFishTrapDeployed) {
            deployFishTrapToRiver();
            startFishTrapCollection();
        }

        if (isCompendiumCollected) {
            compendiumOverlay.style.display = 'none';
            const compendiumSlotElement = inventoryGrid.querySelector(`.inventory-slot[data-row="${compendiumSlot.row}"][data-col="${compendiumSlot.col}"]`);
            if (compendiumSlotElement && !compendiumSlotElement.querySelector('.inventory-item')) {
                const compendiumItem = document.createElement('img');
                compendiumItem.className = 'inventory-item';
                compendiumItem.id = 'compendium-item';
                compendiumItem.src = 'compitem.gif';
                compendiumItem.alt = 'Fish Compendium';
                compendiumItem.draggable = true;
                snapToSlot(compendiumItem, compendiumSlotElement);

                compendiumItem.addEventListener('dragstart', (e) => {
                    draggedItem = e.target;
                    setTimeout(() => draggedItem.style.display = 'none', 0);
                });
                compendiumItem.addEventListener('dragend', (e) => {
                    draggedItem.style.display = 'block';
                    draggedItem = null;
                });

                createTooltip(compendiumItem, 'Fish Compendium');
            }
        }
        isMagazinePurchased = localStorage.getItem('isMagazinePurchased') === 'true' || false;
        magazineSlot = JSON.parse(localStorage.getItem('magazineSlot')) || null;
        if (isMagazinePurchased) {
            let slot;
            if (magazineSlot) {
                slot = inventoryGrid.querySelector(`.inventory-slot[data-row="${magazineSlot.row}"][data-col="${magazineSlot.col}"]`);
            }
            if (slot && !slot.querySelector('.inventory-item')) {
                addMagazineToSlot(slot);
            } else {
                const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot')).find(slot => !slot.querySelector('.inventory-item'));
                if (emptySlot) {
                    addMagazineToSlot(emptySlot);
                    magazineSlot = { row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col) };
                    saveUnlockedStates();
                } else {
                    console.error("No empty slots available to place Magazine on load!");
                }
            }
        }





        
    } catch (e) {
        console.error('Error loading game data:', e);
    }
} 
startBtn.addEventListener('click', () => {
    console.log('startBtn clicked'); // Debug log
    localStorage.setItem('hasVisited', 'true');
    welcomeOverlay.style.opacity = '0';
        welcomeSound.play().catch(e => console.error('Fire sound failed:', e));
    setTimeout(() => {
        welcomeOverlay.style.display = 'none';
        console.log('welcomeOverlay hidden'); // Debug log
    }, 500);
    // Play background music
    backgroundMusic.play().catch(e => console.error('Background music failed:', e));
    // Play unlocked ambient sounds
    if (isBonus1Unlocked) {
        fireSound.play().catch(e => console.error('Fire sound failed:', e));
    }
    if (isBonus2Unlocked) {
        underwaterSound.play().catch(e => console.error('Underwater sound failed:', e));
    }
    if (isBonus3Unlocked) {
        windSound.play().catch(e => console.error('Wind sound failed:', e));
    }
    if (isBonus4Unlocked) {
        cricketSound.play().catch(e => console.error('Cricket sound failed:', e));
    }
    if (isBonus5Unlocked) {
        eagleSound.play().catch(e => console.error('Eagle sound failed:', e));
    }
    if (isBonus6Unlocked) {
        beachSound.play().catch(e => console.error('Beach sound failed:', e));
    }
    if (isRiverUnlocked) {
        riverSound.play().catch(e => console.error('River sound failed:', e));
    }
    if (isFieldUnlocked) {
        fieldSound.play().catch(e => console.error('Field sound failed:', e));
    }
    if (isRockyfieldUnlocked) {
        rockyfieldSound.play().catch(e => console.error('Rockyfield sound failed:', e));
    }
    if (isShopUnlocked) {
        shopSound.play().catch(e => console.error('Shop sound failed:', e));
    }
    saveUnlockedStates();
});
/////////////////////////////////////////////////////////////////////////
////// .oooooo..o       .o.       oooooo     oooo oooooooooooo 
//////d8P'    `Y8      .888.       `888.     .8'  `888'     `8 
//////Y88bo.          .8"888.       `888.   .8'    888         
////// `"Y8888o.     .8' `888.       `888. .8'     888oooo8    
//////     `"Y88b   .88ooo8888.       `888.8'      888    "    
//////oo     .d8P  .8'     `888.       `888'       888       o 
//////8""88888P'  o88o     o8888o       `8'       o888ooooood8
////////////////////////////////////////////////////////////////////////

function saveFishCount() {
    localStorage.setItem('fishCount', fishCount.toString());
    localStorage.setItem('totalCaught', totalCaught.toString());
    localStorage.setItem('bestStreak', bestStreak.toString());
    localStorage.setItem('streak', streak.toString()); // Add current streak
}

function saveVolumes() {
    try {
        localStorage.setItem('bgVolume', backgroundMusic.volume);
        localStorage.setItem('fireVolume', fireSound.volume);
        localStorage.setItem('underwaterVolume', underwaterSound.volume);
        localStorage.setItem('windVolume', windSound.volume);
        localStorage.setItem('cricketVolume', cricketSound.volume);
        localStorage.setItem('eagleVolume', eagleSound.volume);
        localStorage.setItem('beachVolume', beachSound.volume);
        localStorage.setItem('riverVolume', riverSound.volume);
        localStorage.setItem('fieldVolume', fieldSound.volume);
        localStorage.setItem('rockyfieldVolume', rockyfieldSound.volume);
        localStorage.setItem('shopVolume', shopSound.volume);
    } catch (e) {
        console.error('Error saving volumes:', e);
    }
}

function saveUnlockedStates() {
    try {
        localStorage.setItem('isBonus1Unlocked', isBonus1Unlocked);
        localStorage.setItem('isBonus2Unlocked', isBonus2Unlocked);
        localStorage.setItem('isBonus3Unlocked', isBonus3Unlocked);
        localStorage.setItem('isBonus4Unlocked', isBonus4Unlocked);
        localStorage.setItem('isBonus5Unlocked', isBonus5Unlocked);
        localStorage.setItem('isBonus6Unlocked', isBonus6Unlocked);
        localStorage.setItem('isChatUnlocked', isChatUnlocked);
        localStorage.setItem('isRiverUnlocked', isRiverUnlocked);
        localStorage.setItem('isFieldUnlocked', isFieldUnlocked);
        localStorage.setItem('isRockyfieldUnlocked', isRockyfieldUnlocked);
        localStorage.setItem('isShopUnlocked', isShopUnlocked);
        localStorage.setItem('isBackpackCollected', isBackpackCollected);
        localStorage.setItem('isManualCollected', isManualCollected);
        localStorage.setItem('fishTrapCountInInventory', fishTrapCountInInventory.toString());
        localStorage.setItem('fishTrapSlot', JSON.stringify(fishTrapSlot));
        localStorage.setItem('manualSlot', JSON.stringify(manualSlot));
        localStorage.setItem('isFishTrapDeployed', isFishTrapDeployed.toString());
        localStorage.setItem('fishTrapUncollectedFish', fishTrapUncollectedFish.toString());
        localStorage.setItem('fishTrapTotalCaught', fishTrapTotalCaught.toString());
        localStorage.setItem('fishTrapBreakPoint', fishTrapBreakPoint.toString());
        localStorage.setItem('isCoinShopPurchased', isCoinShopPurchased);
        localStorage.setItem('coinSlot', JSON.stringify(coinSlot));
        localStorage.setItem('isMagazinePurchased', isMagazinePurchased);
        localStorage.setItem('magazineSlot', JSON.stringify(magazineSlot));
        console.log('Saved fishTrapUncollectedFish:', fishTrapUncollectedFish);
        localStorage.setItem('mysteryBaitCountInInventory', mysteryBaitCountInInventory.toString());
        localStorage.setItem('mysteryBaitSlot', JSON.stringify(mysteryBaitSlot));
        localStorage.setItem('mysteryBaitCooldownEnd', mysteryBaitCooldownEnd.toString());
    		localStorage.setItem('isCompendiumCollected', isCompendiumCollected);
    		localStorage.setItem('compendiumSlot', JSON.stringify(compendiumSlot));
    		if (lakeFish1Checkbox) {
        localStorage.setItem('lakeFish1Checked', lakeFish1Checkbox.checked);
    }
    } catch (e) {
        console.error('Error saving states:', e);
    }
}

function saveActiveItemState() {
    let state = "none";
    if (isLuckyCoinActive) {
        state = "lucky-coin";
    } else if (manualContainer.style.display === 'block') {
        state = `manual-page-${currentManualPage}`;
    } else if (fishcompendiumOverlay.style.display === 'block') {
        state = "fishcompendium";
    } else if (magazineContainer.style.display === 'block') {
        state = `magazine-page-${currentMagazinePage}`;
    }
    localStorage.setItem('activeItemState', state);
}


function wipeProgress() {
    try {
        fishCount = totalCaught = streak = bestStreak = 0;
        isBonus1Unlocked = isBonus2Unlocked = isBonus3Unlocked = isBonus4Unlocked = isBonus5Unlocked = isBonus6Unlocked = isChatUnlocked = isRiverUnlocked = isFieldUnlocked = isRockyfieldUnlocked = isShopUnlocked = isBackpackCollected = isManualCollected = false;
        fishTrapCountInInventory = 0;
        fishTrapSlot = null;
        isFishTrapDeployed = false;
        fishTrapUncollectedFish = 0;
        fishTrapTotalCaught = 0;
        fishCountDisplay.textContent = totalCaughtDisplay.textContent = streakDisplay.textContent = bestStreakDisplay.textContent = '0';
        localStorage.clear();
        if (typeof chattable !== 'undefined' && chattable.setFlair) {
            chattable.setFlair('none'); // Reset flair on wipe
        }
        location.reload();
    } catch (e) {
        console.error('Error wiping progress:', e);
    }
}

loadGameData();


[whiteOverlay1, whiteOverlay2, whiteOverlay3, whiteOverlay4, whiteOverlay5, whiteOverlay6, whiteOverlayChat, whiteOverlayInventory, whiteOverlayRiver, whiteOverlayField, whiteOverlayRockyfield, whiteOverlayShop].forEach(overlay => overlay.style.opacity = '1');
if (lakeFish1Checkbox) {
    lakeFish1Checkbox.addEventListener('change', () => {
        saveUnlockedStates();
        console.log('Lake Fish 1 checkbox updated:', lakeFish1Checkbox.checked);
    });
}


////////////////////////////////////////////////////////////////////////////////////////////////
///oooooooooooo ooooo  .oooooo..o ooooo   ooooo ooooo ooooo      ooo   .oooooo.    
///`888'     `8 `888' d8P'    `Y8 `888'   `888' `888' `888b.     `8'  d8P'  `Y8b   
/// 888          888  Y88bo.       888     888   888   8 `88b.    8  888           
/// 888oooo8     888   `"Y8888o.   888ooooo888   888   8   `88b.  8  888           
/// 888    "     888       `"Y88b  888     888   888   8     `88b.8  888     ooooo 
/// 888          888  oo     .d8P  888     888   888   8       `888  `88.    .88'  
///o888o        o888o 8""88888P'  o888o   o888o o888o o8o        `8   `Y8bood8P'  
//////////////////////////////////////////////////////////////////////////////////////////////

function castLine() {
    if (isCasting || isReeling) return;
    isCasting = true;
    castButton.disabled = true;
    castSound.play().catch(e => console.error('Cast sound failed:', e));
    fishingLine.style.transition = 'top 0.5s ease-out';
    fishingLine.style.top = '150px';
    const biteDelay = isMysteryBaitActive ? 0 : Math.random() * 4000 + 1000; 
    setTimeout(() => {
        if (isCasting) {
            biteSound.play().catch(e => console.error('Bite sound failed:', e));
            showReelButton();
        }
    }, biteDelay);
}


const skillRange = document.getElementById('skillRange');

function animatePointer() {
    let lastTime = performance.now();
    const maxSpeed = 4; // maximum velocity cap
    const friction = 0.08; // friction coefficient
    const tugStrength = 1; // tug strength

    function step(currentTime) {
        const deltaTime = (currentTime - lastTime) / 16.67; 
        lastTime = currentTime;

        // applytug and friction
        const tug = (Math.random() - 0.5) * tugStrength;
        const frictionForce = pointerVelocity * -friction;
        pointerVelocity = Math.max(-maxSpeed, Math.min(maxSpeed, pointerVelocity + (tug + frictionForce) * deltaTime));

        // update position
        pointerPosition = Math.max(0, Math.min(100, pointerPosition + pointerVelocity * deltaTime));
        if (pointerPosition === 0 || pointerPosition === 100) {
            pointerVelocity *= -0.7; // bounce back reduced velocity
        }

      
        skillRange.value = Math.round(pointerPosition);
        pointer.style.left = `${(skillRange.value / 100) * 252}px`;


        if (isFishBiting) {
            pointerInterval = requestAnimationFrame(step);
        } else {
            cancelAnimationFrame(pointerInterval);
        }
    }


    pointerInterval = requestAnimationFrame(step);
}

startBtn.addEventListener('click', () => {
    welcomeOverlay.style.opacity = '0';
    setTimeout(() => welcomeOverlay.style.display = 'none', 500);
    welcomeSound.play().catch(e => console.error('Welcome sound failed:', e));
    localStorage.setItem('hasVisited', 'true');
    backgroundMusic.play().catch(e => console.error('Background music failed:', e));
    whiteOverlay1.style.opacity = '0';
    setTimeout(() => {
        whiteOverlay1.style.display = 'none';
        isBonus1Visible = true;
    }, 1000);
});

castBtn.addEventListener('click', () => {
    if (!isFishing && canCast) {
        isFishing = true;
        castBtn.style.display = 'none';
        reelBtn.style.display = 'block';
        setForeground('cast2.gif');
        castSound.play().catch(e => console.error('Cast sound failed:', e));
        setTimeout(() => {
            setForeground('bobbing2.gif');
            const initialBiteDelay = isMysteryBaitActive ? 800 : randomTime(3, 10);
            biteTimer = setTimeout(() => {
                if (isFishing) {
                    isFishBiting = true;
                    setForeground('fishbiting2.gif');
                    alertSound.play().catch(e => console.error('Alert sound failed:', e));
                    skillSliderContainer.style.display = 'block';
                    pointerPosition = Math.floor(Math.random() * (80 - 20 + 1)) + 30;
                    skillRange.value = 50;
                    pointer.style.left = '126px';
                    pointerVelocity = (Math.random() - 0.5) * 4;
                    animatePointer();
                    setTimeout(() => {
                        if (isFishBiting) {
                            isFishBiting = false;
                            alertSound.pause();
                            alertSound.currentTime = 0;
                            setForeground('bobbing2.gif');
                            skillSliderContainer.style.display = 'none';
                            clearInterval(pointerInterval);
                            if (isFishing) biteTimer = setTimeout(() => scheduleBite(), isMysteryBaitActive ? 500 : randomTime(3, 10));
                        }
                    }, randomTime(3, 5));
                }
            }, initialBiteDelay);
        }, 700);
    }

    function scheduleBite() {
        const biteDelay = isMysteryBaitActive ? 500 : randomTime(3, 10);
        biteTimer = setTimeout(() => {
            if (isFishing) {
                isFishBiting = true;
                setForeground('fishbiting2.gif');
                alertSound.play().catch(e => console.error('Alert sound failed:', e));
                skillSliderContainer.style.display = 'block';
                pointerPosition = 50;
                skillRange.value = 50;
                pointer.style.left = '126px';
                pointerVelocity = (Math.random() - 0.5) * 4;
                animatePointer();
                setTimeout(() => {
                    if (isFishBiting) {
                        isFishBiting = false;
                        alertSound.pause();
                        alertSound.currentTime = 0;
                        setForeground('bobbing2.gif');
                        skillSliderContainer.style.display = 'none';
                        clearInterval(pointerInterval);
                        if (isFishing) biteTimer = setTimeout(scheduleBite, isMysteryBaitActive ? 500 : randomTime(3, 10));
                    }
                }, randomTime(3, 5));
            }
        }, biteDelay);
    }
});

reelBtn.addEventListener('click', () => {
    if (!isFishing) return;
    clearTimeout(biteTimer);
    reelBtn.style.display = 'none';
    isFishing = false;
    reelSound.play().catch(e => console.error('Reel sound failed:', e));
    if (isFishBiting) {
        alertSound.pause();
        alertSound.currentTime = 0;
        skillSliderContainer.style.display = 'none';
        clearInterval(pointerInterval);
        const posPercent = parseInt(skillRange.value);
        let successChance;
        if (isLuckyCoinActive) {
            successChance = (posPercent >= 30 && posPercent <= 70) ? 1 :
                (posPercent >= 15 && posPercent < 30) ? (posPercent - 15) / 15 :
                (posPercent > 70 && posPercent <= 85) ? (85 - posPercent) / 15 : 0;
        } else {
            successChance = (posPercent >= 40 && posPercent <= 60) ? 1 :
                (posPercent >= 25 && posPercent < 40) ? (posPercent - 25) / 15 :
                (posPercent > 60 && posPercent <= 75) ? (75 - posPercent) / 15 : 0;
        }

        if (Math.random() < successChance) {
            let caughtFishData = null;
            let fishValue = 1;
            const catchChance = Math.random();

            if (catchChance < 0.02) {
                const lakeFishRoll = Math.random();
                let cumulativeChance = 0;
                for (const fish of fishBackgrounds) {
                    cumulativeChance += fish.normalizedChance;
                    if (lakeFishRoll < cumulativeChance) {
                        const conditionsMet = fish.conditions.every(condition => {
                            if (condition === 'lakeFish1Checked') return document.getElementById('lake-fish-1').checked;
                            if (condition === 'luckyCoinActive') return isLuckyCoinActive;
                            if (condition === 'mysteryBaitActive') return isMysteryBaitActive;
                            return false;
                        });
                        if (conditionsMet) {
                            caughtFishData = fish;
                            setForeground(fish.reelInImage);
                            sendChatMessage(`caught a ${fish.title}!`, "botstyle");
                            fishValue = fish.bonusValue || 1;
                            if (fishValue > 1) {
                                const pos = getBonusPosition();
                                showBonusText(fishValue, pos.x, pos.y);
                            }
                        }
                        break;
                    }
                }
            }

            if (!caughtFishData) {
                caughtFishData = { title: 'fish', reelInImage: 'reel-in-fish2.gif', haveImage: 'fishhave2.gif' };
                setForeground(caughtFishData.reelInImage);
                fishValue = 1;
            }

            let caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
            const isFirstCatch = !caughtFishList.includes(caughtFishData.title);
            if (isFirstCatch) {
                caughtFishList.push(caughtFishData.title);
                localStorage.setItem('caughtFishList', JSON.stringify(caughtFishList));
                // Update compendium
                const titleElement = document.getElementById(`title-${caughtFishData.title.toLowerCase().replace(' ', '-')}`);
                const overlayElement = document.getElementById(`overlay-${caughtFishData.title.toLowerCase().replace(' ', '-')}`);
                if (titleElement) titleElement.textContent = caughtFishData.title;
                if (overlayElement) {
                    overlayElement.style.backgroundImage = `url(${caughtFishData.overlayImage})`;
                    overlayElement.style.display = 'block';
                }
                // Play sound and send message
                fishUnlockSound.play().catch(e => console.error('Unlock sound failed:', e));
                const username = localStorage.getItem('username') || 'Player'; // Adjust if username is stored differently
                sendChatMessage(`caught their first ${caughtFishData.title}!`, "botstyle");
            }

            pendingFish = fishValue;
            streak++;
            streakDisplay.textContent = streak;
            sendStreakMessage(streak);
            saveFishCount();
            resetTimer();
            setTimeout(() => {
                setForeground(caughtFishData.haveImage);
                takeFishBtn.style.display = 'block';
                castBtn.classList.add('disabled');
                canCast = false;
            }, 1200);
        } else {
            // Failure case (unchanged)
            setForeground('reel-in-nothing2.gif');
            if (streak > bestStreak) {
                bestStreak = streak;
                bestStreakDisplay.textContent = bestStreak;
                if (bestStreak > 2) {
                    sendChatMessage(`set a new personal best streak of ${bestStreak}!`, "botstyle");
                }
                saveFishCount();
            }
            streak = 0;
            streakDisplay.textContent = streak;
            updateUserFlair(streak);
            saveFishCount();
            const waitForQueue = setInterval(() => {
                if (messageQueue.length === 0 && !isProcessingQueue) {
                    clearInterval(waitForQueue);
                    updateUserFlair(streak);
                    setTimeout(() => setForeground('idlenotfishing2.gif') || enableCasting(), 1200);
                }
            }, 100);
        }
    } else {
        setForeground('reel-in-nothing2.gif');
        if (streak > bestStreak) {
            bestStreak = streak;
            bestStreakDisplay.textContent = bestStreak;
            if (bestStreak > 2) {
                sendChatMessage(`set a new personal best streak of ${bestStreak}!`, "botstyle");
            }
            saveFishCount();
        }
        streak = 0;
        streakDisplay.textContent = streak;
        updateUserFlair(streak);
        saveFishCount();
        const waitForQueue = setInterval(() => {
            if (messageQueue.length === 0 && !isProcessingQueue) {
                clearInterval(waitForQueue);
                updateUserFlair(streak);
                setTimeout(() => setForeground('idlenotfishing2.gif') || enableCasting(), 1600);
            }
        }, 100);
    }
    isFishBiting = false;
});

takeFishBtn.addEventListener('click', () => {
    fishCount += pendingFish;
    totalCaught += pendingFish;
    fishCountDisplay.textContent = fishCount;
    totalCaughtDisplay.textContent = totalCaught;
    takeFishBtn.style.display = 'none';
    setForeground('idlenotfishing2.gif');
    enableCasting();
    plusOneSound.play().catch(e => console.error('Plus one sound failed:', e));
    saveFishCount();
    pendingFish = 0;
});

function enableCasting() {
    castBtn.style.display = 'block';
    castBtn.classList.remove('disabled');
    canCast = true;
}

/////////////////////////////////////////////////////////////////////////////
///ooo        ooooo       .o.       ooooo      ooo ooooo     ooo       .o.       ooooo        
///`88.       .888'      .888.      `888b.     `8' `888'     `8'      .888.      `888'        
/// 888b     d'888      .8"888.      8 `88b.    8   888       8      .8"888.      888         
/// 8 Y88. .P  888     .8' `888.     8   `88b.  8   888       8     .8' `888.     888         
/// 8  `888'   888    .88ooo8888.    8     `88b.8   888       8    .88ooo8888.    888         
/// 8    Y     888   .8'     `888.   8       `888   `88.    .8'   .8'     `888.   888       o 
///o8o        o888o o88o     o8888o o8o        `8     `YbodP'    o88o     o8888o o888ooooood8 
/////////////////////////////////////////////////////////////////////////////

const manualContainer = document.createElement('div');
manualContainer.id = 'manual-container';
manualContainer.style.display = 'none';

const manualPage1 = document.createElement('div');
manualPage1.id = 'manual-page-1';
manualPage1.className = 'manual-page';
manualPage1.innerHTML = `
    <img src="manual.gif" alt="Manual Page 1" class="manual-graphic">
    <div class="manual-textbox">
        You might be wondering, "<i>what do I do now?</i>"<br><br> 
        This game is a relaxed fishing game that can be enjoyed in many ways, whether you're here to fish, explore, chat with others or relax to sounds of nature.<br><br> The gameworld is made up of unlockable tiles called <b><u>'modules'</u></b>. As you unlock modules, you'll discover new features, easter eggs, and unlockable content.<br><br> <b><u>Sound</u></b> is a big part of the game's experience, and each module comes with its own ambience track with a volume slider to adjust it to your preference. New ambience tracks continue layering as you unlock more modules, so get comfy with adjusting the volume level of each module to your own preference.<br><br>
        In the Woodland Crickets module, you'll discover the <b><u>Fishing Compendium</u></b>. Inside it are categories of fish, which can be unlocked for 200 fish. Unlocking the category will allow you to catch a variety of different fish with their own fishing bonuses and graphics. Once you unlock a category, you must check the box next to that category in order to begin catching those fish. Certain other conditions must also be met for certain fish to be caught; can you figure out what those are?<br><br> Eventually you may find the local <b><u>fishing store</u></b>. In here you'll find a variety of items, but I recommend you purchase the fishing trap first. This allows you to idly collect fish as long as the webpage is open in your browser, these extra fish will go a long way over time.<br><br>        
        <b><u>Commands</u></b> are also a big part of the game, <i>if</i> you use the chat module. Currently there are only two commands you can use in chat, but eventually there will be more:<br><br>
        - '!streak' announces your current fishing streak in the chat.<br><br>
        - '!fish' announces your current fish balance and your total caught amount.<br><br>
        
        All your progress and settings are <b><u>automatically saved</u></b> to your browser!<br><br>    
        This game, and this manual, are just a demo. This is nowhere near a finished state! But check back in this manual for more in the future as development progresses.<br><br>
        More features and modules to explore are on their way, but that's all for now! Thanks for all the fish!<br>
    </div>
`;

const manualPage2 = document.createElement('div');
manualPage2.id = 'manual-page-2';
manualPage2.className = 'manual-page';
manualPage2.style.display = 'none';
manualPage2.innerHTML = `
    <img src="manual2.gif" alt="Manual Page 2" class="manual-graphic">
    <div class="manual-textbox">
    <b>August 24th:</b><br><br>
    - cerimari becomes the first player to reach a 100 fish streak.<br><br>
	<b>April 19th:</b><br><br>
	- The skill slider has been moved away from the cast/reel button and into the fishing display container to be easier on the eyes.<br><br>
	<b>April 18th:</b><br><br>
	- A bug has been fixed that caused fish flairs to reset. Players who had their set their chat flair to a lake fish PFP had their flair reset back to normal whenever a bot message was sent in chat. This has been fixed and fish flairs should persist from now on.<br><br>
	<b>April 17th:</b><br><br>
	- A splash screen now shows up on every page load. This was primarily implemented to allow mobile players and Chrome users to enjoy the environmental ambience background tracks. Previously, they were only heard once unlocked for those users. This is because Chrome and mobile apps prevent autoplay from functioning. There is now no more autoplay, and background tracks now begin playing for all users after clicking the 'Let's go' button. However, introducing this splash screen is also a good way to share the most recent site updates, to ensure players are up to date with the latest changes. In the future, the splash screen may also cover the entire screen as well, just for a tidier looking game loading experience.<br><br>
    <b>April 16th:</b><br><br>
    - Added a virtual pet for purchase in the shop (1,000 fish). It dies easily.<br><br>
    <b>April 15th:</b><br><br>
    - Added a magazine item in shop that replaces the commands listed below:<br><br>
    - Removed commands '!topdog', '!topstreak,' & '!richest'<br><br>
    <b>April 14th:</b><br><br> - Added commands '!online', '!topdog', '!topstreak', '!richest', & '!rares'.<br><br>
    - Added a focus mode<br><br>
    - Added a dark mode (button on page 3 / credits page of manual item for now.)<br><br>
    <b>April 13th:</b><br><br> - New domain: vibes.fish<br><br>
    <b>April 12:</b><br><br> - Chat resize position should save (on desktop version).<br><br>
    - Each fish has its own profile picture that you can use in chat now by clicking that fish in the compendium.<br><br>
    - Made a mobile version of the page which index should redirect to automatically.<br><br>
    - Ambient sounds should now trigger and play on the mobile version.<br><br>
    - Shop module can be opened by pressing and holding on mobile.<br><br>
    - Fishing skill slider adjustments make it easier to fish on mobile.<br><br>
        <b>April 11:</b><br><br> - Introduced fish compendium. Pick up item for free in the woods.<br><br>
        - Introduced 6 new fish, with fish bonuses when caught, which can be caught after Lake Fish category is unlocked and checkmarked.<br><br>
        - Updated some shop signs to reflect accurate prices.<br><br>
        - Price for Lake Fish set to 200, to motivate you guys to buy fish traps before anything else, because fish traps are the games' meta.<br><br>
        - Skillslider has been updated for animation/movement consistency across browsers, easier to catch fish now.<br><br>
        - Skillslider pointer no longer starts in the center when fish begins biting.<br><br>
        - Chatroom can now pop out of the grid and be resized or minimized. Special thanks to <a href="https://kuroi.com.br/">Kuroi</a> for her help with this!<br><br>
        - Updated the manual (1st page)<br><br>
        - Reduced Summer Cicadas volume by -10db, and the field image has been brightened with flowers and animated.<br><br>
        - River volume reduced by -5db.<br><br>
        - Updated Rocky Fields with crows and crow sounds.<br><br>
        - Updated Lucky Coin shop graphic.<br><br>
        <b>April 8:</b><br><br> - Current Streak number now saves, reloading the page will no longer wipe Current Streak.<br><br>
        - Bot now sends message when user sets a new personal best streak number.<br><br>
        - '!streak' command now shares best streak as well.<br><br>
        - Wipe Progress has been moved to the bottom of the credits page in the manual and now asks to confirm if you actually want to wipe progress.<br><br>
        <b>April 6:</b><br><br> - Added daily bonus crate that washes up on the small beach.<br><br>
        - Demo is released into the wild, fully unprepared!
    </div>
`;

const manualPage3 = document.createElement('div');
manualPage3.id = 'manual-page-3';
manualPage3.className = 'manual-page';
manualPage3.style.display = 'none';
manualPage3.innerHTML = `
    <img src="manual3.gif" alt="Manual Page 3" class="manual-graphic">
    <div class="manual-textbox">
        <center><b>Add the Button:</b><br><br>
        <img src="vibesbtn2.gif"><br><br>
        <img src="vibesbtn3.gif"><br><br><br>
        <b>Created by:</b><br><br>
        <a href="https://onio.cafe" target="_blank"><img src="https://onio.cafe/thebutton.gif"></a><br><br><br>
        <b><u>Special thanks to</u>:</b><br><br>
        <b>Andrew</b> of Chattable:<br><br>
        <a href="https://iframe.chat/" target="_blank"><img src="https://iframe.chat/chattable-alt.gif" title="Add a stream chat to your website free with Chattable" alt="Chattable" /></a>
        <br><br>
        <b>Kuroi</b> for all her input, suggestions, and expertise:<br><br>
        <a href="https://kuroi.neocities.org"  target="_blank"><img src="https://onio.cafe/buttons/button1.png"></a><br><br>
        <hr><br>
        <b>Dark Mode / Light Mode</b><br><br>
        <button id="dark-mode-toggle">Light Off</button>
        <Hr><br>
        <b>Want to start over?</b><br><br>
        <a href="#" id="wipe-progress">Wipe Progress</a>
        
    </div>
`;

const prevPageBtn = document.createElement('button');
prevPageBtn.id = 'prev-page-btn';
prevPageBtn.className = 'manual-nav-btn';
prevPageBtn.textContent = '< < <';
prevPageBtn.style.display = 'none';
prevPageBtn.style.position = 'absolute';
prevPageBtn.style.top = '85%';
prevPageBtn.style.left = '45px';
prevPageBtn.style.transform = 'translateY(-50%)';
prevPageBtn.style.width = '40px';
prevPageBtn.style.height = '20px';
prevPageBtn.style.backgroundColor = 'yellow';
prevPageBtn.style.border = '1px solid #555';
prevPageBtn.style.borderRadius = '3px';
prevPageBtn.style.textAlign = 'center';
prevPageBtn.style.lineHeight = '12px';
prevPageBtn.style.fontSize = '12px';
prevPageBtn.style.color = '#555';
prevPageBtn.style.zIndex = '3';
prevPageBtn.style.transition = 'background-color 0.2s, color 0.2s';
prevPageBtn.style.padding = '0'; 
prevPageBtn.style.margin = '0';

const nextPageBtn = document.createElement('button');
nextPageBtn.id = 'next-page-btn';
nextPageBtn.className = 'manual-nav-btn'; 
nextPageBtn.textContent = '> > >';
nextPageBtn.style.display = 'none';
nextPageBtn.style.position = 'absolute';
nextPageBtn.style.top = '85%';
nextPageBtn.style.right = '45px';
nextPageBtn.style.transform = 'translateY(-50%)';
nextPageBtn.style.width = '40px';
nextPageBtn.style.height = '20px';
nextPageBtn.style.backgroundColor = 'yellow';
nextPageBtn.style.border = '1px solid #555';
nextPageBtn.style.borderRadius = '3px';
nextPageBtn.style.textAlign = 'center';
nextPageBtn.style.lineHeight = '12px';
nextPageBtn.style.fontSize = '12px';
nextPageBtn.style.color = '#555';
nextPageBtn.style.zIndex = '3';
nextPageBtn.style.transition = 'background-color 0.2s, color 0.2s';
nextPageBtn.style.padding = '0';
nextPageBtn.style.margin = '0';






manualContainer.appendChild(manualPage1);
manualContainer.appendChild(manualPage2);
manualContainer.appendChild(manualPage3);
manualContainer.appendChild(prevPageBtn);
manualContainer.appendChild(nextPageBtn);
activeItemContent.appendChild(manualContainer);

manualContainer.addEventListener('click', (e) => {
    const wipeLink = e.target.closest('#wipe-progress');
    if (wipeLink) {
        e.preventDefault();
        const confirmed = confirm('Are you sure you want to wipe your progress? This cannot be undone.');
        if (confirmed) {
            wipeProgress();
        }
    }
});

setTimeout(() => {
    console.log('prevPageBtn styles:', window.getComputedStyle(prevPageBtn));
    console.log('nextPageBtn styles:', window.getComputedStyle(nextPageBtn));
}, 100); 

const closeActiveItemBtn = document.createElement('div');
closeActiveItemBtn.id = 'close-active-item-btn';
closeActiveItemBtn.textContent = 'x';
activeItemContent.appendChild(closeActiveItemBtn);

let currentManualPage = 1;
const totalManualPages = 3;

function showManualPage(pageNumber) {
    console.log('Showing page:', pageNumber);
    [manualPage1, manualPage2, manualPage3].forEach((page, index) => {
        page.style.display = (index + 1 === pageNumber) ? 'block' : 'none';
    });
    prevPageBtn.style.display = pageNumber > 1 ? 'block' : 'none';
    nextPageBtn.style.display = pageNumber < totalManualPages ? 'block' : 'none';
    currentManualPage = pageNumber;
    saveActiveItemState();
}

/////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////                                                
///`7MMF'   `7MF'MMP""MM""YMM `7MMF'`7MMF'         
///  MM       M  P'   MM   `7   MM    MM           
///  MM       M       MM        MM    MM           
///  MM       M       MM        MM    MM             utilities+
///  MM       M       MM        MM    MM      ,    
///  YM.     ,M       MM        MM    MM     ,M ,, 
///   `bmmmmd"'     .JMML.    .JMML..JMMmmmmMMM db
////////////////////////////////////////////////////////////////////////////////////////////////////







////////focus

// Place this after `const isFishing = false;` and other variable declarations in your <script>
document.addEventListener('DOMContentLoaded', () => {
    const focusToggle = document.getElementById('focus-toggle');
    if (!focusToggle) {
        console.error('Focus toggle element not found!');
        return;
    }

    // Store original states to restore them
    const originalStates = {
        overlays: {},
        modules: {},
    };

    // List of all white overlay elements to toggle
    const whiteOverlayElements = [
        document.getElementById('white-overlay1'),
        document.getElementById('white-overlay2'),
        document.getElementById('white-overlay3'),
        document.getElementById('white-overlay4'),
        document.getElementById('white-overlay5'),
        document.getElementById('white-overlay6'),
        document.getElementById('white-overlay-chat'),
        document.getElementById('white-overlay-inventory'),
        document.getElementById('white-overlay-river'),
        document.getElementById('white-overlay-field'),
        document.getElementById('white-overlay-rockyfield'),
        document.getElementById('white-overlay-shop')
    ].filter(el => {
        if (!el) {
            console.warn('White overlay element is null');
            return false;
        }
        return true;
    });

    // List of modules to hide (inventory and active item)
    const moduleElements = [
        document.getElementById('inventory-module'),
        document.getElementById('active-item-module')
    ].filter(el => {
        if (!el) {
            console.warn('Module element is null');
            return false;
        }
        return true;
    });

    // Debouncing and timeout management
    let isToggling = false;
    const timeouts = [];

    // Function to clear all pending timeouts
    function clearAllTimeouts() {
        while (timeouts.length) {
            clearTimeout(timeouts.pop());
        }
    }

    // Function to save original states
    function saveOriginalStates() {
        // Save white overlays
        whiteOverlayElements.forEach(overlay => {
            originalStates.overlays[overlay.id] = {
                display: overlay.style.display,
                opacity: overlay.style.opacity
            };
        });
        // Save module states, including visibility and position
        moduleElements.forEach(module => {
            originalStates.modules[module.id] = {
                visibility: module.style.visibility,
                opacity: module.style.opacity,
                top: module.style.top,
                left: module.style.left
            };
        });
    }

    // Function to enable Focus mode (show white overlays, hide modules)
    function enableFocusMode() {
        // Show white overlays
        whiteOverlayElements.forEach(overlay => {
            overlay.style.display = 'block';
            const timeout = setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            timeouts.push(timeout);
        });

        // Hide inventory and active item modules
        moduleElements.forEach(module => {
            module.style.opacity = '0';
            const timeout = setTimeout(() => {
                module.style.visibility = 'hidden';
                module.style.pointerEvents = 'none'; // Prevent clicks
            }, 1000); // Match CSS transition: opacity 1s
            timeouts.push(timeout);
        });

        // Ensure game-display remains unchanged
        const gameDisplay = document.getElementById('game-display');
        if (gameDisplay) {
            gameDisplay.style.display = 'block';
            // No positioning changes
        }

        // Ensure stats-controls remains visible
        const statsControls = document.querySelector('.stats-controls');
        if (statsControls) {
            statsControls.style.display = 'block';
            statsControls.style.opacity = '1';
        }

        // Ensure cast button aligns with game state
        const castBtn = document.getElementById('castBtn');
        if (castBtn) {
            castBtn.style.display = isFishing ? 'none' : 'block';
        }

        // Ensure fisherman is visible
        const foreground = document.getElementById('foreground');
        if (foreground) {
            foreground.style.display = 'block';
            foreground.style.opacity = '1';
        }
    }

    // Function to disable Focus mode (hide white overlays, restore modules)
    function disableFocusMode() {
        // Restore white overlays
        whiteOverlayElements.forEach(overlay => {
            const state = originalStates.overlays[overlay.id];
            overlay.style.opacity = state.opacity || '0';
            if (state.opacity === '0') {
                const timeout = setTimeout(() => {
                    overlay.style.display = state.display || 'none';
                }, 1000); // Match CSS transition: opacity 1s
                timeouts.push(timeout);
            } else {
                overlay.style.display = state.display || 'block';
            }
        });

        // Restore modules
        moduleElements.forEach(module => {
            const state = originalStates.modules[module.id];
            module.style.visibility = state.visibility || 'visible';
            module.style.pointerEvents = ''; // Restore clicks
            module.style.top = state.top || ''; // Preserve dragged position
            module.style.left = state.left || ''; // Preserve dragged position
            const timeout = setTimeout(() => {
                module.style.opacity = state.opacity || '1';
            }, 10); // Small delay for opacity transition
            timeouts.push(timeout);
        });

        // Ensure game-display remains unchanged
        const gameDisplay = document.getElementById('game-display');
        if (gameDisplay) {
            gameDisplay.style.display = 'block';
            // No positioning changes
        }

        // Ensure stats-controls remains visible
        const statsControls = document.querySelector('.stats-controls');
        if (statsControls) {
            statsControls.style.display = 'block';
            statsControls.style.opacity = '1';
        }

        // Ensure cast button aligns with game state
        const castBtn = document.getElementById('castBtn');
        if (castBtn) {
            castBtn.style.display = isFishing ? 'none' : 'block';
        }

        // Ensure fisherman is visible
        const foreground = document.getElementById('foreground');
        if (foreground) {
            foreground.style.display = 'block';
            foreground.style.opacity = '1';
        }
    }

    // Event listener for focus toggle with debouncing
    focusToggle.addEventListener('change', () => {
        if (isToggling) return; // Ignore clicks during transition
        isToggling = true;
        clearAllTimeouts(); // Cancel pending transitions

        if (focusToggle.checked) {
            saveOriginalStates();
            enableFocusMode();
        } else {
            disableFocusMode();
        }

        // Allow new toggles after transition completes
        setTimeout(() => {
            isToggling = false;
        }, 5); // Match longest transition
    });

    // Initialize cast button visibility based on game state
    const castBtn = document.getElementById('castBtn');
    if (castBtn) {
        castBtn.style.display = isFishing ? 'none' : 'block';
    }
});


////////darkmode
document.addEventListener('DOMContentLoaded', () => {
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const activeItemContent = document.getElementById('active-item-content');
    const chatSplashOverlay = document.getElementById('chat-splash-overlay');

    // Initialize dark mode state
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        if (chatSplashOverlay) {
            chatSplashOverlay.style.backgroundColor = '#03273a';
            chatSplashOverlay.style.color = '#fff';
        }
        if (darkModeToggle) {
            darkModeToggle.textContent = 'Light On';
        }
    } else {
        if (chatSplashOverlay) {
            chatSplashOverlay.style.backgroundColor = '#fff';
            chatSplashOverlay.style.color = '#555';
        }
    }

    // Set up toggle event listener
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            darkModeToggle.textContent = isDarkMode ? 'Light On' : 'Light Off';
            if (chatSplashOverlay) {
                chatSplashOverlay.style.backgroundColor = isDarkMode ? '#03273a' : '#fff';
                chatSplashOverlay.style.color = isDarkMode ? '#fff' : '#555';
            }
        });
    }
});


function createTooltip(element, text) {
    if (!element) return;
    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent = text;
    tooltip.dataset.target = element.id;
    if (element.id === 'fish-trap-overlay') {
        element.parentElement.appendChild(tooltip);
    } else {
        document.body.appendChild(tooltip);
    }
    let timeout;

    element.addEventListener('mouseenter', () => {
        timeout = setTimeout(() => {
            if (element.id !== 'fish-trap-overlay') {
                const rect = element.getBoundingClientRect();
                tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
                tooltip.style.top = `${rect.top - tooltip.offsetHeight + 5}px`;
            }
            tooltip.classList.add('visible');
        }, 1000);
    });

    element.addEventListener('mouseleave', () => {
        clearTimeout(timeout);
        tooltip.classList.remove('visible');
    });
    return tooltip;
}

function updateTooltip(element, text) {
    const tooltip = document.querySelector(`.tooltip[data-target="${element.id}"]`) || createTooltip(element, text);
    tooltip.textContent = text;
    tooltip.classList.add('visible');
    if (element.id !== 'fish-trap-overlay') {
        const rect = element.getBoundingClientRect();
        tooltip.style.left = `${rect.left + rect.width / 2 - tooltip.offsetWidth / 2}px`;
        tooltip.style.top = `${rect.top - tooltip.offsetHeight + 5}px`;
    }
}

try {
    const minimanualIcon = document.getElementById('minimanual-icon');
    createTooltip(backpackIcon, 'Inventory');
    createTooltip(minimanualIcon, 'Game Manual');
    createTooltip(crateIcon, 'Fish Crate');
    createTooltip(eggIcon, 'Eagle Egg');
    if (manualItem) createTooltip(manualItem, 'Game Manual');
} catch (e) {
    console.error('Error applying tooltips:', e);
}

function setForeground(image) {
    foreground.src = image;
}

function setForeground2(image) {
    foreground2.src = image;
}

function randomTime(min, max) {
    return Math.floor(Math.random() * (max - min + 1) + min) * 1000;
}

function updateTimer() {
    const secondsSinceLast = Math.floor((Date.now() - lastCatchTime) / 1000);
    timerDisplay.textContent = secondsSinceLast >= 300 ? '>5 m' : `${Math.floor(secondsSinceLast / 60)} m ${secondsSinceLast % 60} s`;
}

function startTimer() {
    if (!timerInterval) timerInterval = setInterval(updateTimer, 100);
}

function resetTimer() {
    lastCatchTime = Date.now();
    updateTimer();
}


startTimer();


/////////////////////////////////////////////////////////////
///`7MMF'`7MN.   `7MF'`7MMF'   `7MF'`7MM"""YMM  `7MN.   `7MF'MMP""MM""YMM   .g8""8q.   `7MM"""Mq.  `YMM'   `MM'
///  MM    MMN.    M    `MA     ,V    MM    `7    MMN.    M  P'   MM   `7 .dP'    `YM.   MM   `MM.   VMA   ,V  
///  MM    M YMb   M     VM:   ,V     MM   d      M YMb   M       MM      dM'      `MM   MM   ,M9     VMA ,V   
///  MM    M  `MN. M      MM.  M'     MMmmMM      M  `MN. M       MM      MM        MM   MMmmdM9       VMMP    
///  MM    M   `MM.M      `MM A'      MM   Y  ,   M   `MM.M       MM      MM.      ,MP   MM  YM.        MM     
///  MM    M     YMM       :MM;       MM     ,M   M     YMM       MM      `Mb.    ,dP'   MM   `Mb.      MM     
///.JMML..JML.    YM        VF      .JMMmmmmMMM .JML.    YM     .JMML.      `"bmmd"'   .JMML. .JMM.   .JMML.  
//////////////////////////////////////////////////////////////



let draggedItem = null;

function snapToSlot(item, slot) {
    item.style.position = 'absolute';
    item.style.left = item.style.top = '0px';
    slot.appendChild(item);
}

manualItem.addEventListener('dragstart', (e) => {
    draggedItem = e.target;
    setTimeout(() => draggedItem.style.display = 'none', 0);
});
manualItem.addEventListener('dragend', (e) => {
    draggedItem.style.display = 'block';
    draggedItem = null;
});

inventoryGrid.querySelectorAll('.inventory-slot').forEach(slot => {
    slot.addEventListener('dragover', e => e.preventDefault());
    slot.addEventListener('dragenter', e => {
        e.preventDefault();
        slot.style.backgroundColor = 'rgba(255, 255, 255, 0.4)';
    });
    slot.addEventListener('dragleave', () => slot.style.backgroundColor = 'rgba(255, 255, 255, 0.2)');
    slot.addEventListener('drop', e => {
        e.preventDefault();
        if (draggedItem) {
            const draggedSlot = draggedItem.parentElement;
            const existingItem = slot.querySelector('.inventory-item[src="bptrap.gif"]')?.parentElement ||
                                slot.querySelector('.inventory-item[src="mbait.gif"]')?.parentElement ||
                                slot.querySelector('.inventory-item');

            if (existingItem && existingItem !== draggedItem) {
                const draggedIsTrap = draggedItem.querySelector?.('.inventory-item[src="bptrap.gif"]') || draggedItem.src?.includes('bptrap.gif');
                const existingIsTrap = existingItem.querySelector?.('.inventory-item[src="bptrap.gif"]') || existingItem.src?.includes('bptrap.gif');
                const draggedIsBait = draggedItem.querySelector?.('.inventory-item[src="mbait.gif"]') || draggedItem.src?.includes('mbait.gif');
                const existingIsBait = existingItem.querySelector?.('.inventory-item[src="mbait.gif"]') || existingItem.src?.includes('mbait.gif');
                const draggedIsCoin = draggedItem.src?.includes('coinmini.gif');
                const existingIsCoin = existingItem.src?.includes('coinmini.gif');
                const draggedIsCompendium = draggedItem.src?.includes('compitem.gif');
                const existingIsCompendium = existingItem.src?.includes('compitem.gif');
                const draggedIsMagazine = draggedItem.id === 'magazine-item';
                const existingIsMagazine = existingItem.id === 'magazine-item';

                if (draggedIsTrap && existingIsTrap) {
                    fishTrapCountInInventory += parseInt(draggedSlot.querySelector('.stack-count')?.textContent || 1);
                    draggedSlot.removeChild(draggedItem);
                    const stackCount = existingItem.querySelector('.stack-count');
                    stackCount.textContent = fishTrapCountInInventory;
                    stackCount.style.display = fishTrapCountInInventory >= 2 ? 'block' : 'none';
                    updateTooltip(existingItem.querySelector('.inventory-item') || existingItem, 'Fish Trap');
                    chainsSound.play().catch(e => console.error('Chain snap sound failed:', e));
                } else if (draggedIsBait && existingIsBait) {
                    mysteryBaitCountInInventory += parseInt(draggedSlot.querySelector('.stack-count')?.textContent || 1);
                    draggedSlot.removeChild(draggedItem);
                    const stackCount = existingItem.querySelector('.stack-count');
                    stackCount.textContent = mysteryBaitCountInInventory;
                    stackCount.style.display = mysteryBaitCountInInventory >= 2 ? 'block' : 'none';
                    updateTooltip(existingItem.querySelector('.inventory-item') || existingItem, 'Mystery Bait');
                } else {
                    try {
                        draggedSlot.removeChild(draggedItem);
                        if (slot.contains(existingItem)) {
                            slot.removeChild(existingItem);
                        }
                        snapToSlot(existingItem, draggedSlot);
                        snapToSlot(draggedItem, slot);
                    } catch (err) {
                        console.error('Swap error:', err);
                        if (!draggedItem.parentElement) {
                            snapToSlot(draggedItem, draggedSlot);
                            draggedItem.style.display = 'block';
                        }
                        return;
                    }

                    draggedItem.style.display = 'block';
                    existingItem.style.display = 'block';

                    // Update slots
                    if (draggedIsTrap) {
                        fishTrapSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                        const stackCount = draggedItem.querySelector('.stack-count');
                        stackCount.style.display = fishTrapCountInInventory >= 2 ? 'block' : 'none';
                        updateTooltip(draggedItem.querySelector('.inventory-item'), 'Fish Trap');
                    } else if (draggedItem.id === 'manual-item') {
                        manualSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                        updateTooltip(draggedItem, 'Game Manual');
                    } else if (draggedIsCoin) {
                        coinSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                        updateTooltip(draggedItem, 'Lucky Coin');
                    } else if (draggedIsBait) {
                        mysteryBaitSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                        const stackCount = draggedItem.querySelector('.stack-count');
                        stackCount.style.display = mysteryBaitCountInInventory >= 2 ? 'block' : 'none';
                        updateTooltip(draggedItem.querySelector('.inventory-item'), 'Mystery Bait');
                    } else if (draggedIsCompendium) {
                        compendiumSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                        updateTooltip(draggedItem, 'Fish Compendium');
                    } else if (draggedIsMagazine) {
                        magazineSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                        updateTooltip(draggedItem, 'Magazine');
                    }

                    // Update existing item slots
                    if (existingIsTrap) {
                        fishTrapSlot = { row: parseInt(draggedSlot.dataset.row), col: parseInt(draggedSlot.dataset.col) };
                        const stackCount = existingItem.querySelector('.stack-count');
                        stackCount.style.display = fishTrapCountInInventory >= 2 ? 'block' : 'none';
                        updateTooltip(existingItem.querySelector('.inventory-item'), 'Fish Trap');
                    } else if (existingItem.id === 'manual-item') {
                        manualSlot = { row: parseInt(draggedSlot.dataset.row), col: parseInt(draggedSlot.dataset.col) };
                        updateTooltip(existingItem, 'Game Manual');
                    } else if (existingIsCoin) {
                        coinSlot = { row: parseInt(draggedSlot.dataset.row), col: parseInt(draggedSlot.dataset.col) };
                        updateTooltip(existingItem, 'Lucky Coin');
                    } else if (existingIsBait) {
                        mysteryBaitSlot = { row: parseInt(draggedSlot.dataset.row), col: parseInt(draggedSlot.dataset.col) };
                        const stackCount = existingItem.querySelector('.stack-count');
                        stackCount.style.display = mysteryBaitCountInInventory >= 2 ? 'block' : 'none';
                        updateTooltip(existingItem.querySelector('.inventory-item'), 'Mystery Bait');
                    } else if (existingIsCompendium) {
                        compendiumSlot = { row: parseInt(draggedSlot.dataset.row), col: parseInt(draggedSlot.dataset.col) };
                        updateTooltip(existingItem, 'Fish Compendium');
                    } else if (existingIsMagazine) {
                        magazineSlot = { row: parseInt(draggedSlot.dataset.row), col: parseInt(draggedSlot.dataset.col) };
                        updateTooltip(existingItem, 'Magazine');
                    }
                }
            } else if (!existingItem) {
                draggedSlot.removeChild(draggedItem);
                snapToSlot(draggedItem, slot);
                draggedItem.style.display = 'block';
                if (draggedItem.querySelector?.('.inventory-item[src="bptrap.gif"]') || draggedItem.src?.includes('bptrap.gif')) {
                    fishTrapSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                    const stackCount = draggedItem.querySelector('.stack-count');
                    stackCount.style.display = fishTrapCountInInventory >= 2 ? 'block' : 'none';
                    updateTooltip(draggedItem.querySelector('.inventory-item'), 'Fish Trap');
                    chainsSound.play().catch(e => console.error('Chain snap sound failed:', e));
                } else if (draggedItem.id === 'manual-item') {
                    manualSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                    updateTooltip(draggedItem, 'Game Manual');
                } else if (draggedItem.src?.includes('coinmini.gif')) {
                    coinSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                    updateTooltip(draggedItem, 'Lucky Coin');
                } else if (draggedItem.querySelector?.('.inventory-item[src="mbait.gif"]') || draggedItem.src?.includes('mbait.gif')) {
                    mysteryBaitSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                    const stackCount = draggedItem.querySelector('.stack-count');
                    stackCount.style.display = mysteryBaitCountInInventory >= 2 ? 'block' : 'none';
                    updateTooltip(draggedItem.querySelector('.inventory-item'), 'Mystery Bait');
                } else if (draggedItem.src?.includes('compitem.gif')) {
                    compendiumSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                    updateTooltip(draggedItem, 'Fish Compendium');
                } else if (draggedItem.id === 'magazine-item') {
                    magazineSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
                    updateTooltip(draggedItem, 'Magazine');
                }
            }
            saveUnlockedStates();
        }
        slot.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
    });
});


backpackOverlay.addEventListener('click', () => {
    if (isBonus1Unlocked && !isBackpackCollected) {
        isBackpackCollected = true;
        backpackOverlay.style.display = 'none';
        whiteOverlayInventory.style.opacity = '0';
        setTimeout(() => whiteOverlayInventory.style.display = 'none', 1000);
        inventoryGrid.style.display = 'grid';
        document.getElementById('inventory-closed').style.display = 'block';
        document.getElementById('inventory-background').style.display = 'block';
        closeBackpackBtn.style.display = 'block';
        collectedSound.play().catch(e => console.error('Collected sound failed:', e));
        saveUnlockedStates();
    }
});

inventoryGrid.addEventListener('click', (e) => {
    const coinItem = e.target.closest('.inventory-item[src="coinmini.gif"]');
    const compendiumItem = e.target.closest('#compendium-item');
    const magazineItem = e.target.closest('#magazine-item');

    if (magazineItem && isMagazinePurchased) {
        e.stopPropagation();
        closeActiveOverlays();
        magazineContainer.style.display = 'block';
        showMagazinePage(currentMagazinePage);
        closeActiveItemBtn.style.display = 'block';
        pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
    } else if (compendiumItem && isCompendiumCollected) {
        e.stopPropagation();
        closeActiveOverlays();
        fishcompendiumOverlay.style.display = 'block';
        closeActiveItemBtn.style.display = 'block';
        compendiumSound.play().catch(e => console.error('Compendium sound failed:', e));
        saveActiveItemState();
    } else if (coinItem && isCoinShopPurchased) {
        closeActiveOverlays();
        initializeLuckyCoin();
        luckyCoinOverlay.style.display = 'block';
        closeActiveItemBtn.style.display = 'block';
        isLuckyCoinActive = true;
        coinSound.play().catch(e => console.error('Coin sound failed:', e));
        saveActiveItemState();
    }
});


closeActiveItemBtn.addEventListener('click', () => {
    closeActiveOverlays();
});

function closeActiveOverlays() {
    manualContainer.style.display = 'none';
    if (luckyCoinOverlay) luckyCoinOverlay.style.display = 'none';
    luckycoinGraphic.style.display = 'none';
    fishcompendiumOverlay.style.display = 'none';
    magazineContainer.style.display = 'none';
    closeActiveItemBtn.style.display = 'none';
    isLuckyCoinActive = false;
    saveActiveItemState();
}


/////////////////////////////////////////////////////////////////////////////////////////
///  .oooooo.   ooooo   ooooo       .o.       ooooooooooooo 
/// d8P'  `Y8b  `888'   `888'      .888.      8'   888   `8  Shout out to Andrew of Chattable!
///888           888     888      .8"888.          888      
///888           888ooooo888     .8' `888.         888       Connecting with others will
///888           888     888    .88ooo8888.        888       always be the most important 
///`88b    ooo   888     888   .8'     `888.       888       part of this game.
/// `Y8bood8P'  o888o   o888o o88o     o8888o     o888o     
/////////////////////////////////////////////////////////////////////////////////////////

////Chat Window
$(function() {
    const originalWidth = 256;
    const originalHeight = 527;
    const movableWidth = 404;
    const movableHeight = 527;

    // Load saved state from localStorage
    let isChatMovable = localStorage.getItem('isChatMovable') === 'true' || false;
    // Only use savedWidth if it    s a custom resize (not 256px or 404px)
    const savedWidth = localStorage.getItem('chatPanelWidth') && parseInt(localStorage.getItem('chatPanelWidth')) !== originalWidth && parseInt(localStorage.getItem('chatPanelWidth')) !== movableWidth ? parseInt(localStorage.getItem('chatPanelWidth')) : (isChatMovable ? movableWidth : originalWidth);
    const savedHeight = parseInt(localStorage.getItem('chatPanelHeight')) || originalHeight;
    const savedTop = parseInt(localStorage.getItem('chatPanelTop')) || 0;
    const savedLeft = parseInt(localStorage.getItem('chatPanelLeft')) || -143;

    // Debug: Log initial state
    console.log('Initial state:', {
        isChatMovable,
        savedWidth,
        savedHeight,
        savedTop,
        savedLeft
    });

    // Initialize chat panel with saved state
    $("#chat-panel").draggable({
        disabled: !isChatMovable,
        containment: "body",
        handle: ".chat-title-bar",
        stop: function(event, ui) {
            if (isChatMovable) {
                localStorage.setItem('chatPanelTop', ui.position.top);
                localStorage.setItem('chatPanelLeft', ui.position.left);
            }
        }
    }).resizable({
        disabled: !isChatMovable,
        minWidth: 200,
        minHeight: 200,
        handles: "se",
        stop: function(event, ui) {
            if (isChatMovable) {
                localStorage.setItem('chatPanelWidth', ui.size.width);
                localStorage.setItem('chatPanelHeight', ui.size.height);
                console.log('Resized:', { width: ui.size.width, height: ui.size.height });
            }
            // Adjust iframe and overlay
            $("#chat-panel iframe").css({
                width: '100%',
                height: `calc(100% - 25px)`
            });
            $("#chat-splash-overlay").css({
                width: '100%',
                height: `calc(100% - 25px)`
            });
                $("#online-users-overlay").css({
                    width: '100%',
                    height: `calc(100% - 25px)`
                });
        }
    });

    // Apply saved state
    if (isChatMovable) {
        $("#chat-panel").css({
            position: "absolute",
            top: savedTop + "px",
            left: savedLeft + "px",
            width: savedWidth + "px",
            height: savedHeight + "px",
            "z-index": 20
        });
        $("#toggle-img").attr("src", "https://vibequest.neocities.org/sail-active.gif");
        $("#reset-img").attr("src", "https://vibequest.neocities.org/anchor.gif");
        $("#toggle-chat-btn").css("background-color", "#90EE90");
    } else {
        $("#chat-panel").css({
            position: "relative",
            top: "",
            left: "",
            width: originalWidth + "px",
            height: originalHeight + "px",
            "z-index": 2
        });
        $("#toggle-img").attr("src", "https://vibequest.neocities.org/sail.gif");
        $("#reset-img").attr("src", "https://vibequest.neocities.org/anchor-active.gif");
        $("#toggle-chat-btn").css("background-color", "yellow");
    }

    // Toggle movable state
    $("#toggle-chat-btn").on("click", function() {
        isChatMovable = !isChatMovable;
        localStorage.setItem('isChatMovable', isChatMovable);
        console.log('Toggled isChatMovable:', isChatMovable);

        if (isChatMovable) {
            // Force 404px unless custom resized width exists
            const widthToApply = localStorage.getItem('chatPanelWidth') && parseInt(localStorage.getItem('chatPanelWidth')) !== originalWidth && parseInt(localStorage.getItem('chatPanelWidth')) !== movableWidth ? parseInt(localStorage.getItem('chatPanelWidth')) : movableWidth;
            $("#chat-panel").css({
                position: "absolute",
                top: savedTop + "px",
                left: savedLeft + "px",
                width: widthToApply + "px",
                height: savedHeight + "px",
                "z-index": 20
            });
            $("#chat-panel").draggable("enable").resizable("enable");
            $("#toggle-img").attr("src", "https://vibequest.neocities.org/sail-active.gif");
            $("#reset-img").attr("src", "https://vibequest.neocities.org/anchor.gif");
            $(this).css("background-color", "#90EE90");
            // Ensure overlay matches
            $("#chat-splash-overlay").css({
                width: '100%',
                height: `calc(100% - 25px)`
            });
            console.log('Sail state applied:', { width: widthToApply, top: savedTop, left: savedLeft });
        } else {
            $("#chat-panel").css({
                position: "relative",
                top: "",
                left: "",
                width: originalWidth + "px",
                height: originalHeight + "px",
                "z-index": 2
            });
            $("#chat-panel").draggable("disable").resizable("disable");
            $("#toggle-img").attr("src", "https://vibequest.neocities.org/sail.gif");
            $("#reset-img").attr("src", "https://vibequest.neocities.org/anchor-active.gif");
            $(this).css("background-color", "yellow");
            // Save position only
            localStorage.setItem('chatPanelTop', 0);
            localStorage.setItem('chatPanelLeft', -143);
            // Ensure overlay matches
            $("#chat-splash-overlay").css({
                width: '100%',
                height: `calc(100% - 25px)`
            });
            console.log('Anchored state applied:', { width: originalWidth });
        }
    });

    // Reset button
    $("#reset-chat-btn").on("click", function() {
        isChatMovable = false;
        localStorage.setItem('isChatMovable', isChatMovable);
        $("#chat-panel").css({
            position: "relative",
            top: "",
            left: "",
            width: originalWidth + "px",
            height: originalHeight + "px",
            "z-index": 2
        });
        $("#chat-panel").draggable("disable").resizable("disable");
        $("#toggle-img").attr("src", "https://vibequest.neocities.org/sail.gif");
        $("#reset-img").attr("src", "https://vibequest.neocities.org/anchor-active.gif");
        $("#toggle-chat-btn").css("background-color", "yellow");
        // Reset saved state
        localStorage.setItem('chatPanelWidth', originalWidth);
        localStorage.setItem('chatPanelHeight', originalHeight);
        localStorage.setItem('chatPanelTop', 0);
        localStorage.setItem('chatPanelLeft', -143);
        // Ensure overlay matches
        $("#chat-splash-overlay").css({
            width: '100%',
            height: `calc(100% - 25px)`
        });
        console.log('Reset to anchored state');
    });

    // Hover effects
    $("#toggle-chat-btn").on("mouseover", function() {
        if (!isChatMovable) {
            $("#toggle-img").attr("src", "https://vibequest.neocities.org/sail-hover.gif");
        }
    }).on("mouseout", function() {
        $("#toggle-img").attr("src", isChatMovable ? 
            "https://vibequest.neocities.org/sail-active.gif" : 
            "https://vibequest.neocities.org/sail.gif");
    });

    $("#reset-chat-btn").on("mouseover", function() {
        if (isChatMovable) {
            ("#reset-img").attr("src", "https://vibequest.neocities.org/anchor-hover.gif");
        }
    }).on("mouseout", function() {
        $("#reset-img").attr("src", isChatMovable ? 
            "https://vibequest.neocities.org/anchor.gif" : 
            "https://vibequest.neocities.org/anchor-active.gif");
    });
});














// Chat Setup
const chatRoomId = "37515919";
let username = "Fisher" + Math.floor(Math.random() * 1000);
let previousStreak = 0;

// Message queue setup
const messageQueue = [];
let isProcessingQueue = false;

function sendChatMessage(message, flair = "botstyle") {
    messageQueue.push({ message, flair });
    if (!isProcessingQueue) {
        processMessageQueue();
    }
}

function processMessageQueue() {
    if (messageQueue.length === 0) {
        isProcessingQueue = false;
        return;
    }

    isProcessingQueue = true;
    const { message, flair } = messageQueue.shift();

    if (typeof chattable === 'undefined' || !chattable.sendMessage) {
        console.warn("Chattable unavailable:", message);
        setTimeout(() => {
            processMessageQueue();
        }, 1000);
        return;
    }

    try {
        const userName = chattable.user?.name || "Fisher" + Math.floor(Math.random() * 1000);
        const fullMessage = `${userName} ${message}`;
        const currentFlair = chattable.user?.flair || 'none';
        const savedLakeFishFlair = localStorage.getItem('lakeFishFlair') || 'none';
        const lakeFishFlairs = fishBackgrounds.map(fish => fish.flair);

        // Use current flair if it's a lake fish flair or flames; otherwise, use saved flair
        const flairToRestore = lakeFishFlairs.includes(currentFlair) || currentFlair === 'flames' ? currentFlair : savedLakeFishFlair;

        chattable.setFlair(flair); // Set temporary flair (e.g., botstyle)
        const success = chattable.sendMessage(fullMessage);
        chattable.setFlair(flairToRestore); // Restore the appropriate flair

        if (success) {
            console.log(`Sent: "${fullMessage}" as ${userName} with flair ${flair}, restored to ${flairToRestore}`);
        }
    } catch (error) {
        console.error(`Chat send error: "${message}"`, error);
        chattable.setFlair(localStorage.getItem('lakeFishFlair') || 'none');
    }

    setTimeout(processMessageQueue, 500);
}

function updateUserFlair(streak) {
    if (typeof chattable === 'undefined') return;

    const savedLakeFishFlair = localStorage.getItem('lakeFishFlair') || 'none';
    const currentFlair = chattable.user?.flair || 'none';
    const lakeFishFlairs = fishBackgrounds.map(fish => fish.flair); // ['CatfishPFP', 'LargemouthPFP', ...]

    if (streak >= 5) {
        // Always show "You're on fire!" for streak >= 5
        statusDisplay.textContent = "You're on fire!";
        statusDisplay.style.color = "red";

        // Apply flames flair only if no lake fish flair is active
        if (!lakeFishFlairs.includes(currentFlair)) {
            chattable.setFlair("flames");
        } // Else, keep the lake fish flair
    } else {
        // Clear fire status when streak drops below 5
        statusDisplay.textContent = "";
        statusDisplay.style.color = "";

        // Restore lake fish flair or set to none
        if (lakeFishFlairs.includes(savedLakeFishFlair)) {
            chattable.setFlair(savedLakeFishFlair); // Restore fish flair
        } else {
            chattable.setFlair("none");
        }

        // Send "flame extinguished" message if previous streak was >= 5
        if (previousStreak >= 5) {
            sendChatMessage("ended their streak and their flame has been extinguished.", "botstyle");
        }
    }
    previousStreak = streak;
}

chattable.commands = {
    "streak": function() {
        const userName = chattable.user && chattable.user.name ? chattable.user.name : "Unknown";
        sendChatMessage(`'s current streak is ${streak}, and their best streak is ${bestStreak}`, "botstyle");
    },
    "fish": function() {
        const userName = chattable.user && chattable.user.name ? chattable.user.name : "Unknown";
        sendChatMessage(`has ${fishCount} fish, and has caught ${totalCaught} in total.`, "botstyle");
    },
    "rares": function() {
        const userName = chattable.user && chattable.user.name ? chattable.user.name : "Unknown";
        const caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
        const lakeFish = [
            "Channel Catfish",
            "Largemouth Bass",
            "Common Carp",
            "Black Crappie",
            "Pumpkinseed",
            "Yellow Perch"
        ];
        const unlockedCount = caughtFishList.filter(fish => lakeFish.includes(fish)).length;
        const totalFish = lakeFish.length; // 6
        sendChatMessage(`has unlocked ${unlockedCount} out of ${totalFish} rare fish!`, "botstyle");
    },

    "online": function() {
    console.log("!online command triggered");
    const issuerUid = chattable.user.uid;
    const onlineUsers = [];
    let responseTimeout;

    const handleOnlinePayload = function(data) {
        if (data.type === "online_response" && data.issuerUid === issuerUid) {
            console.log("Received online_response from:", data.name);
            onlineUsers.push(data.name);
        }
    };

    console.log("Registering payload listener for online_response");
    chattable.on("payload", handleOnlinePayload);

    console.log("Sending online_request payload");
    chattable.sendPayload({
        type: "online_request",
        issuerUid: issuerUid
    });

    responseTimeout = setTimeout(() => {
        console.log("Timeout reached, processing online users:", onlineUsers);
        chattable.off("payload", handleOnlinePayload);
        const userList = document.getElementById('online-users-list');
        if (!userList) {
            console.error("online-users-list element not found");
            return;
        }
        userList.innerHTML = '';
        if (onlineUsers.length === 0) {
            console.log("No users responded");
            const li = document.createElement('li');
            li.textContent = 'No users responded.';
            userList.appendChild(li);
        } else {
            console.log("Populating user list with", onlineUsers.length, "users");
            onlineUsers.sort().forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                userList.appendChild(li);
            });
        }
        const overlay = document.getElementById('online-users-overlay');
        if (!overlay) {
            console.error("online-users-overlay element not found");
            return;
        }
        console.log("Showing online-users-overlay");
        overlay.style.display = 'flex';
    }, 3000);
}
};



chattable.on("payload", function(data) {
    if (data.type === "balance_request") {
        chattable.sendPayload({
            type: "balance_response",
            issuerUid: data.issuerUid,
            name: chattable.user.name || "Anonymous",
            balance: fishCount
        });
    } else if (data.type === "caught_request") {
        chattable.sendPayload({
            type: "caught_response",
            issuerUid: data.issuerUid,
            name: chattable.user.name || "Anonymous",
            totalCaught: totalCaught
        });
    } else if (data.type === "streak_request") {
        chattable.sendPayload({
            type: "streak_response",
            issuerUid: data.issuerUid,
            name: chattable.user.name || "Anonymous",
            bestStreak: bestStreak
        });
    } else if (data.type === "online_request") {
        chattable.sendPayload({
            type: "online_response",
            issuerUid: data.issuerUid,
            name: chattable.user.name || "Anonymous"
        });
    }
});

document.getElementById('exit-online-users-btn').addEventListener('click', () => {
    document.getElementById('online-users-overlay').style.display = 'none';
});

function getOrdinal(n) {
    const suffixes = ["th", "st", "nd", "rd"];
    const v = n % 100;
    return n + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
}

function showTopFishers() {
    const issuerUid = chattable.user.uid;
    const caught = [];

    const handleCaughtPayload = function(data) {
        if (data.type === "caught_response" && data.issuerUid === issuerUid) {
            caught.push({
                name: data.name,
                totalCaught: data.totalCaught
            });
        }
    };

    chattable.on("payload", handleCaughtPayload);

    chattable.sendPayload({
        type: "caught_request",
        issuerUid: issuerUid
    });

    setTimeout(() => {
        chattable.off("payload", handleCaughtPayload);

        caught.sort((a, b) => b.totalCaught - a.totalCaught);
        const topFive = caught.slice(0, 5);

        if (topFive.length === 0) {
            sendChatMessage(", no one shared their total fish caught!", "botstyle");
        } else {
            let message = "read a magazine article about the best fishers! :trophy:\n";
            topFive.forEach((entry, index) => {
                message += `${getOrdinal(index + 1)}**: **${entry.name}** has caught a total of **${entry.totalCaught} fish**.\n`;
            });
            sendChatMessage(message.trim(), "botstyle");
        }
    }, 3000);
}

function showTopStreak() {
    const issuerUid = chattable.user.uid;
    const streaks = [];

    const handleStreakPayload = function(data) {
    if (data.type === "streak_response" && data.issuerUid === issuerUid) {
        streaks.push({
            name: data.name,
            streak: data.bestStreak // Changed from data.streak
        });
    }
};

    chattable.on("payload", handleStreakPayload);

    chattable.sendPayload({
        type: "streak_request",
        issuerUid: issuerUid
    });

    setTimeout(() => {
        chattable.off("payload", handleStreakPayload);

        streaks.sort((a, b) => b.streak - a.streak);
        const topFive = streaks.slice(0, 5);

        if (topFive.length === 0) {
            sendChatMessage(", no one shared their fishing streak!", "botstyle");
        } else {
            let message = "read a magazine article about the longest fishing streaks! :onfire:\n";
            topFive.forEach((entry, index) => {
                message += `${getOrdinal(index + 1)}**: **${entry.name}** with a streak of **${entry.streak} catches**.\n`;
            });
            sendChatMessage(message.trim(), "botstyle");
        }
    }, 3000);
}

function showTopBalance() {
    const issuerUid = chattable.user.uid;
    const balances = [];

    const handleBalancePayload = function(data) {
        if (data.type === "balance_response" && data.issuerUid === issuerUid) {
            balances.push({
                name: data.name,
                balance: data.balance
            });
        }
    };

    chattable.on("payload", handleBalancePayload);

    chattable.sendPayload({
        type: "balance_request",
        issuerUid: issuerUid
    });

    setTimeout(() => {
        chattable.off("payload", handleBalancePayload);

        balances.sort((a, b) => b.balance - a.balance);
        const topFive = balances.slice(0, 5);

        if (topFive.length === 0) {
            sendChatMessage(", no one shared their fish balance!", "botstyle");
        } else {
            let message = "read a magazine article about who is hoarding the most fish! :gift:\n";
            topFive.forEach((entry, index) => {
                message += `${getOrdinal(index + 1)}**: **${entry.name}** with **${entry.balance} fish**.\n`;
            });
            sendChatMessage(message.trim(), "botstyle");
        }
    }, 3000);
}


chattable.initialize({
    stylesheet: "chattable2.css"
});

joinChatBtn.addEventListener('click', () => {
    chatSplashOverlay.style.opacity = '0';
    setTimeout(() => chatSplashOverlay.style.display = 'none', 500);
    sendChatMessage(`joined us, welcome!`, "botstyle");
});
function catchFish(fishTitle) {
    let caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
    if (!caughtFishList.includes(fishTitle)) {
        caughtFishList.push(fishTitle);
        localStorage.setItem('caughtFishList', JSON.stringify(caughtFishList));
        fishUnlockSound.play().catch(e => console.error('Fish unlock sound failed:', e));
        sendChatMessage(`caught a ${fishTitle}!`, "botstyle");
    }
}
function sendStreakMessage(streak) {
    const messages = {
        3: "is on a fishing streak!",
        5: "is on fire!",
        7: "caught 7 fish in a row! Is this luck?",
        9: "is on a 9 fish streak! They are an expert!",
        12: "is on a 12 fish streak and seems to be a master!!",
        15: "is on a 15 fish streak, could this really just be skill?!",
        20: "is on a 20 fish streak, is that even possible?!",
        25: "caught 25 fish in a row, how is this not impossible?!",
        30: "has caught 30 fish in a row and seems unstoppable!!",
        35: "caught 35 fish in a row?! This has gotta be hax!!",
        40: "is committing atrocities against fish-kind!!",
        50: "caught 50 fish and is literally clearing out the pond!!",
        60: "has caught 60 fish on their on their fish-fueled rampage!!",    
        70: "has caught 70 fish and committed multiple violations of the Fisheva Conventions",
        80: "is a fishing war machine, ushering in a new age of environmental devastation",
        90: "is causing children in other countries to starve due to depopulating the fish supply",
        100: "is on a 100 fish streak, a number so high and a streak so long that the world is growing cold and numb to this harsh new reality. People have adapted to a way of life without fish and journalists have moved onto covering other news."        
    };
    if (messages[streak]) {
        sendChatMessage(messages[streak], "botstyle");
        updateUserFlair(streak);
    }
}









////////////////////////////////////////////////////////////////////////////
///oooooooooooo ooooooo  ooooo ooooooooo.   ooooo          .oooooo.   ooooooooo.   oooooooooooo 
///`888'     `8  `8888    d8'  `888   `Y88. `888'         d8P'  `Y8b  `888   `Y88. `888'     `8 
/// 888            Y888..8P     888   .d88'  888         888      888  888   .d88'  888         
/// 888oooo8        `8888'      888ooo88P'   888         888      888  888ooo88P'   888oooo8    
/// 888    "       .8PY888.     888          888         888      888  888`88b.     888    "    
/// 888       o   d8'  `888b    888          888       o `88b    d88'  888  `88b.   888       o 
///o888ooooood8 o888o  o88888o o888o        o888ooooood8  `Y8bood8P'  o888o  o888o o888ooooood8

/// this just handles the white overlays and lock overlays, as well as the sound controls for each module

lockOverlay1.addEventListener('click', () => {
    if (fishCount >= 2 && !isBonus1Unlocked && isBonus1Visible) {
        fishCount -= 2;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        
        isBonus1Unlocked = true;
        lockOverlay1.style.opacity = '0';
        setTimeout(() => {
            lockOverlay1.style.display = 'none';
            volumeControl1.style.display = 'block';
            lockOverlayChat.style.opacity = '1';
            whiteOverlayChat.style.opacity = '0';
            setTimeout(() => {
                whiteOverlayChat.style.display = 'none';
                whiteOverlay2.style.opacity = '0';
                whiteOverlay3.style.opacity = '0';
                whiteOverlay4.style.opacity = '0';
                whiteOverlay5.style.display = 'block';
                whiteOverlay6.style.display = 'block';
                setTimeout(() => {
                    whiteOverlay2.style.display = 'none';
                    whiteOverlay3.style.display = 'none';
                    whiteOverlay4.style.display = 'none';
                }, 1000);
                if (!isBackpackCollected) {
                    backpackOverlay.style.display = 'block';
                    backpackIcon.style.display = 'block';
                }
                if (!isManualCollected) {
                    minimanualOverlay.style.display = 'block';
                }
            }, 1000);
            chatSplashOverlay.style.display = 'none';
        }, 1000);
        fireSound.play().catch(e => console.error('Fire sound failed:', e));
        level1Sound.play().catch(e => console.error('Level 1 sound failed:', e));
        sendChatMessage("explored their camping site!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlay2.addEventListener('click', () => {
    if (isBonus1Unlocked && fishCount >= 3 && !isBonus2Unlocked) {
        fishCount -= 3;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isBonus2Unlocked = true;
        lockOverlay2.style.opacity = '0';
        setTimeout(() => {
            lockOverlay2.style.display = 'none';
            foreground2.style.display = 'block';
            volumeControl2.style.display = 'block';
        }, 1000);
        underwaterSound.play().catch(e => console.error('Underwater sound failed:', e));
        level2Sound.play().catch(e => console.error('Level 2 sound failed:', e));
        sendChatMessage("took a dive in the lake!", "botstyle");
        saveUnlockedStates();
        setTimeout(randomFishSwim, randomTime(2, 10));
    }
});

lockOverlay3.addEventListener('click', () => {
    if (isBonus1Unlocked && fishCount >= 2 && !isBonus3Unlocked) {
        fishCount -= 2;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isBonus3Unlocked = true;
        lockOverlay3.style.opacity = '0';
        setTimeout(() => {
            lockOverlay3.style.display = 'none';
            volumeControl3.style.display = 'block';
        }, 1000);
        windSound.play().catch(e => console.error('Wind sound failed:', e));
        level3Sound.play().catch(e => console.error('Level 3 sound failed:', e));
        sendChatMessage("basked in the sunshine!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlay4.addEventListener('click', () => {
    if (isBonus1Unlocked && fishCount >= 3 && !isBonus4Unlocked) {
        fishCount -= 3;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isBonus4Unlocked = true;
        lockOverlay4.style.opacity = '0';
        setTimeout(() => {
            lockOverlay4.style.display = 'none';
            volumeControl4.style.display = 'block';
            whiteOverlay5.style.opacity = '0';
            whiteOverlay6.style.opacity = '0';
            setTimeout(() => {
                whiteOverlay5.style.display = 'none';
                whiteOverlay6.style.display = 'none';
            }, 5000);
        }, 5000);
        cricketSound.play().catch(e => console.error('Cricket sound failed:', e));
        level4Sound.play().catch(e => console.error('Level 4 sound failed:', e));
        sendChatMessage("explored the woods!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlay5.addEventListener('click', () => {
    if (isBonus4Unlocked && fishCount >= 3 && !isBonus5Unlocked) {
        fishCount -= 3;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isBonus5Unlocked = true;
        lockOverlay5.style.opacity = '0';
        setTimeout(() => {
            lockOverlay5.style.display = 'none';
            volumeControl5.style.display = 'block';
        }, 1000);
        eagleSound.play().catch(e => console.error('Eagle sound failed:', e));
        level5Sound.play().catch(e => console.error('Level 5 sound failed:', e));
        sendChatMessage("spot an eagle above the treetops!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlay6.addEventListener('click', () => {
    if (isBonus4Unlocked && fishCount >= 4 && !isBonus6Unlocked) {
        fishCount -= 4;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isBonus6Unlocked = true;
        lockOverlay6.style.opacity = '0';
        setTimeout(() => {
            lockOverlay6.style.display = 'none';
            volumeControl6.style.display = 'block';
            whiteOverlay6.style.opacity = '0';
            setTimeout(() => whiteOverlay6.style.display = 'none', 1000);
            lockOverlayField.style.opacity = '1';
            whiteOverlayField.style.opacity = '0';
            setTimeout(() => whiteOverlayField.style.display = 'none', 1000);
        }, 1000);
        beachSound.play().catch(e => console.error('Beach sound failed:', e));
        level2Sound.play().catch(e => console.error('Level 2 sound failed:', e));
        sendChatMessage("discovered a small beach!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlayChat.addEventListener('click', () => {
    if (isBonus1Unlocked && fishCount >= 2 && !isChatUnlocked) {
        fishCount -= 2;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isChatUnlocked = true;
        lockOverlayChat.style.opacity = '0';
        setTimeout(() => {
            lockOverlayChat.style.display = 'none';
            chatSplashOverlay.style.display = 'flex';
            chatSplashOverlay.style.opacity = '1';
        }, 1000);
        level5Sound.play().catch(e => console.error('Level 5 sound failed:', e));
        saveUnlockedStates();
    }
});

lockOverlayField.addEventListener('click', () => {
    if (isBonus6Unlocked && fishCount >= 4 && !isFieldUnlocked) {
        fishCount -= 4;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isFieldUnlocked = true;
        lockOverlayField.style.opacity = '0';
        setTimeout(() => {
            lockOverlayField.style.display = 'none';
            volumeControlField.style.display = 'block';
            lockOverlayRiver.style.opacity = '1';
            whiteOverlayRiver.style.opacity = '0';
            setTimeout(() => whiteOverlayRiver.style.display = 'none', 1000);
        }, 1000);
        fieldSound.play().catch(e => console.error('Field sound failed:', e));
        level3Sound.play().catch(e => console.error('Level 3 sound failed:', e));
        sendChatMessage("explored the field!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlayRiver.addEventListener('click', () => {
    if (isFieldUnlocked && fishCount >= 4 && !isRiverUnlocked) {
        fishCount -= 4;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isRiverUnlocked = true;
        lockOverlayRiver.style.opacity = '0';
        setTimeout(() => {
            lockOverlayRiver.style.display = 'none';
            volumeControlRiver.style.display = 'block';
            lockOverlayRockyfield.style.opacity = '1';
            whiteOverlayRockyfield.style.opacity = '0';
            setTimeout(() => whiteOverlayRockyfield.style.display = 'none', 1000);
        }, 1000);
        riverSound.play().catch(e => console.error('River sound failed:', e));
        level2Sound.play().catch(e => console.error('Level 2 sound failed:', e));
        sendChatMessage("discovered the river!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlayRockyfield.addEventListener('click', () => {
    if (isRiverUnlocked && fishCount >= 6 && !isRockyfieldUnlocked) {
        fishCount -= 6;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isRockyfieldUnlocked = true;
        lockOverlayRockyfield.style.opacity = '0';
        setTimeout(() => {
            lockOverlayRockyfield.style.display = 'none';
            volumeControlRockyfield.style.display = 'block';
            lockOverlayShop.style.opacity = '1';
            whiteOverlayShop.style.opacity = '0';
            setTimeout(() => whiteOverlayShop.style.display = 'none', 1000);
        }, 1000);
        rockyfieldSound.play().catch(e => console.error('Rockyfield sound failed:', e));
        level1Sound.play().catch(e => console.error('Level 1 sound failed:', e));
        sendChatMessage("explored the rocky field!", "botstyle");
        saveUnlockedStates();
    }
});

lockOverlayShop.addEventListener('click', () => {
    if (isRockyfieldUnlocked && fishCount >= 5 && !isShopUnlocked) {
        fishCount -= 5;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isShopUnlocked = true;
        lockOverlayShop.style.opacity = '0';
        setTimeout(() => {
            lockOverlayShop.style.display = 'none';
            volumeControlShop.style.display = 'block';
            backgroundShop.style.display = 'block';
        }, 1000);
        shopSound.play().catch(e => console.error('Shop sound failed:', e));
        level5Sound.play().catch(e => console.error('Level 5 sound failed:', e));
        sendChatMessage("visited the local fishing store!", "botstyle");
        saveUnlockedStates();
    }
});


volumeControlBg.addEventListener('input', () => {
    backgroundMusic.volume = volumeControlBg.value;
    saveVolumes();
});

volumeControl1.addEventListener('input', () => {
    fireSound.volume = volumeControl1.value;
    saveVolumes();
});

volumeControl2.addEventListener('input', () => {
    underwaterSound.volume = volumeControl2.value;
    saveVolumes();
});

volumeControl3.addEventListener('input', () => {
    windSound.volume = volumeControl3.value;
    saveVolumes();
});

volumeControl4.addEventListener('input', () => {
    cricketSound.volume = volumeControl4.value;
    saveVolumes();
});

volumeControl5.addEventListener('input', () => {
    eagleSound.volume = volumeControl5.value;
    saveVolumes();
});

volumeControl6.addEventListener('input', () => {
    beachSound.volume = volumeControl6.value;
    saveVolumes();
});

volumeControlRiver.addEventListener('input', () => {
    riverSound.volume = volumeControlRiver.value;
    saveVolumes();
});

volumeControlField.addEventListener('input', () => {
    fieldSound.volume = volumeControlField.value;
    saveVolumes();
});

volumeControlRockyfield.addEventListener('input', () => {
    rockyfieldSound.volume = volumeControlRockyfield.value;
    saveVolumes();
});

volumeControlShop.addEventListener('input', () => {
    shopSound.volume = volumeControlShop.value;
    saveVolumes();
});




///  .oooooo.     .oooooo.   ooo        ooooo ooooooooo.   oooooooooooo ooooo      ooo oooooooooo.   ooooo ooooo     ooo ooo        ooooo 
/// d8P'  `Y8b   d8P'  `Y8b  `88.       .888' `888   `Y88. `888'     `8 `888b.     `8' `888'   `Y8b  `888' `888'     `8' `88.       .888' 
///888          888      888  888b     d'888   888   .d88'  888          8 `88b.    8   888      888  888   888       8   888b     d'888  
///888          888      888  8 Y88. .P  888   888ooo88P'   888oooo8     8   `88b.  8   888      888  888   888       8   8 Y88. .P  888  
///888          888      888  8  `888'   888   888          888    "     8     `88b.8   888      888  888   888       8   8  `888'   888  
///`88b    ooo  `88b    d88'  8    Y     888   888          888       o  8       `888   888     d88'  888   `88.    .8'   8    Y     888  
/// `Y8bood8P'   `Y8bood8P'  o8o        o888o o888o        o888ooooood8 o8o        `8  o888bood8P'   o888o    `YbodP'    o8o        o888o





compendiumOverlay.addEventListener('click', () => {
    if (!isCompendiumCollected && isBonus4Unlocked) {
        isCompendiumCollected = true;
        compendiumOverlay.style.display = 'none';
        collectedSound.play().catch(e => console.error('Collected sound failed:', e));

        if (!isBackpackCollected) {
            isBackpackCollected = true;
            backpackOverlay.style.display = 'none';
            whiteOverlayInventory.style.opacity = '0';
            setTimeout(() => whiteOverlayInventory.style.display = 'none', 1000);
            inventoryGrid.style.display = 'grid';
            document.getElementById('inventory-closed').style.display = 'block';
            document.getElementById('inventory-background').style.display = 'block';
            closeBackpackBtn.style.display = 'block';
        }

        const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot'))
            .find(slot => !slot.querySelector('.inventory-item'));
        if (emptySlot) {
            const compendiumItem = document.createElement('img');
            compendiumItem.className = 'inventory-item';
            compendiumItem.id = 'compendium-item'; // Unique ID for detection
            compendiumItem.src = 'compitem.gif';
            compendiumItem.alt = 'Fish Compendium';
            compendiumItem.draggable = true;
            snapToSlot(compendiumItem, emptySlot);
            compendiumSlot = { row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col) };

            compendiumItem.addEventListener('dragstart', (e) => {
                draggedItem = e.target;
                setTimeout(() => draggedItem.style.display = 'none', 0);
            });
            compendiumItem.addEventListener('dragend', (e) => {
                draggedItem.style.display = 'block';
                draggedItem = null;
            });

            createTooltip(compendiumItem, 'Fish Compendium');
        } else {
            console.error("No empty slots available for Fish Compendium!");
            isCompendiumCollected = false;
        }
        saveUnlockedStates();
    }
});

document.querySelectorAll('#compendium-list input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
            document.querySelectorAll('#compendium-list input[type="checkbox"]').forEach(cb => {
                if (cb !== e.target) cb.checked = false;
            });
        }
    });
});

function openFishCompendium() {
    closeActiveOverlays(); // Close other overlays
    fishcompendiumOverlay.style.display = 'block';
    fishcompendiumOverlay.style.zIndex = '5'; // Ensure compendium is above other content
    fishDetailOverlay.style.display = 'none'; // Hide fish detail overlay
    fishDetailControls.style.display = 'none'; // Hide controls initially
    closeActiveItemBtn.style.display = 'block';
    compendiumSound.play().catch(e => console.error('Compendium sound failed:', e));
    saveActiveItemState();
}

// Fish Detail Overlay
const fishDetailOverlay = document.createElement('div');
fishDetailOverlay.id = 'fish-detail-overlay';
fishDetailOverlay.style.position = 'absolute';
fishDetailOverlay.style.top = '0';
fishDetailOverlay.style.left = '0';
fishDetailOverlay.style.width = '256px';
fishDetailOverlay.style.height = '256px';
fishDetailOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
fishDetailOverlay.style.zIndex = '5';
fishDetailOverlay.style.display = 'none';
fishDetailOverlay.style.transition = 'opacity 0.5s ease';
fishcompendiumOverlay.appendChild(fishDetailOverlay);


const fishDetailUnlockedOverlay = document.createElement('div');
fishDetailUnlockedOverlay.id = 'fish-detail-unlocked-overlay';
fishDetailUnlockedOverlay.style.position = 'absolute';
fishDetailUnlockedOverlay.style.top = '0';
fishDetailUnlockedOverlay.style.left = '0';
fishDetailUnlockedOverlay.style.width = '256px';
fishDetailUnlockedOverlay.style.height = '256px';
fishDetailUnlockedOverlay.style.zIndex = '6';
fishDetailUnlockedOverlay.style.display = 'none'; // Starts hidden
fishDetailUnlockedOverlay.style.transition = 'opacity 0.5s ease';
fishcompendiumOverlay.appendChild(fishDetailUnlockedOverlay);

const fishDetailUnlockedBackground = document.createElement('img');
fishDetailUnlockedBackground.id = 'fish-detail-unlocked-background';
fishDetailUnlockedBackground.style.width = '100%';
fishDetailUnlockedBackground.style.height = '100%';
fishDetailUnlockedBackground.style.position = 'absolute';
fishDetailUnlockedBackground.style.top = '0';
fishDetailUnlockedBackground.style.left = '0';
fishDetailUnlockedBackground.style.zIndex = '6';
fishDetailUnlockedOverlay.appendChild(fishDetailUnlockedBackground);

// Create a container for interactive elements to ensure they're above both overlays
const fishDetailControls = document.createElement('div');
fishDetailControls.style.position = 'absolute';
fishDetailControls.style.top = '0';
fishDetailControls.style.left = '0';
fishDetailControls.style.width = '256px';
fishDetailControls.style.height = '48px';
fishDetailControls.style.zIndex = '8'; // Ensure it s above fishDetailOverlay
fishDetailControls.style.display = 'none'; // Hidden by default
fishcompendiumOverlay.appendChild(fishDetailControls);

const exitFishDetailBtn = document.createElement('div');
exitFishDetailBtn.id = 'exit-fish-detail-btn';
exitFishDetailBtn.textContent = '<';
exitFishDetailBtn.style.position = 'absolute';
exitFishDetailBtn.style.top = '0%';
exitFishDetailBtn.style.left = '8%';
exitFishDetailBtn.style.width = '16px';
exitFishDetailBtn.style.height = '16px';
exitFishDetailBtn.style.backgroundColor = 'yellow';
exitFishDetailBtn.style.border = '1px solid #555';
exitFishDetailBtn.style.borderRadius = '3px';
exitFishDetailBtn.style.textAlign = 'center';
exitFishDetailBtn.style.lineHeight = '14px';
exitFishDetailBtn.style.fontSize = '12px';
exitFishDetailBtn.style.color = '#555';
exitFishDetailBtn.style.cursor = 'pointer';
exitFishDetailBtn.style.transition = 'background-color 0.2s, color 0.2s';
fishDetailControls.appendChild(exitFishDetailBtn);

const nextFishDetailBtn = document.createElement('div');
nextFishDetailBtn.id = 'next-fish-detail-btn';
nextFishDetailBtn.textContent = '> > >';
nextFishDetailBtn.style.position = 'absolute';
nextFishDetailBtn.style.top = '0%';
nextFishDetailBtn.style.right = '5%';
nextFishDetailBtn.style.width = '32px';
nextFishDetailBtn.style.height = '16px';
nextFishDetailBtn.style.backgroundColor = 'yellow';
nextFishDetailBtn.style.border = '1px solid #555';
nextFishDetailBtn.style.borderRadius = '3px';
nextFishDetailBtn.style.textAlign = 'center';
nextFishDetailBtn.style.lineHeight = '14px';
nextFishDetailBtn.style.fontSize = '12px';
nextFishDetailBtn.style.color = '#555';
nextFishDetailBtn.style.cursor = 'pointer';
nextFishDetailBtn.style.transition = 'background-color 0.2s, color 0.2s';
fishDetailControls.appendChild(nextFishDetailBtn);

const fishDetailTitle = document.createElement('div');
fishDetailTitle.id = 'fish-detail-title';
fishDetailTitle.style.position = 'absolute';
fishDetailTitle.style.top = '20px';
fishDetailTitle.style.left = '60%';
fishDetailTitle.style.transform = 'translateX(-50%)';
fishDetailTitle.style.fontFamily = 'Aclonica, Arial, sans-serif';
fishDetailTitle.style.fontSize = '0px';
fishDetailTitle.style.color = '#fff';
fishDetailControls.appendChild(fishDetailTitle);

const fishDetailBackground = document.createElement('img');
fishDetailBackground.id = 'fish-detail-background';
fishDetailBackground.style.width = '100%';
fishDetailBackground.style.height = '100%';
fishDetailBackground.style.position = 'absolute';
fishDetailBackground.style.top = '0';
fishDetailBackground.style.left = '0';
fishDetailBackground.style.zIndex = '5';
fishDetailOverlay.appendChild(fishDetailBackground);
// Fish Background Data
const fishBackgrounds = [
    { 
        src: '/fish/bg1.gif', 
        caughtSrc: '/fish/bg1unlocked.gif',
        title: 'Channel Catfish', 
        baseChance: 0.05, 
        conditions: ['lakeFish1Checked', 'luckyCoinActive'], 
        bonusValue: 25, 
        reelInImage: '/fish/reel-in-catfish.gif', 
        haveImage: '/fish/havecatfish.gif',
        fishForce: 3,
        flair: 'CatfishPFP'
    },
    { 
        src: '/fish/bg2.gif', 
        caughtSrc: '/fish/bg2unlocked.gif',
        title: 'Largemouth Bass', 
        baseChance: 0.10, 
        conditions: ['lakeFish1Checked', 'luckyCoinActive'], 
        bonusValue: 10, 
        reelInImage: '/fish/reel-in-largemouth.gif', 
        haveImage: '/fish/havelargemouth.gif',
        fishForce: 3,
        flair: 'LargemouthPFP'
    },
    { 
        src: '/fish/bg3.gif', 
        caughtSrc: '/fish/bg3unlocked.gif',
        title: 'Common Carp', 
        baseChance: 0.30, 
        conditions: ['lakeFish1Checked', 'mysteryBaitActive'], 
        bonusValue: 25, 
        reelInImage: '/fish/reel-in-carp.gif', 
        haveImage: '/fish/havecarp.gif',
        fishForce: 2,
        flair: 'CarpPFP'
    },
    { 
        src: '/fish/bg4.gif', 
        caughtSrc: '/fish/bg4unlocked.gif',
        title: 'Black Crappie', 
        baseChance: 0.15, 
        conditions: ['lakeFish1Checked'], 
        bonusValue: 5, 
        reelInImage: '/fish/reel-in-blackcrappie.gif', 
        haveImage: '/fish/haveblackcrappie.gif',
        fishForce: 1,
        flair: 'BlackCrappiePFP'
    },
    { 
        src: '/fish/bg5.gif', 
        caughtSrc: '/fish/bg5unlocked.gif',
        title: 'Pumpkinseed', 
        baseChance: 0.20, 
        conditions: ['lakeFish1Checked'], 
        bonusValue: 5, 
        reelInImage: '/fish/reel-in-pumpkin.gif', 
        haveImage: '/fish/havepumpkin.gif',
        fishForce: 1,
        flair: 'PumpkinseedPFP'
    },
    { 
        src: '/fish/bg6.gif', 
        caughtSrc: '/fish/bg6unlocked.gif',
        title: 'Yellow Perch', 
        baseChance: 0.20, 
        conditions: ['lakeFish1Checked'], 
        bonusValue: 5, 
        reelInImage: '/fish/reel-in-perch.gif', 
        haveImage: '/fish/haveperch.gif',
        fishForce: 1,
        flair: 'PerchPFP'
    }
];

const fishUnlockSound = new Audio('fishunlock.mp3');


function loadCompendiumState() {
    const caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
    fishBackgrounds.forEach(fish => {
        const titleElement = document.getElementById(`title-${fish.title.toLowerCase().replace(' ', '-')}`);
        const overlayElement = document.getElementById(`overlay-${fish.title.toLowerCase().replace(' ', '-')}`);
        if (caughtFishList.includes(fish.title)) {
            if (titleElement) titleElement.textContent = fish.title;
            if (overlayElement) {
                overlayElement.style.backgroundImage = `url(${fish.caughtSrc})`;
                overlayElement.style.display = 'block';
            }
        } else {
            if (titleElement) titleElement.textContent = '???';
            if (overlayElement) overlayElement.style.display = 'none';
        }
    });
}

fishDetailUnlockedOverlay.addEventListener('click', () => {
    try {
        if (typeof chattable === 'undefined' || !chattable.setFlair) {
            console.warn('Chattable is not available or setFlair is undefined');
            return;
        }

        const caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
        const currentFish = fishBackgrounds[currentFishIndex];

        if (!caughtFishList.includes(currentFish.title)) {
            console.log(`Cannot set flair: ${currentFish.title} is not unlocked`);
            return;
        }

        const currentFlair = chattable.user?.flair || 'none';
        let newFlair = currentFlair === currentFish.flair ? 'none' : currentFish.flair;

        // If turning off a lake fish flair and streak >= 5, set to flames
        if (newFlair === 'none' && streak >= 5) {
            newFlair = 'flames';
        }

        // Set the flair and save to localStorage before sending chat message
        chattable.setFlair(newFlair);
        const lakeFishFlairs = fishBackgrounds.map(fish => fish.flair); // Define lakeFishFlairs
        localStorage.setItem('lakeFishFlair', lakeFishFlairs.includes(newFlair) ? newFlair : 'none');

        // Send chat message after setting flair
        sendChatMessage(`changed their flair to ${newFlair === currentFish.flair ? currentFish.flair : (newFlair === 'flames' ? 'flames' : 'default')}!`, 'botstyle');
    } catch (e) {
        console.error('Error toggling flair:', e);
    }
});

// Update showFishDetailOverlay to ensure overlay is clickable
function showFishDetailOverlay(index) {
    fishDetailOverlay.style.display = 'block';
    fishDetailOverlay.style.zIndex = '6';
    fishDetailControls.style.display = 'block';
    fishDetailControls.style.opacity = '1';
    fishDetailControls.style.zIndex = '8';
    const fish = fishBackgrounds[index];
    const caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
    const isCaught = caughtFishList.includes(fish.title);
    fishDetailBackground.src = fish.src;
    
    if (isCaught) {
        fishDetailUnlockedOverlay.style.display = 'block';
        fishDetailUnlockedOverlay.style.opacity = '1';
        fishDetailUnlockedOverlay.style.pointerEvents = 'auto'; // Ensure clickable
        fishDetailUnlockedBackground.src = fish.caughtSrc;
    } else {
        fishDetailUnlockedOverlay.style.display = 'none';
        fishDetailUnlockedOverlay.style.opacity = '0';
        fishDetailUnlockedOverlay.style.pointerEvents = 'none'; // Prevent clicks
    }
    
    fishDetailTitle.textContent = fish.title;
    currentFishIndex = index;
}

function updateLockOverlay() {
    const unlockCost = 200; // Match with event listener
    if (fishCount >= unlockCost) {
        lockOverlayLake1.classList.add('enough-fish');
    } else {
        lockOverlayLake1.classList.remove('enough-fish');
    }
}

if (isLakeFish1Unlocked) {
  lockOverlayLake1.style.display = 'none';
  lakeFish1Checkbox.disabled = false; 
} else {
  lakeFish1Checkbox.disabled = true; 
}
updateLockOverlay();

lockOverlayLake1.addEventListener('click', () => {
    const unlockCost = 200; 
    if (fishCount >= unlockCost && !isLakeFish1Unlocked) {
        fishCount -= unlockCost;
        fishCountDisplay.textContent = fishCount; 
        saveFishCount(); 
        isLakeFish1Unlocked = true;
        localStorage.setItem('isLakeFish1Unlocked', 'true');
        lockOverlayLake1.style.display = 'none';
        lakeFish1Checkbox.disabled = false;
        saveUnlockedStates(); 
        sendChatMessage(`unlocked the Lake Fish category for ${unlockCost} fish!`, "botstyle"); 
    } else if (fishCount < unlockCost) {
        console.log(`Insufficient fish: ${fishCount} available, ${unlockCost} required`);
        
    }
});


function onFishBalanceChange() {
  updateLockOverlay();
  localStorage.setItem('fishCount', fish); 
}

onFishBalanceChange();


compendiumBtn.addEventListener('click', () => {
  if (isLakeFish1Unlocked && lakeFish1Checkbox.checked) {

    document.getElementById('fish-detail-overlay').style.display = 'block';
  }
});


document.addEventListener('DOMContentLoaded', () => {
    loadCompendiumState();
});

const totalLakeFishChance = fishBackgrounds.reduce((sum, fish) => sum + fish.baseChance, 0); // 1.0
fishBackgrounds.forEach(fish => fish.normalizedChance = fish.baseChance / totalLakeFishChance);

let bonusTextElement = null;

function showBonusText(amount, x, y) {
    if (!bonusTextElement) {
        bonusTextElement = document.createElement('div');
        bonusTextElement.style.position = 'absolute';
        bonusTextElement.style.color = 'green';
        bonusTextElement.style.fontSize = '14px';
        bonusTextElement.style.zIndex = '10';
        bonusTextElement.style.pointerEvents = 'none';
        document.body.appendChild(bonusTextElement);
    }

    bonusTextElement.textContent = `+${amount} Fish`;
    bonusTextElement.style.left = `${x}px`;
    bonusTextElement.style.top = `${y}px`;
    bonusTextElement.style.display = 'block';
    bonusTextElement.style.animation = 'none'; // Reset animation
    setTimeout(() => {
        bonusTextElement.style.animation = 'floatUp 1s ease-out forwards';
    }, 10); // Brief delay to ensure reset
    setTimeout(() => {
        bonusTextElement.style.display = 'none';
    }, 5000);
}

function getBonusPosition() {
    const fishCountRect = fishCountDisplay.getBoundingClientRect();
    return { x: fishCountRect.right + 10, y: fishCountRect.top - 10 };
}

function showFishDetailOverlay(index) {
    fishDetailOverlay.style.display = 'block';
    fishDetailOverlay.style.zIndex = '6'; // Above compendium
    fishDetailControls.style.display = 'block'; // Show controls
    fishDetailControls.style.opacity = '1';
    fishDetailControls.style.zIndex = '8'; // Above fish detail overlay
    const fish = fishBackgrounds[index];
    const caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
    const isCaught = caughtFishList.includes(fish.title);
    fishDetailBackground.src = fish.src;
    
    if (isCaught) {
        fishDetailUnlockedOverlay.style.display = 'block';
        fishDetailUnlockedOverlay.style.opacity = '1';
        fishDetailUnlockedBackground.src = fish.caughtSrc; // Use the unlocked image
    } else {
        fishDetailUnlockedOverlay.style.display = 'none';
        fishDetailUnlockedOverlay.style.opacity = '0';
    }
    
    fishDetailTitle.textContent = fish.title;
    currentFishIndex = index;
}


function hideFishDetailOverlay() {
    fishDetailOverlay.style.opacity = '0';
    fishDetailUnlockedOverlay.style.opacity = '0';
    fishDetailControls.style.opacity = '0';
    setTimeout(() => {
        fishDetailOverlay.style.display = 'none';
        fishDetailUnlockedOverlay.style.display = 'none';
        fishDetailControls.style.display = 'none';
    }, 500);
}

compendiumIcon.addEventListener('click', () => {
    if (isCompendiumCollected) {
        openFishCompendium();
    }
});

function showNextFish() {
    currentFishIndex = (currentFishIndex + 1) % fishBackgrounds.length;
    const fish = fishBackgrounds[currentFishIndex];
    const caughtFishList = JSON.parse(localStorage.getItem('caughtFishList') || '[]');
    const isCaught = caughtFishList.includes(fish.title);
    
    fishDetailBackground.src = fish.src; // Always show locked background
    if (isCaught) {
        fishDetailUnlockedOverlay.style.display = 'block';
        fishDetailUnlockedOverlay.style.opacity = '1';
        fishDetailUnlockedBackground.src = fish.caughtSrc; // Use the unlocked image
    } else {
        fishDetailUnlockedOverlay.style.display = 'none';
        fishDetailUnlockedOverlay.style.opacity = '0';
    }
    
    fishDetailTitle.textContent = fish.title;
    fishDetailControls.style.display = 'block';
    pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
}

// Event Listeners for Fish Detail Overlay
exitFishDetailBtn.addEventListener('click', hideFishDetailOverlay);
nextFishDetailBtn.addEventListener('click', showNextFish);

exitFishDetailBtn.addEventListener('mouseover', () => {
    exitFishDetailBtn.style.backgroundColor = '#d3d3d3';
    exitFishDetailBtn.style.color = '#333';
});
exitFishDetailBtn.addEventListener('mouseout', () => {
    exitFishDetailBtn.style.backgroundColor = 'yellow';
    exitFishDetailBtn.style.color = '#555';
});

nextFishDetailBtn.addEventListener('mouseover', () => {
    nextFishDetailBtn.style.backgroundColor = '#d3d3d3';
    nextFishDetailBtn.style.color = '#333';
});
nextFishDetailBtn.addEventListener('mouseout', () => {
    nextFishDetailBtn.style.backgroundColor = 'yellow';
    nextFishDetailBtn.style.color = '#555';
});

// Hook into Lake Fish 1 Checkbox
const compendiumList = document.getElementById('compendium-list');
if (compendiumList) {
    compendiumList.addEventListener('click', (e) => {
        const button = e.target.closest('.compendium-btn');
        if (button && button.textContent === 'Lake Fish') {
            console.log('Lake Fish button clicked');
            showFishDetailOverlay(0); // Show first fish in the list
            fishcompendiumOverlay.style.display = 'block'; // Ensure compendium stays visible
            closeActiveItemBtn.style.display = 'block';
        }
    });
} else {
    console.error('Compendium list not found');
}

minimanualOverlay.addEventListener('click', () => {
    if (!isManualCollected && isBonus1Unlocked) {
        isManualCollected = true;
        minimanualOverlay.style.display = 'none';
        manualItem.style.display = 'block';
        const slot = inventoryGrid.querySelector('.inventory-slot[data-row="0"][data-col="0"]');
        if (slot) {
            snapToSlot(manualItem, slot);
            manualSlot = { row: 0, col: 0 };
        }
        collectedSound.play().catch(e => console.error('Collected sound failed:', e));
        saveUnlockedStates();
    }
});

closeBackpackBtn.addEventListener('click', () => {
    inventoryGrid.style.display = 'none';
    document.getElementById('inventory-closed').style.display = 'none';
    document.getElementById('inventory-background').style.display = 'none';
    closeBackpackBtn.style.display = 'none';
    whiteOverlayInventory.style.display = 'block';
    whiteOverlayInventory.style.opacity = '1';
    isBackpackCollected = false;
    if (isBonus1Unlocked) {
        backpackOverlay.style.display = 'block';
        backpackIcon.style.display = 'block';
    }
    saveUnlockedStates();
});

manualItem.addEventListener('click', () => {
    closeActiveOverlays();
    manualContainer.style.display = 'block';
    closeActiveItemBtn.style.display = 'block';
    showManualPage(currentManualPage);
    pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
});

prevPageBtn.addEventListener('click', () => {
    console.log('Previous button clicked, current page:', currentManualPage);
    if (currentManualPage > 1) {
        showManualPage(currentManualPage - 1);
        pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
    }
});

nextPageBtn.addEventListener('click', () => {
    console.log('Next button clicked, current page:', currentManualPage);
    if (currentManualPage < totalManualPages) {
        showManualPage(currentManualPage + 1);
        pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
    }
});

/////////

///////////////////////////////////////////////////////////////////////////////
///oooo   o8o               o8o                                                                 oooo        .o8  
///`888   `"'               `"'                                                                 `888       "888  
/// 888  oooo  oooo    ooo oooo  ooo. .oo.    .oooooooo     oooo oooo    ooo  .ooooo.  oooo d8b  888   .oooo888  
/// 888  `888   `88.  .8'  `888  `888P"Y88b  888' `88b       `88. `88.  .8'  d88' `88b `888""8P  888  d88' `888  
/// 888   888    `88..8'    888   888   888  888   888        `88..]88..8'   888   888  888      888  888   888  
/// 888   888     `888'     888   888   888  `88bod8P'  .o.    `888'`888'    888   888  888      888  888   888  
///o888o o888o     `8'     o888o o888o o888o `8oooooo.  Y8P     `8'  `8'     `Y8bod8P' d888b    o888o `Y8bod88P" 
///                                          d"     YD                                                           
///                                          "Y88888P'                                                           
                                                                                                


///this section just deals with tiny events and interactions, like the daily eagle egg, and other things that make the game world feel more alive





function randomFishSwim() {
    if (isBonus2Unlocked) {
        setForeground2('fishswim.gif');
        setTimeout(() => setForeground2('idleswim.gif'), 800);
        setTimeout(randomFishSwim, randomTime(2, 10));
    }
}
function initializeEgg() {
    const eggClickedTime = localStorage.getItem('eggClickedTime');
    const now = Date.now();
    const oneDayInMs = 24 * 60 * 60 * 1000; 

    if (eggClickedTime) {
        const timeSinceClick = now - parseInt(eggClickedTime);
        if (timeSinceClick < oneDayInMs) {
            
            eggOverlay.style.display = 'none';
            
            setTimeout(() => {
                showEgg();
            }, oneDayInMs - timeSinceClick);
        } else {
            
            showEgg();
        }
    } else {
        
        showEgg();
    }
}

function showEgg() {
    eggOverlay.style.display = 'block';
    localStorage.removeItem('eggClickedTime'); 
}

function hideEgg() {
    eggOverlay.style.display = 'none';
    localStorage.setItem('eggClickedTime', Date.now().toString());
    eagle2Sound.play().catch(e => console.error('Collected sound failed:', e));
    sendChatMessage(`RAHHHHH!`, "eagle");
    sendChatMessage(`stole an eagle's egg!`, "botstyle");
    setTimeout(() => chattable.setFlair("none"), 1);
}

eggOverlay.addEventListener('click', () => {
    if (eggOverlay.style.display !== 'none') { 
        hideEgg();
        // Optional: Add some reward or effect here e.g. some egg item
        // fishCount += 1;
        // fishCountDisplay.textContent = fishCount;
        // saveFishCount();
    }
});
function initializeCrate() {
    const crateClickedTime = localStorage.getItem('crateClickedTime');
    const now = Date.now();
    const oneDayInMs = 24 * 60 * 60 * 1000; 

    if (crateClickedTime) {
        const timeSinceClick = now - parseInt(crateClickedTime);
        if (timeSinceClick < oneDayInMs) {
            
            crateOverlay.style.display = 'none';
            
            setTimeout(() => {
                showCrate();
            }, oneDayInMs - timeSinceClick);
        } else {
            
            showCrate();
        }
    } else {
        
        showCrate();
    }
}

function showCrate() {
    crateOverlay.style.display = 'block';
    localStorage.removeItem('crateClickedTime'); 
}

function hideCrate() {
    crateOverlay.style.display = 'none';
    localStorage.setItem('crateClickedTime', Date.now().toString());
    saleSound.play().catch(e => console.error('Collected sound failed:', e));
    setTimeout(() => chattable.setFlair("none"), 1);
}

crateOverlay.addEventListener('click', () => {
    if (crateOverlay.style.display !== 'none') { 
        
        const fishAmount = Math.floor(Math.random() * (12 - 3 + 1)) + 3;
        
        
        fishCount += fishAmount;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();

        
        const floatText = document.createElement('div');
        floatText.textContent = `+${fishAmount} fish!`;
        floatText.style.position = 'absolute';
        floatText.style.color = 'green';
        floatText.style.fontFamily = 'Helvetica';
        floatText.style.fontSize = '12px';
        floatText.style.zIndex = '10';
        
        
        const mouseX = event.clientX;
        const mouseY = event.clientY;
        floatText.style.left = `${mouseX}px`;
        floatText.style.top = `${mouseY}px`;
        
        document.body.appendChild(floatText);

        
        let opacity = 1;
        let positionY = mouseY;
        const animation = setInterval(() => {
            positionY -= 1; // Move up
            opacity -= 0.02; // Fade out
            floatText.style.top = `${positionY}px`;
            floatText.style.opacity = opacity;

            if (opacity <= 0) {
                clearInterval(animation);
                floatText.remove();
            }
        }, 16); // ~60fps

        
        hideCrate();
        sendChatMessage(`found a crate of ${fishAmount} fish washed ashore!`, "botstyle");
    }
});


///////////////////
/////////////////////////////////////////////////////

///   .oooooo..o ooooo   ooooo   .oooooo.   ooooooooo.   
///   d8P'    `Y8 `888'   `888'  d8P'  `Y8b  `888   `Y88. 
///   Y88bo.       888     888  888      888  888   .d88' 
///    `"Y8888o.   888ooooo888  888      888  888ooo88P'  
///        `"Y88b  888     888  888      888  888         
///   oo     .d8P  888     888  `88b    d88'  888         
///   8""88888P'  o888o   o888o  `Y8bood8P'  o888o        
                                                 
/////////////////////////////////////////////////////
///////////////////




const shopOverlay = document.createElement('div');
shopOverlay.id = 'shop-overlay';
shopOverlay.style.position = 'absolute';
shopOverlay.style.top = '0';
shopOverlay.style.left = '0';
shopOverlay.style.width = '256px';
shopOverlay.style.height = '256px';
shopOverlay.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
shopOverlay.style.zIndex = '5';
shopOverlay.style.display = 'none';
shopOverlay.style.transition = 'opacity 0.5s ease';
shopModule.appendChild(shopOverlay);

const closeShopBtn = document.createElement('div');
closeShopBtn.id = 'close-shop-btn';
closeShopBtn.textContent = 'x';
closeShopBtn.style.position = 'absolute';
closeShopBtn.style.top = '0%';
closeShopBtn.style.left = '4%';
closeShopBtn.style.transform = 'translateX(-50%)';
closeShopBtn.style.width = '16px';
closeShopBtn.style.height = '16px';
closeShopBtn.style.backgroundColor = 'yellow';
closeShopBtn.style.border = '1px solid #555';
closeShopBtn.style.borderRadius = '3px';
closeShopBtn.style.textAlign = 'center';
closeShopBtn.style.lineHeight = '14px';
closeShopBtn.style.fontSize = '12px';
closeShopBtn.style.color = '#555';
closeShopBtn.style.cursor = 'url("hover.gif"), pointer';
closeShopBtn.style.zIndex = '6';
closeShopBtn.style.transition = 'background-color 0.2s, quenched-color 0.2s';
shopOverlay.appendChild(closeShopBtn);

const nextShopBtn = document.createElement('div');
nextShopBtn.id = 'next-shop-btn';
nextShopBtn.textContent = '>';
nextShopBtn.style.position = 'absolute';
nextShopBtn.style.top = '0%';
nextShopBtn.style.right = '4%';
nextShopBtn.style.width = '25px';
nextShopBtn.style.height = '25px';
nextShopBtn.style.backgroundColor = 'yellow';
nextShopBtn.style.border = '1px solid #555';
nextShopBtn.style.borderRadius = '3px';
nextShopBtn.style.textAlign = 'center';
nextShopBtn.style.lineHeight = '14px';
nextShopBtn.style.fontSize = '12px';
nextShopBtn.style.color = '#555';
nextShopBtn.style.cursor = 'url("hover.gif"), pointer';
nextShopBtn.style.zIndex = '6';
nextShopBtn.style.transition = 'background-color 0.2s, color 0.2s';
shopOverlay.appendChild(nextShopBtn);

const shopOverlays = [
    {
        id: 'shop-welcome',
        content: `<img src="shop-welcome.gif" style="width: 256px; height: 256px;">`,
        active: true
    },
    {
        id: 'trap-shop',
        content: `
            <img src="trap_shop.gif" id="trap-shop-item" style="width: 256px; height: 256px;">
            <div id="insufficient-funds-overlay" style="position: absolute; top: 0; left: 0; width: 256px; height: 256px; background-color: rgba(128, 128, 128, 0.7); display: none; justify-content: center; align-items: center; color: white; font-family: Aclonica; font-size: 12px; text-align: center; z-index: 6;">You don't have enough fish to trade for this item.</div>
        `,
        active: true
    },
    {
        id: 'coin-shop',
        content: `
            <img src="coinshop.gif" id="coin-shop-item" style="width: 256px; height: 256px;">
            <div id="coin-insufficient-funds-overlay" style="position: absolute; top: 0; left: 0; width: 256px; height: 256px; background-color: rgba(128, 128, 128, 0.7); display: none; justify-content: center; align-items: center; color: white; font-family: Aclonica; font-size: 12px; text-align: center; z-index: 6;">You don't have enough fish to trade for this item.</div>
        `,
        active: !isCoinShopPurchased
    },
    {
        id: 'mystery-shop',
        content: `
            <img src="MysteryShop.gif" id="mystery-shop-item" style="width: 256px; height: 256px;">
            <div id="mystery-insufficient-funds-overlay" style="position: absolute; top: 0; left: 0; width: 256px; height: 256px; background-color: rgba(128, 128, 128, 0.7); display: none; justify-content: center; align-items: center; color: white; font-family: Aclonica; font-size: 12px; text-align: center; z-index: 6;">You don't have enough fish to trade for this item.</div>
        `,
        active: true 
    },
    {
        id: 'magazine-shop',
        content: `
            <img src="magshop.gif" id="magazine-shop-item" style="width: 256px; height: 256px;">
            <div id="magazine-insufficient-funds-overlay" style="position: absolute; top: 0; left: 0; width: 256px; height: 256px; background-color: rgba(128, 128, 128, 0.7); display: none; justify-content: center; align-items: center; color: white; font-family: Aclonica; font-size: 12px; text-align: center; z-index: 6;">You don't have enough fish to trade for this item.</div>
        `,
        active: !isMagazinePurchased
    }
];
let currentShopIndex = 0;

function showShopOverlay(index) {
    shopOverlay.innerHTML = shopOverlays[index].content;
    shopOverlay.appendChild(closeShopBtn);
    shopOverlay.appendChild(nextShopBtn);
    shopOverlay.style.display = 'block';
    shopOverlay.style.opacity = '1';
    if (shopOverlays[index].id === 'trap-shop') {
        const trapShopItem = document.getElementById('trap-shop-item');
        trapShopItem.addEventListener('mouseover', () => trapShopItem.style.cursor = 'url("hover.gif"), pointer');
        trapShopItem.addEventListener('click', buyFishTrap);
    } else if (shopOverlays[index].id === 'coin-shop') {
        const coinShopItem = document.getElementById('coin-shop-item');
        coinShopItem.addEventListener('mouseover', () => coinShopItem.style.cursor = 'url("hover.gif"), pointer');
        coinShopItem.addEventListener('click', buyCoinShop);
    } else if (shopOverlays[index].id === 'mystery-shop') {
        const mysteryShopItem = document.getElementById('mystery-shop-item');
        mysteryShopItem.addEventListener('mouseover', () => mysteryShopItem.style.cursor = 'url("hover.gif"), pointer');
        mysteryShopItem.addEventListener('click', buyMysteryBait);
    } else if (shopOverlays[index].id === 'magazine-shop') {
        const magazineShopItem = document.getElementById('magazine-shop-item');
        magazineShopItem.addEventListener('mouseover', () => magazineShopItem.style.cursor = 'url("hover.gif"), pointer');
        magazineShopItem.addEventListener('click', buyMagazine);
    }
}

function hideShopOverlay() {
    shopOverlay.style.opacity = '0';
    setTimeout(() => shopOverlay.style.display = 'none', 500);
}

function showNextShopOverlay() {
    let nextIndex = currentShopIndex;
    do {
        nextIndex = (nextIndex + 1) % shopOverlays.length;
    } while (!shopOverlays[nextIndex].active && nextIndex !== currentShopIndex);
    if (shopOverlays[nextIndex].active) {
        currentShopIndex = nextIndex;
        showShopOverlay(currentShopIndex);
    } else {
        hideShopOverlay();
    }
}

shopModule.addEventListener('dblclick', () => {
    if (isShopUnlocked && shopOverlay.style.display === 'none') {
        currentShopIndex = 0;
        while (!shopOverlays[currentShopIndex].active && currentShopIndex < shopOverlays.length) {
            currentShopIndex++;
        }
        if (currentShopIndex < shopOverlays.length) {
            showShopOverlay(currentShopIndex);
        }
        shopEntrySound.play().catch(e => console.error('Level 5 sound failed:', e));
    }
});

closeShopBtn.addEventListener('click', hideShopOverlay);

nextShopBtn.addEventListener('click', showNextShopOverlay);

closeShopBtn.addEventListener('mouseover', () => {
    closeShopBtn.style.backgroundColor = '#d3d3d3';
    closeShopBtn.style.color = '#333';
});
closeShopBtn.addEventListener('mouseout', () => {
    closeShopBtn.style.backgroundColor = 'yellow';
    closeShopBtn.style.color = '#555';
});

nextShopBtn.addEventListener('mouseover', () => {
    nextShopBtn.style.backgroundColor = '#d3d3d3';
    nextShopBtn.style.color = '#333';
});
nextShopBtn.addEventListener('mouseout', () => {
    nextShopBtn.style.backgroundColor = 'yellow';
    nextShopBtn.style.color = '#555';
});



///////////////////
/////////////////////////////////////////////////////

///   ooooo ooooooooooooo oooooooooooo ooo        ooooo  .oooooo..o 
///   `888' 8'   888   `8 `888'     `8 `88.       .888' d8P'    `Y8 
///    888       888       888          888b     d'888  Y88bo.      
///    888       888       888oooo8     8 Y88. .P  888   `"Y8888o.  
///    888       888       888    "     8  `888'   888       `"Y88b 
///    888       888       888       o  8    Y     888  oo     .d8P 
///   o888o     o888o     o888ooooood8 o8o        o888o 8""88888P' 

/////////////////////////////////////////////////////
///////////////////


function buyMagazine() {
    const insufficientFundsOverlay = document.getElementById('magazine-insufficient-funds-overlay');
    if (fishCount >= 100) {
        fishCount -= 100;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isMagazinePurchased = true;
        localStorage.setItem('isMagazinePurchased', 'true');
        saleSound.play().catch(e => console.error('Sale sound failed:', e));
        sendChatMessage("purchased a Fishing Magazine!", "botstyle");

        const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot'))
            .find(slot => !slot.querySelector('.inventory-item'));
        if (emptySlot) {
            addMagazineToSlot(emptySlot);
            magazineSlot = { row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col) };
            localStorage.setItem('magazineSlot', JSON.stringify(magazineSlot));
        } else {
            console.error("No empty slots available to add Fishing Magazine!");
        }

        shopOverlays.find(overlay => overlay.id === 'magazine-shop').active = false;
        saveUnlockedStates();
        hideShopOverlay();
    } else {
        insufficientFundsOverlay.style.display = 'flex';
        insufficientFundsOverlay.textContent = "You need at least 100 fish to purchase it.";
    }
}

function addMagazineToSlot(slot) {
    const magazineItem = document.createElement('img');
    magazineItem.className = 'inventory-item';
    magazineItem.id = 'magazine-item';
    magazineItem.src = 'zinemini.gif';
    magazineItem.alt = 'Magazine';
    magazineItem.draggable = true;

    magazineItem.addEventListener('dragstart', (e) => {
        draggedItem = magazineItem;
        setTimeout(() => draggedItem.style.display = 'none', 0);
    });
    magazineItem.addEventListener('dragend', (e) => {
        draggedItem.style.display = 'block';
        draggedItem = null;
    });
    magazineItem.addEventListener('click', () => {
        closeActiveOverlays();
        magazineContainer.style.display = 'block';
        showMagazinePage(currentMagazinePage);
        closeActiveItemBtn.style.display = 'block';
        pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
    });

    snapToSlot(magazineItem, slot);
    createTooltip(magazineItem, 'Magazine');
}

const magazineContainer = document.createElement('div');
magazineContainer.id = 'magazine-container';
magazineContainer.style.display = 'none';
magazineContainer.style.position = 'relative';
magazineContainer.style.width = '100%';
magazineContainer.style.height = '100%';

const magazinePage1 = document.createElement('div');
magazinePage1.id = 'magazine-page-1';
magazinePage1.className = 'magazine-page';
magazinePage1.innerHTML = `
    <img src="zine1.gif" alt="Magazine Page 1" class="magazine-graphic" style="width: 100%; height: 100%;">
`;

const magazinePage2 = document.createElement('div');
magazinePage2.id = 'magazine-page-2';
magazinePage2.className = 'magazine-page';
magazinePage2.style.display = 'none';
magazinePage2.innerHTML = `
    <img src="zine2.gif" alt="Magazine Page 2" class="magazine-graphic" style="width: 100%; height: 100%;">
    <div id="topdog-div" style="position: absolute; top: 40px; left: 40px; width: 80px; height: 50px; cursor: url('hover.gif'), pointer;"></div>
    <div id="topstreak-div" style="position: absolute; top: 90px; left: 110px; width: 80px; height: 40px; cursor: url('hover.gif'), pointer;"></div>
    <div id="richest-div" style="position: absolute; top: 130px; left: 40px; width: 70px; height: 50px; cursor: url('hover.gif'), pointer;"></div>
`;

const pageTurnBtn = document.createElement('button');
pageTurnBtn.id = 'page-turn-btn';
pageTurnBtn.className = 'magazine-nav-btn';
pageTurnBtn.textContent = '>';
pageTurnBtn.style.position = 'absolute';
pageTurnBtn.style.bottom = '10px';
pageTurnBtn.style.right = '10px';
pageTurnBtn.style.width = '25px';
pageTurnBtn.style.height = '25px';
pageTurnBtn.style.backgroundColor = 'yellow';
pageTurnBtn.style.border = '1px solid #555';
pageTurnBtn.style.borderRadius = '3px';
pageTurnBtn.style.display = 'flex'; // Use flexbox
pageTurnBtn.style.alignItems = 'center'; // Center vertically
pageTurnBtn.style.justifyContent = 'center'; // Center horizontally
pageTurnBtn.style.fontSize = '12px';
pageTurnBtn.style.color = '#555';
pageTurnBtn.style.zIndex = '3';
pageTurnBtn.style.transition = 'background-color 0.2s, color 0.2s';
pageTurnBtn.style.cursor = 'url("hover.gif"), pointer';
pageTurnBtn.style.boxSizing = 'border-box';

magazineContainer.appendChild(magazinePage1);
magazineContainer.appendChild(magazinePage2);
magazineContainer.appendChild(pageTurnBtn);
activeItemContent.appendChild(magazineContainer);

const totalMagazinePages = 2;

function showMagazinePage(pageNumber) {
    magazinePage1.style.display = pageNumber === 1 ? 'block' : 'none';
    magazinePage2.style.display = pageNumber === 2 ? 'block' : 'none';
    pageTurnBtn.textContent = pageNumber === 1 ? '>>>' : '<<<';
    currentMagazinePage = pageNumber;
    localStorage.setItem('currentMagazinePage', currentMagazinePage);
    if (pageNumber === 2) {
        initializeMagazineDivs();
    }
}

pageTurnBtn.addEventListener('click', () => {
    showMagazinePage(currentMagazinePage === 1 ? 2 : 1);
    pageTurnSound.play().catch(e => console.error('Page turn sound failed:', e));
});

function initializeMagazineDivs() {
    if (isMagazineDivsInitialized) {
        console.log('Magazine divs already initialized, skipping');
        return;
    }

    const topdogDiv = document.getElementById('topdog-div');
    const topstreakDiv = document.getElementById('topstreak-div');
    const richestDiv = document.getElementById('richest-div');

    if (!topdogDiv || !topstreakDiv || !richestDiv) {
        console.error('One or more magazine divs not found:', { topdogDiv, topstreakDiv, richestDiv });
        return;
    }

    createTooltip(topdogDiv, 'Best Fishers');
    createTooltip(topstreakDiv, 'Best Streak');
    createTooltip(richestDiv, 'Top Balance');

    topdogDiv.addEventListener('click', () => {
        showTopFishers();
    });

    topstreakDiv.addEventListener('click', () => {
        showTopStreak();
    });

    richestDiv.addEventListener('click', () => {
        showTopBalance();
    });

    console.log('Magazine divs initialized');
    isMagazineDivsInitialized = true;
}

function buyMysteryBait() {
    const insufficientFundsOverlay = document.getElementById('mystery-insufficient-funds-overlay');
    if (fishCount >= 50) {
        fishCount -= 50;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        mysteryBaitCountInInventory++;
        console.log(`Mystery Bait purchased, new count: ${mysteryBaitCountInInventory}`);
        updateMysteryBaitInInventory();
        saleSound.play().catch(e => console.error('Sale sound failed:', e));
        sendChatMessage("purchased Mystery Bait!", "botstyle");
        insufficientFundsOverlay.style.display = 'none';
    } else {
        insufficientFundsOverlay.style.display = 'flex';
    }
}
function updateMysteryBaitInInventory() {
    console.log(`updateMysteryBaitInInventory called, mysteryBaitCountInInventory: ${mysteryBaitCountInInventory}`);
    let mysteryBaitContainer = inventoryGrid.querySelector('.inventory-slot .inventory-item[src="mbait.gif"]')?.parentElement;
    if (mysteryBaitContainer && mysteryBaitContainer.querySelector('.inventory-item')) {
        const stackCount = mysteryBaitContainer.querySelector('.stack-count');
        stackCount.textContent = mysteryBaitCountInInventory;
        stackCount.style.display = mysteryBaitCountInInventory >= 2 ? 'block' : 'none';
        updateTooltip(mysteryBaitContainer.querySelector('.inventory-item'), 'Mystery Bait');
    } else {
        const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot')).find(slot => !slot.querySelector('.inventory-item'));
        if (emptySlot) {
            addMysteryBaitToSlot(emptySlot, mysteryBaitCountInInventory);
            mysteryBaitSlot = {row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col)};
            console.log(`New Mystery Bait added to slot: row ${mysteryBaitSlot.row}, col ${mysteryBaitSlot.col}`);
        } else {
            console.error("No empty slots available to add Mystery Bait!");
            mysteryBaitCountInInventory--;
        }
    }
    saveUnlockedStates();
}
function consumeMysteryBait(e) {
    const now = Date.now();
    if (mysteryBaitCooldownEnd > now) {
        console.log('Mystery Bait on cooldown, cannot use yet.');
        return;
    }

    const mysteryBaitContainer = e.currentTarget;
    const slot = mysteryBaitContainer.parentElement;


    mysterySound.play().catch(e => console.error('Mystery sound failed:', e));
    mysteryBaitCountInInventory--;
    if (mysteryBaitCountInInventory > 0) {
        const stackCount = mysteryBaitContainer.querySelector('.stack-count');
        stackCount.textContent = mysteryBaitCountInInventory;
        stackCount.style.display = mysteryBaitCountInInventory >= 2 ? 'block' : 'none';
        updateTooltip(mysteryBaitContainer.querySelector('.inventory-item'), 'Mystery Bait');
    } else {
        slot.removeChild(mysteryBaitContainer);
        mysteryBaitSlot = null;
    }


    isMysteryBaitActive = true;
    setTimeout(() => {
        isMysteryBaitActive = false;
        console.log('Mystery Bait effect ended, bite rate returned to normal.');
    }, 60000); // 30 seconds


    if (mysteryBaitCountInInventory > 0) {
        mysteryBaitCooldownEnd = now + 90000; 
        startCooldownTimer(mysteryBaitContainer, 60);
    }

    saveUnlockedStates();
    console.log('Mystery Bait consumed, remaining count:', mysteryBaitCountInInventory);
}

function startCooldownTimer(mysteryBaitContainer, remainingSeconds) {
    let lockScreen = mysteryBaitContainer.querySelector('.cooldown-lockscreen');
    if (!lockScreen) {
        lockScreen = document.createElement('div');
        lockScreen.className = 'cooldown-lockscreen';
        lockScreen.style.position = 'absolute';
        lockScreen.style.width = '48px';
        lockScreen.style.height = '48px';
        lockScreen.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        lockScreen.style.display = 'flex';
        lockScreen.style.justifyContent = 'center';
        lockScreen.style.alignItems = 'center';
        lockScreen.style.zIndex = '10';
        lockScreen.style.top = '0';
        lockScreen.style.left = '0';

        const timerText = document.createElement('span');
        timerText.style.color = 'white';
        timerText.style.fontFamily = 'Aclonica';
        timerText.style.fontSize = '16px';
        lockScreen.appendChild(timerText);
        mysteryBaitContainer.appendChild(lockScreen);
    }

    const timerText = lockScreen.querySelector('span');
    timerText.textContent = remainingSeconds;

    const countdown = setInterval(() => {
        const now = Date.now();
        const timeLeft = Math.ceil((mysteryBaitCooldownEnd - now) / 1000);
        if (timeLeft <= 0) {
            clearInterval(countdown);
            mysteryBaitContainer.removeChild(lockScreen);
            mysteryBaitCooldownEnd = 0;
            saveUnlockedStates();
            console.log('Mystery Bait cooldown ended.');
        } else {
            timerText.textContent = timeLeft;
        }
    }, 1000);
}

function buyFishTrap() {
    const insufficientFundsOverlay = document.getElementById('insufficient-funds-overlay');
    if (fishCount >= 125) {
        fishCount -= 125;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        fishTrapCountInInventory++;
        console.log(`Fish trap purchased, new count: ${fishTrapCountInInventory}`);
        updateFishTrapInInventory();
        saleSound.play().catch(e => console.error('Sale sound failed:', e));
        sendChatMessage("purchased a Fish Trap!", "botstyle");
        insufficientFundsOverlay.style.display = 'none';
    } else {
        insufficientFundsOverlay.style.display = 'flex';
    }
}

function addFishTrapToSlot(slot, count) {
    console.log(`addFishTrapToSlot called with count: ${count}, slot: row ${slot.dataset.row}, col ${slot.dataset.col}`);
    const fishTrapContainer = document.createElement('div');
    fishTrapContainer.style.position = 'relative';
    fishTrapContainer.style.width = '48px';
    fishTrapContainer.style.height = '48px';
    fishTrapContainer.draggable = true;

    const fishTrapItem = document.createElement('img');
    fishTrapItem.className = 'inventory-item';
    fishTrapItem.src = 'bptrap.gif';
    fishTrapItem.alt = 'Fish Trap';

    fishTrapContainer.addEventListener('dragstart', (e) => {
        draggedItem = fishTrapContainer;
        setTimeout(() => draggedItem.style.display = 'none', 0);
    });
    fishTrapContainer.addEventListener('dragend', (e) => {
        draggedItem.style.display = 'block';
        draggedItem = null;
        console.log('Fish trap drag ended');
    });
    fishTrapContainer.addEventListener('click', deployFishTrap);

    const stackCount = document.createElement('div');
    stackCount.className = 'stack-count';
    stackCount.textContent = count;
    stackCount.style.display = count >= 2 ? 'block' : 'none';
    console.log(`Stack count set to ${count}, display: ${stackCount.style.display}`);

    fishTrapContainer.appendChild(fishTrapItem);
    fishTrapContainer.appendChild(stackCount);
    snapToSlot(fishTrapContainer, slot);
    createTooltip(fishTrapItem, 'Fish Trap');
}


function updateFishTrapInInventory() {
    console.log(`updateFishTrapInInventory called, fishTrapCountInInventory: ${fishTrapCountInInventory}`);
    let fishTrapContainer = inventoryGrid.querySelector('.inventory-slot .inventory-item[src="bptrap.gif"]')?.parentElement;
    if (fishTrapContainer && fishTrapContainer.querySelector('.inventory-item')) {
        const stackCount = fishTrapContainer.querySelector('.stack-count');
        stackCount.textContent = fishTrapCountInInventory;
        stackCount.style.display = fishTrapCountInInventory >= 2 ? 'block' : 'none';
        console.log(`Existing fish trap updated, stack count: ${fishTrapCountInInventory}, display: ${stackCount.style.display}`);
        updateTooltip(fishTrapContainer.querySelector('.inventory-item'), 'Fish Trap');
    } else {
        const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot')).find(slot => !slot.querySelector('.inventory-item'));
        if (emptySlot) {
            addFishTrapToSlot(emptySlot, fishTrapCountInInventory);
            fishTrapSlot = {row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col)};
            console.log(`New fish trap added to slot: row ${fishTrapSlot.row}, col ${fishTrapSlot.col}`);
        } else {
            console.error("No empty slots available to add fish trap!");
            fishTrapCountInInventory--;
        }
    }
    saveUnlockedStates();
}
function buyCoinShop() {
    const insufficientFundsOverlay = document.getElementById('coin-insufficient-funds-overlay');
    if (fishCount >= 100) {
        fishCount -= 100;
        fishCountDisplay.textContent = fishCount;
        saveFishCount();
        isCoinShopPurchased = true;
        saleSound.play().catch(e => console.error('Sale sound failed:', e));
        sendChatMessage("purchased a Lucky Coin!", "botstyle");


        const emptySlot = Array.from(inventoryGrid.querySelectorAll('.inventory-slot'))
            .find(slot => !slot.querySelector('.inventory-item'));
        if (emptySlot) {
            addCoinToSlot(emptySlot);
            coinSlot = { row: parseInt(emptySlot.dataset.row), col: parseInt(emptySlot.dataset.col) };
        } else {
            console.error("No empty slots available to add Lucky Coin!");
        }


        shopOverlays.find(overlay => overlay.id === 'coin-shop').active = false;
        saveUnlockedStates();
        hideShopOverlay();
    } else {
        insufficientFundsOverlay.style.display = 'flex';
        insufficientFundsOverlay.textContent = "You need at least 100 fish to purchase it.";
    }
}

function addCoinToSlot(slot) {
    const coinItem = document.createElement('img');
    coinItem.className = 'inventory-item';
    coinItem.src = 'coinmini.gif';
    coinItem.alt = 'Lucky Coin';
    coinItem.draggable = true;


    coinItem.addEventListener('dragstart', (e) => {
        draggedItem = coinItem;
        setTimeout(() => draggedItem.style.display = 'none', 0);
    });
    coinItem.addEventListener('dragend', (e) => {
        draggedItem.style.display = 'block';
        draggedItem = null;
    });

    snapToSlot(coinItem, slot);
    createTooltip(coinItem, 'Lucky Coin');
    coinSlot = { row: parseInt(slot.dataset.row), col: parseInt(slot.dataset.col) };
    saveUnlockedStates();
}

function deployFishTrap(e) {
    if (isFishTrapDeployed) return;
    const fishTrapContainer = e.currentTarget;
    const slot = fishTrapContainer.parentElement;
    fishTrapCountInInventory--;
    if (fishTrapCountInInventory > 0) {
        const stackCount = fishTrapContainer.querySelector('.stack-count');
        stackCount.textContent = fishTrapCountInInventory;
        stackCount.style.display = fishTrapCountInInventory >= 2 ? 'block' : 'none';
        updateTooltip(fishTrapContainer.querySelector('.inventory-item'), 'Fish Trap');
    } else {
        slot.removeChild(fishTrapContainer);
        fishTrapSlot = null;
    }
    chainsSound.play().catch(e => console.error('Chains sound failed:', e));
    if (fishTrapTotalCaught === 0) {
        fishTrapBreakPoint = Math.floor(Math.random() * (600 - 300 + 1)) + 300;
    }
    fishTrapUncollectedFish = 0;
    deployFishTrapToRiver();
    saveUnlockedStates();
}


function deployFishTrapToRiver() {
    if (fishTrapOverlay) return;

    fishTrapOverlay = document.createElement('img');
    fishTrapOverlay.id = 'fish-trap-overlay';
    fishTrapOverlay.src = 'fishtrap.gif';
    fishTrapOverlay.style.position = 'absolute';
    fishTrapOverlay.style.width = '40px';
    fishTrapOverlay.style.height = '40px';
    fishTrapOverlay.style.top = '180px';
    fishTrapOverlay.style.left = '118px';
    fishTrapOverlay.style.zIndex = '3';
    riverModule.appendChild(fishTrapOverlay);

    let fishTrapLabel = document.getElementById('fish-trap-label');
    if (!fishTrapLabel) {
        fishTrapLabel = document.createElement('div');
        fishTrapLabel.id = 'fish-trap-label';
        fishTrapLabel.innerHTML = `
            <div id="fish-count">${fishTrapUncollectedFish} fish</div>
            <div id="fish-trap-progress"><div id="fish-trap-progress-bar"></div></div>
        `;
        riverModule.appendChild(fishTrapLabel);
    } else {
        fishTrapLabel.innerHTML = `
            <div id="fish-count">${fishTrapUncollectedFish} fish</div>
            <div id="fish-trap-progress"><div id="fish-trap-progress-bar"></div></div>
        `;
    }
    
    updateFishTrapProgressBar();
    isFishTrapDeployed = true;
    startFishTrapCollection();
    fishTrapOverlay.addEventListener('click', collectFishFromTrap);
    fishTrapOverlay.addEventListener('dblclick', removeFishTrap);
}
function startFishTrapCollection() {
    if (fishTrapInterval) clearInterval(fishTrapInterval);
    fishTrapInterval = setInterval(() => {
        fishTrapUncollectedFish++;
        fishTrapTotalCaught++;
        updateFishTrapTooltip();
        saveUnlockedStates();
        if (fishTrapTotalCaught >= fishTrapBreakPoint) {
            breakFishTrap();
        }
    }, 90000);
}

function updateFishTrapTooltip() {
    let fishTrapLabel = document.getElementById('fish-trap-label');
    if (fishTrapLabel) {
        const fishCountDiv = fishTrapLabel.querySelector('#fish-count');
        if (fishCountDiv) {
            fishCountDiv.textContent = `${fishTrapUncollectedFish} fish`;
        }
        updateFishTrapProgressBar();
        fishTrapLabel.style.visibility = 'hidden';
        fishTrapLabel.offsetHeight;
        fishTrapLabel.style.visibility = 'visible';
    } else {
        console.error('Fish trap label not found, recreating');
        deployFishTrapToRiver();
    }
}
function updateFishTrapProgressBar() {
    const progressBar = document.getElementById('fish-trap-progress-bar');
    const progressContainer = document.getElementById('fish-trap-progress');
    if (progressBar && progressContainer) {
        const maxDisplay = 600;
        const depletion = (fishTrapTotalCaught / maxDisplay) * 100;
        progressBar.style.width = `${Math.min(depletion, 100)}%`;
        
        if (fishTrapTotalCaught >= 300) {
            progressContainer.style.background = '#FFA500'; // Orange
        } else {
            progressContainer.style.background = '#4CAF50'; // Green
        }
    }
}


function collectFishFromTrap() {
    fishCount += fishTrapUncollectedFish;
    totalCaught += fishTrapUncollectedFish; 
    fishCountDisplay.textContent = fishCount;
    totalCaughtDisplay.textContent = totalCaught; 
    saveFishCount();
    fishTrapUncollectedFish = 0;
    updateFishTrapTooltip();
    saveUnlockedStates();
}

function removeFishTrap() {
    if (!fishTrapOverlay) return;
    
    clearInterval(fishTrapInterval);
    if (fishTrapOverlay.parentElement) {
        riverModule.removeChild(fishTrapOverlay);
    }
    const fishTrapLabel = document.getElementById('fish-trap-label');
    if (fishTrapLabel && fishTrapLabel.parentElement) {
        riverModule.removeChild(fishTrapLabel);
    }
    
    fishCount += fishTrapUncollectedFish;
    fishCountDisplay.textContent = fishCount;
    totalCaught += fishTrapUncollectedFish;
    totalCaughtDisplay.textContent = totalCaught;
    
    fishTrapOverlay = null;
    isFishTrapDeployed = false;
    fishTrapUncollectedFish = 0; 
    fishTrapCountInInventory++;
    updateFishTrapInInventory();
    chainsSound.play().catch(e => console.error('Chains sound failed:', e));
    saveFishCount();
    saveUnlockedStates();
}

function breakFishTrap() {
    if (!fishTrapOverlay) return;
    
    clearInterval(fishTrapInterval);
    chainSnapSound.play().catch(e => console.error('Chain snap sound failed:', e));
    fishCount += fishTrapUncollectedFish;
    totalCaught += fishTrapUncollectedFish;
    fishCountDisplay.textContent = fishCount;
    totalCaughtDisplay.textContent = totalCaught;
    sendChatMessage(`'s Fish Trap broke after catching ${fishTrapTotalCaught} fish total!`, "botstyle");
    
    if (fishTrapOverlay.parentElement) {
        riverModule.removeChild(fishTrapOverlay);
    }
    const fishTrapLabel = document.getElementById('fish-trap-label');
    if (fishTrapLabel && fishTrapLabel.parentElement) {
        riverModule.removeChild(fishTrapLabel);
    }
    
    fishTrapOverlay = null;
    isFishTrapDeployed = false;
    fishTrapUncollectedFish = 0;
    fishTrapTotalCaught = 0; 
    fishTrapBreakPoint = 0;  
    saveFishCount();
    saveUnlockedStates();
}
function addMysteryBaitToSlot(slot, count) {
    console.log(`addMysteryBaitToSlot called with count: ${count}, slot: row ${slot.dataset.row}, col ${slot.dataset.col}`);
    const mysteryBaitContainer = document.createElement('div');
    mysteryBaitContainer.style.position = 'relative';
    mysteryBaitContainer.style.width = '48px';
    mysteryBaitContainer.style.height = '48px';
    mysteryBaitContainer.draggable = true;

    const mysteryBaitItem = document.createElement('img');
    mysteryBaitItem.className = 'inventory-item';
    mysteryBaitItem.src = 'mbait.gif';
    mysteryBaitItem.alt = 'Mystery Bait';

    mysteryBaitContainer.addEventListener('dragstart', (e) => {
        draggedItem = mysteryBaitContainer;
        setTimeout(() => draggedItem.style.display = 'none', 0);
    });
    mysteryBaitContainer.addEventListener('dragend', (e) => {
        draggedItem.style.display = 'block';
        draggedItem = null;
        console.log('Mystery Bait drag ended');
    });
    mysteryBaitContainer.addEventListener('click', consumeMysteryBait);

    const stackCount = document.createElement('div');
    stackCount.className = 'stack-count';
    stackCount.textContent = count;
    stackCount.style.display = count >= 2 ? 'block' : 'none';

    mysteryBaitContainer.appendChild(mysteryBaitItem);
    mysteryBaitContainer.appendChild(stackCount);
    snapToSlot(mysteryBaitContainer, slot);
    createTooltip(mysteryBaitItem, 'Mystery Bait');
}
function initializeLuckyCoin() {
    const activeItemModule = document.getElementById('active-item-module');
    if (!activeItemModule) {
        console.error('Active item module not found');
        return;
    }

    if (luckyCoinOverlay) {
        luckyCoinOverlay.remove();
    }

    luckyCoinOverlay = document.createElement('img');
    luckyCoinOverlay.id = 'lucky-coin-overlay';
    luckyCoinOverlay.src = 'luckycoin.gif';
    luckyCoinOverlay.style.position = 'absolute';
    luckyCoinOverlay.style.width = '100%'; 
    luckyCoinOverlay.style.height = '100%'; 
    luckyCoinOverlay.style.top = '0';
    luckyCoinOverlay.style.left = '0';
    luckyCoinOverlay.style.zIndex = '3';
    activeItemModule.appendChild(luckyCoinOverlay);

    luckyCoinOverlay.draggable = false;
    luckyCoinOverlay.addEventListener('dragstart', (e) => e.preventDefault());

    luckyCoinOverlay.addEventListener('mousedown', startLuckyCoinInteraction);
    luckyCoinOverlay.addEventListener('mousemove', handleLuckyCoinDrag);
    luckyCoinOverlay.addEventListener('mouseup', stopLuckyCoinInteraction);
    luckyCoinOverlay.addEventListener('mouseleave', stopLuckyCoinInteraction);
}

function startLuckyCoinInteraction(event) {
    if (event.button === 0) { 
        isDraggingOverLuckyCoin = true;
        sparkleSound.play().catch(e => console.error('Sparkle sound failed:', e));
    }
}


function handleLuckyCoinDrag(event) {
    if (!isDraggingOverLuckyCoin) return;


    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    const rect = luckyCoinOverlay.getBoundingClientRect();
    sparkle.style.left = `${event.clientX - rect.left - 2.5}px`;
    sparkle.style.top = `${event.clientY - rect.top - 2.5}px`;
    luckyCoinOverlay.parentElement.appendChild(sparkle);

    setTimeout(() => {
        if (sparkle.parentElement) {
            sparkle.parentElement.removeChild(sparkle);
        }
    }, 500); 
}

function stopLuckyCoinInteraction() {
    isDraggingOverLuckyCoin = false;
}


document.addEventListener('DOMContentLoaded', () => {
    const savedState = localStorage.getItem('activeItemState');
    if (savedState === 'lucky-coin' && isCoinShopPurchased) {
        initializeLuckyCoin();
        luckyCoinOverlay.style.display = 'block';
        closeActiveItemBtn.style.display = 'block';
        isLuckyCoinActive = true;
    } else if (savedState === 'manual-page-1' && isManualCollected) {
        manualContainer.style.display = 'block';
        showManualPage(1);
        closeActiveItemBtn.style.display = 'block';
    } else if (savedState === 'manual-page-2' && isManualCollected) {
        manualContainer.style.display = 'block';
        showManualPage(2);
        closeActiveItemBtn.style.display = 'block';
    } else if (savedState === 'manual-page-3' && isManualCollected) {
        manualContainer.style.display = 'block';
        showManualPage(3);
        closeActiveItemBtn.style.display = 'block';
    } else if (savedState === 'fishcompendium' && isCompendiumCollected) {
        fishcompendiumOverlay.style.display = 'block';
        closeActiveItemBtn.style.display = 'block';
    } else if (savedState === 'magazine-page-1' && isMagazinePurchased) {
        magazineContainer.style.display = 'block';
        showMagazinePage(1);
        closeActiveItemBtn.style.display = 'block';
    } else if (savedState === 'magazine-page-2' && isMagazinePurchased) {
        magazineContainer.style.display = 'block';
        showMagazinePage(2);
        closeActiveItemBtn.style.display = 'block';
    }
    loadCompendiumState();
});


 

</script>
</body>
</html>